function listChanged(a) {
    var b = $('[data-route="' + a + '"]'), c = b.find(".playlist-trackcount"), d = b.find(".playlist-duration"), e = b.find(".playlist-plural-singular-tracks"), f = $(b).find(".song"), g = f.length, h = _.reduce(f, function(a, b) {
        return parseInt($(b).data("duration")) + a
    }, 0);
    $(c).text(g), $(d).text(helpers.parsehours(h)).attr("data-duration", h), $(e).text(1 == f.length ? "track" : "tracks")
}
function EventedArray(a) {
    this.stack = [], this.mutationHandler = a || function() {
    }, this.setHandler = function(a) {
        this.mutationHandler = a
    }, this.callHandler = function() {
        "function" == typeof this.mutationHandler && this.mutationHandler()
    }, this.push = function(a) {
        this.stack.push(a), this.callHandler()
    }, this.shift = function() {
        this.stack.shift()
    }, this.pop = function() {
        return this.stack.pop()
    }, this.getArray = function() {
        return this.stack
    }, this.unshift = function(a) {
        this.stack.unshift(a), this.callHandler()
    }, this.clear = function() {
        this.stack = [], recognition.stop()
    }
}
function HomeView() {
    this.playlists = oneTune.playlists, this.library = oneTune.songs, this.charts = oneTune.charts, this.reddit = oneTune.reddit, this.retro = oneTune.retro, this.isRetro = function() {
        return oneTune.retro()
    }.bind(this), this.isLoggedIn = oneTune.isLoggedIn, this.refreshRetro = function() {
        $.ajax({url: "/api/charts/retro/random",dataType: "json",success: function(a) {
            oneTune.retro({year: a.year,charts: a.tracks})
        }})
    }, $.ajax({url: "/api/homepage",dataType: "json",success: function(a) {
        oneTune.charts(a.charts), oneTune.reddit(a.reddit), oneTune.retro(a.retro)
    }}), this.refreshRetro()
}
function SongPage(a) {
    this.songid = a;
    var b = ko.observable();
    this.song = b, this.playlists = oneTune.playlists, this.headerimage = function() {
        return helpers.getHQAlbumImage(this.song(), 1200)
    }, this.isYouTubeClass = function() {
        return this.song() && this.song().provider && "youtube" == this.song().provider ? "youtube-page" : ""
    }.bind(this), this.isInLibrary = function() {
        return _.contains(oneTune.library(), this.songid)
    }, this.inPlaylists = function() {
        var a = [];
        return _.each(oneTune.playlists(), function(c) {
            _.contains(c.tracks, b().id) && a.push(c)
        }), a
    }, this.isInPlaylist = function(a) {
        var c = _.where(oneTune.playlists(), {url: a})[0];
        return _.contains(c.tracks, b().id)
    }, this.playlistsLabel = function() {
        var a = this.inPlaylists().length;
        return oneTune.isLoggedIn() ? 0 == a ? "Currently in no playlists" : 1 == a ? "Currently in 1 playlist" : "Currently in " + a + " playlists" : "Login to create playlists"
    }, this.toggleLibrary = function() {
        this.isInLibrary() ? library.remove(this.song()) : library.add(this.song())
    }, this.togglePlaylist = function(a) {
        this.isInPlaylist(a) ? library.removeMultiple([b().id], "playlist", a) : playlist.add(b(), a)
    }, this.isPlaylistOwner = function(a) {
        var b = _.where(oneTune.playlists(), {url: a})[0];
        return b.owner == oneTune.user()
    }, this.getSong = function() {
        DB.getTracks({ids: [a],callback: function(c) {
            var d = function(a) {
                b(a), $.publish("new-tracks-entered-dom"), $.publish("view-got-loaded")
            };
            c.length > 0 ? d(c[0]) : $.ajax({url: "/api/song/" + a,dataType: "json",success: function(a) {
                return a.success ? (d(a.song), void DB.addTrack(a.song)) : errors.draw(a.error)
            }})
        }})
    }, this.getSong()
}
function OneTune() {
    this.playlists = ko.observableArray(chinchilla.playlists), this.library = ko.observableArray(chinchilla.library), this.songs = ko.observableArray(), this.nowPlaying = ko.observable(), this.hearable = ko.observable(), this.charts = ko.observable(), this.reddit = ko.observable(), this.retro = ko.observable(), this.isLoggedIn = ko.observable(chinchilla.loggedin), this.user = ko.observable(chinchilla.user), ko.computed(function() {
        DB.getAllLibrarySongsSorted(this.library(), this.songs)
    }, this)
}
var translations = {LIBRARY: {en: "Library",pt: "Biblioteca",de: "Bibliothek"},HOME: {en: "Home",pt: "Início",de: "Start"},SHOW_VIDEO: {en: "Show video",pt: "Mostrar vídeo",de: "Video zeigen"},LOGIN_OR_REGISTER: {en: "Login or register",pt: "Login ou registro",de: "Login oder registrieren"},LOGOUT: {en: "Logout",pt: "Sair",de: "Ausloggen"},MY_MUSIC: {en: "My music",pt: "Minhas músicas",de: "Meine Musik"},PLAYLISTS: {en: "Playlists",pt: "Playlists",de: "Playlisten"},NEW_PLAYLIST: {en: "New playlist",pt: "Nova playlist",de: "Neue Playlist"},DISCOVER: {en: "Discover",pt: "Descubra",de: "Entdecken"},FOLLOWED_PLAYLISTS: {en: "Followed playlists",pt: "Playlists que sigo",de: "Gefolgte Playlists"},TOP_CHARTS: {en: "Top Charts",pt: "Mais Tocadas",de: "Charts"},GENRES: {en: "Genres",pt: "Gêneros",de: "Genres"},TIME_MACHINE: {en: "Time Machine",pt: "Máquina do Tempo",de: "Zeitmaschine"},COMMUNITIES: {en: "Communities",pt: "Comunidades",de: "Communities"},ABOUT: {en: "About",pt: "Sobre nós",de: "Über uns"},SETTINGS: {en: "Settings",pt: "Ajustes",de: "Einstellungen"},IMPORT: {en: "Import",pt: "Importar",de: "Import"},DROP_MUSIC_HERE: {en: "Drop your music here",pt: "Arraste e solte músicas aqui",de: "Ziehe deine Musik in dieses Fenster"},DROP_SPOTIFY_FILES: {en: "You can drop Spotify files here.",pt: "Arraste e solte músicas do Spotify aqui.",de: "Du kannst Spotify-Titel hier importieren."},IMPORT_OTHER_SERVICES: {en: "Import from other services will be available soon.",pt: "Importação de outros serviços estarão disponíveis em breve.",de: "Importieren durch andere Services wird bald verfügbar sein."},SONGS_ALBUMS_ARTISTS: {en: "Songs, albums, artists.",pt: "Músicas, álbuns, artistas.",de: "Songs, Alben, Künstler"},SEARCH_DISCOVER_MUSIC: {en: "Start searching and discover the world of music.",pt: "Inicie sua busca e descubra o mundo da música.",de: "Suche und entdecke die Welt der Musik."},SEARCH_PLACEHOLDER: {en: "Search for songs or artists...",pt: "Busque por músicas ou artistas...",de: "Suche nach Songs oder Künstlern..."}};
if (translations.get = function(a, b) {
        return a ? b ? translations[a] ? translations[a][b] ? translations[a][b] : translations[a].en ? translations[a].en : void console.error("No translation and no default string found.") : void console.error("Invalid translation identifier.") : void console.error("No language found.") : void console.error("No language identifier set.")
    }, "undefined" != typeof exports && (exports.translations = translations), navigator.userAgent.search("Safari") >= 0 && navigator.userAgent.search("Chrome") < 0) {
    var idbModules = {}, cleanInterface = !1;
    !function() {
        var a = {test: !0};
        if (Object.defineProperty)
            try {
                Object.defineProperty(a, "test", {enumerable: !1}), a.test && (cleanInterface = !0)
            } catch (b) {
            }
    }(), function(a) {
        function b(a, b, c, d) {
            c.target = b, "function" == typeof b[a] && b[a].apply(b, [c]), "function" == typeof d && d()
        }
        function c(b, c, d) {
            var e = new DOMException.prototype.constructor(0, c);
            throw e.name = b, e.message = c, a.DEBUG && (console.log(b, c, d, e), console.trace && console.trace()), e
        }
        var d = function() {
            this.length = 0, this._items = [], cleanInterface && Object.defineProperty(this, "_items", {enumerable: !1})
        };
        if (d.prototype = {contains: function(a) {
                return -1 !== this._items.indexOf(a)
            },item: function(a) {
                return this._items[a]
            },indexOf: function(a) {
                return this._items.indexOf(a)
            },push: function(a) {
                this._items.push(a), this.length += 1;
                for (var b = 0; b < this._items.length; b++)
                    this[b] = this._items[b]
            },splice: function() {
                this._items.splice.apply(this._items, arguments), this.length = this._items.length;
                for (var a in this)
                    a === String(parseInt(a, 10)) && delete this[a];
                for (a = 0; a < this._items.length; a++)
                    this[a] = this._items[a]
            }}, cleanInterface)
            for (var e in {indexOf: !1,push: !1,splice: !1})
                Object.defineProperty(d.prototype, e, {enumerable: !1});
        a.util = {throwDOMException: c,callback: b,quote: function(a) {
            return "'" + a + "'"
        },StringList: d}
    }(idbModules), function(idbModules) {
        var Sca = function() {
            return {decycle: function(object, callback) {
                function checkForCompletion() {
                    0 === queuedObjects.length && returnCallback(derezObj)
                }
                function readBlobAsDataURL(a, b) {
                    var c = new FileReader;
                    c.onloadend = function(c) {
                        var d = c.target.result, e = "blob";
                        a instanceof File, updateEncodedBlob(d, b, e)
                    }, c.readAsDataURL(a)
                }
                function updateEncodedBlob(dataURL, path, blobtype) {
                    var encoded = queuedObjects.indexOf(path);
                    path = path.replace("$", "derezObj"), eval(path + '.$enc="' + dataURL + '"'), eval(path + '.$type="' + blobtype + '"'), queuedObjects.splice(encoded, 1), checkForCompletion()
                }
                function derez(a, b) {
                    var c, d, e;
                    if (!("object" != typeof a || null === a || a instanceof Boolean || a instanceof Date || a instanceof Number || a instanceof RegExp || a instanceof Blob || a instanceof String)) {
                        for (c = 0; c < objects.length; c += 1)
                            if (objects[c] === a)
                                return {$ref: paths[c]};
                        if (objects.push(a), paths.push(b), "[object Array]" === Object.prototype.toString.apply(a))
                            for (e = [], c = 0; c < a.length; c += 1)
                                e[c] = derez(a[c], b + "[" + c + "]");
                        else {
                            e = {};
                            for (d in a)
                                Object.prototype.hasOwnProperty.call(a, d) && (e[d] = derez(a[d], b + "[" + JSON.stringify(d) + "]"))
                        }
                        return e
                    }
                    return a instanceof Blob ? (queuedObjects.push(b), readBlobAsDataURL(a, b)) : a instanceof Boolean ? a = {$type: "bool",$enc: a.toString()} : a instanceof Date ? a = {$type: "date",$enc: a.getTime()} : a instanceof Number ? a = {$type: "num",$enc: a.toString()} : a instanceof RegExp && (a = {$type: "regex",$enc: a.toString()}), a
                }
                var objects = [], paths = [], queuedObjects = [], returnCallback = callback, derezObj = derez(object, "$");
                checkForCompletion()
            },retrocycle: function retrocycle($) {
                function dataURLToBlob(a) {
                    var b, c, d, e = ";base64,";
                    if (-1 === a.indexOf(e))
                        return c = a.split(","), b = c[0].split(":")[1], d = c[1], new Blob([d], {type: b});
                    c = a.split(e), b = c[0].split(":")[1], d = window.atob(c[1]);
                    for (var f = d.length, g = new Uint8Array(f), h = 0; f > h; ++h)
                        g[h] = d.charCodeAt(h);
                    return new Blob([g.buffer], {type: b})
                }
                function rez(value) {
                    var i, item, name, path;
                    if (value && "object" == typeof value)
                        if ("[object Array]" === Object.prototype.toString.apply(value))
                            for (i = 0; i < value.length; i += 1)
                                item = value[i], item && "object" == typeof item && (path = item.$ref, value[i] = "string" == typeof path && px.test(path) ? eval(path) : rez(item));
                        else if (void 0 !== value.$type)
                            switch (value.$type) {
                                case "blob":
                                case "file":
                                    value = dataURLToBlob(value.$enc);
                                    break;
                                case "bool":
                                    value = Boolean("true" === value.$enc);
                                    break;
                                case "date":
                                    value = new Date(value.$enc);
                                    break;
                                case "num":
                                    value = Number(value.$enc);
                                    break;
                                case "regex":
                                    value = eval(value.$enc)
                            }
                        else
                            for (name in value)
                                "object" == typeof value[name] && (item = value[name], item && (path = item.$ref, value[name] = "string" == typeof path && px.test(path) ? eval(path) : rez(item)));
                    return value
                }
                var px = /^\$(?:\[(?:\d+|\"(?:[^\\\"\u0000-\u001f]|\\([\\\"\/bfnrt]|u[0-9a-zA-Z]{4}))*\")\])*$/;
                return rez($), $
            },encode: function(a, b) {
                function c(a) {
                    b(JSON.stringify(a))
                }
                this.decycle(a, c)
            },decode: function(a) {
                return this.retrocycle(JSON.parse(a))
            }}
        }();
        idbModules.Sca = Sca
    }(idbModules), function(a) {
        var b = ["", "number", "string", "boolean", "object", "undefined"], c = function() {
            return {encode: function(a) {
                return b.indexOf(typeof a) + "-" + JSON.stringify(a)
            },decode: function(a) {
                return "undefined" == typeof a ? void 0 : JSON.parse(a.substring(2))
            }}
        }, d = {number: c("number"),"boolean": c(),object: c(),string: {encode: function(a) {
            return b.indexOf("string") + "-" + a
        },decode: function(a) {
            return "" + a.substring(2)
        }},undefined: {encode: function() {
            return b.indexOf("undefined") + "-undefined"
        },decode: function() {
            return void 0
        }}}, e = function() {
            return {encode: function(a) {
                return d[typeof a].encode(a)
            },decode: function(a) {
                return d[b[a.substring(0, 1)]].decode(a)
            }}
        }();
        a.Key = e
    }(idbModules), function(a) {
        var b = function(a, b) {
            return {type: a,debug: b,bubbles: !1,cancelable: !1,eventPhase: 0,timeStamp: new Date}
        };
        a.Event = b
    }(idbModules), function(a) {
        var b = function() {
            this.onsuccess = this.onerror = this.result = this.error = this.source = this.transaction = null, this.readyState = "pending"
        }, c = function() {
            this.onblocked = this.onupgradeneeded = null
        };
        c.prototype = b, a.IDBRequest = b, a.IDBOpenRequest = c
    }(idbModules), function(a, b) {
        var c = function(a, b, c, d) {
            this.lower = a, this.upper = b, this.lowerOpen = c, this.upperOpen = d
        };
        c.only = function(a) {
            return new c(a, a, !1, !1)
        }, c.lowerBound = function(a, d) {
            return new c(a, b, d, b)
        }, c.upperBound = function(a) {
            return new c(b, a, b, open)
        }, c.bound = function(a, b, d, e) {
            return new c(a, b, d, e)
        }, a.IDBKeyRange = c
    }(idbModules), function(a, b) {
        function c(c, d, e, f, g, h) {
            this.__range = c, this.source = this.__idbObjectStore = e, this.__req = f, this.key = b, this.direction = d, this.__keyColumnName = g, this.__valueColumnName = h, this.__valueDecoder = "value" === h ? a.Sca : a.Key, this.source.transaction.__active || a.util.throwDOMException("TransactionInactiveError - The transaction this IDBObjectStore belongs to is not active."), this.__offset = -1, this.__lastKeyContinued = b, this["continue"]()
        }
        c.prototype.__find = function(c, d, e, f, g) {
            g = g || 1;
            var h = this, i = ["SELECT * FROM ", a.util.quote(h.__idbObjectStore.name)], j = [];
            i.push("WHERE ", h.__keyColumnName, " NOT NULL"), h.__range && (h.__range.lower || h.__range.upper) && (i.push("AND"), h.__range.lower && (i.push(h.__keyColumnName + (h.__range.lowerOpen ? " >" : " >= ") + " ?"), j.push(a.Key.encode(h.__range.lower))), h.__range.lower && h.__range.upper && i.push("AND"), h.__range.upper && (i.push(h.__keyColumnName + (h.__range.upperOpen ? " < " : " <= ") + " ?"), j.push(a.Key.encode(h.__range.upper)))), "undefined" != typeof c && (h.__lastKeyContinued = c, h.__offset = 0), h.__lastKeyContinued !== b && (i.push("AND " + h.__keyColumnName + " >= ?"), j.push(a.Key.encode(h.__lastKeyContinued))), i.push("ORDER BY ", h.__keyColumnName), i.push("LIMIT " + g + " OFFSET " + h.__offset), a.DEBUG && console.log(i.join(" "), j), h.__prefetchedData = null, d.executeSql(i.join(" "), j, function(c, d) {
                d.rows.length > 1 ? (h.__prefetchedData = d.rows, h.__prefetchedIndex = 0, a.DEBUG && console.log("Preloaded " + h.__prefetchedData.length + " records for cursor"), h.__decode(d.rows.item(0), e)) : 1 === d.rows.length ? h.__decode(d.rows.item(0), e) : (a.DEBUG && console.log("Reached end of cursors"), e(b, b))
            }, function(b, c) {
                a.DEBUG && console.log("Could not execute Cursor.continue"), f(c)
            })
        }, c.prototype.__decode = function(b, c) {
            var d = a.Key.decode(b[this.__keyColumnName]), e = this.__valueDecoder.decode(b[this.__valueColumnName]), f = a.Key.decode(b.key);
            c(d, e, f)
        }, c.prototype["continue"] = function(c) {
            var d = a.cursorPreloadPackSize || 100, e = this;
            this.__idbObjectStore.transaction.__addToTransactionQueue(function(a, f, g, h) {
                e.__offset++;
                var i = function(a, c, d) {
                    e.key = a, e.value = c, e.primaryKey = d, g("undefined" != typeof e.key ? e : b, e.__req)
                };
                return e.__prefetchedData && (e.__prefetchedIndex++, e.__prefetchedIndex < e.__prefetchedData.length) ? void e.__decode(e.__prefetchedData.item(e.__prefetchedIndex), i) : void e.__find(c, a, i, h, d)
            })
        }, c.prototype.advance = function(c) {
            0 >= c && a.util.throwDOMException("Type Error - Count is invalid - 0 or negative", c);
            var d = this;
            this.__idbObjectStore.transaction.__addToTransactionQueue(function(a, e, f, g) {
                d.__offset += c, d.__find(b, a, function(a, c) {
                    d.key = a, d.value = c, f("undefined" != typeof d.key ? d : b, d.__req)
                }, g)
            })
        }, c.prototype.update = function(c) {
            var d = this, e = this.__idbObjectStore.transaction.__createRequest(function() {
            });
            return a.Sca.encode(c, function(c) {
                d.__idbObjectStore.transaction.__pushToQueue(e, function(e, f, g, h) {
                    d.__find(b, e, function(b, f, i) {
                        var j = "UPDATE " + a.util.quote(d.__idbObjectStore.name) + " SET value = ? WHERE key = ?";
                        a.DEBUG && console.log(j, c, b, i), e.executeSql(j, [c, a.Key.encode(i)], function(a, c) {
                            1 === c.rowsAffected ? g(b) : h("No rows with key found" + b)
                        }, function(a, b) {
                            h(b)
                        })
                    }, h)
                })
            }), e
        }, c.prototype["delete"] = function() {
            var c = this;
            return this.__idbObjectStore.transaction.__addToTransactionQueue(function(d, e, f, g) {
                c.__find(b, d, function(e, h, i) {
                    var j = "DELETE FROM  " + a.util.quote(c.__idbObjectStore.name) + " WHERE key = ?";
                    a.DEBUG && console.log(j, e, i), d.executeSql(j, [a.Key.encode(i)], function(a, d) {
                        1 === d.rowsAffected ? (c.__offset--, f(b)) : g("No rows with key found" + e)
                    }, function(a, b) {
                        g(b)
                    })
                }, g)
            })
        }, a.IDBCursor = c
    }(idbModules), function(idbModules, undefined) {
        function IDBIndex(a, b) {
            this.indexName = this.name = a, this.__idbObjectStore = this.objectStore = this.source = b;
            var c = b.__storeProps && b.__storeProps.indexList;
            c && (c = JSON.parse(c)), this.keyPath = c && c[a] && c[a].keyPath || a, ["multiEntry", "unique"].forEach(function(b) {
                this[b] = !!(c && c[a] && c[a].optionalParams && c[a].optionalParams[b])
            }, this)
        }
        IDBIndex.prototype.__createIndex = function(indexName, keyPath, optionalParameters) {
            var me = this, transaction = me.__idbObjectStore.transaction;
            transaction.__addToTransactionQueue(function(tx, args, success, failure) {
                me.__idbObjectStore.__getStoreProps(tx, function() {
                    function error() {
                        idbModules.util.throwDOMException(0, "Could not create new index", arguments)
                    }
                    2 !== transaction.mode && idbModules.util.throwDOMException(0, "Invalid State error, not a version transaction", me.transaction);
                    var idxList = JSON.parse(me.__idbObjectStore.__storeProps.indexList);
                    "undefined" != typeof idxList[indexName] && idbModules.util.throwDOMException(0, "Index already exists on store", idxList);
                    var columnName = indexName;
                    idxList[indexName] = {columnName: columnName,keyPath: keyPath,optionalParams: optionalParameters}, me.__idbObjectStore.__storeProps.indexList = JSON.stringify(idxList);
                    var sql = ["ALTER TABLE", idbModules.util.quote(me.__idbObjectStore.name), "ADD", columnName, "BLOB"].join(" ");
                    idbModules.DEBUG && console.log(sql), tx.executeSql(sql, [], function(tx, data) {
                        tx.executeSql("SELECT * FROM " + idbModules.util.quote(me.__idbObjectStore.name), [], function(tx, data) {
                            !function initIndexForRow(i) {
                                if (i < data.rows.length)
                                    try {
                                        var value = idbModules.Sca.decode(data.rows.item(i).value), indexKey = eval("value['" + keyPath + "']");
                                        tx.executeSql("UPDATE " + idbModules.util.quote(me.__idbObjectStore.name) + " set " + columnName + " = ? where key = ?", [idbModules.Key.encode(indexKey), data.rows.item(i).key], function() {
                                            initIndexForRow(i + 1)
                                        }, error)
                                    } catch (e) {
                                        initIndexForRow(i + 1)
                                    }
                                else
                                    idbModules.DEBUG && console.log("Updating the indexes in table", me.__idbObjectStore.__storeProps), tx.executeSql("UPDATE __sys__ set indexList = ? where name = ?", [me.__idbObjectStore.__storeProps.indexList, me.__idbObjectStore.name], function() {
                                        me.__idbObjectStore.__setReadyState("createIndex", !0), success(me)
                                    }, error)
                            }(0)
                        }, error)
                    }, error)
                }, "createObjectStore")
            })
        }, IDBIndex.prototype.openCursor = function(a, b) {
            {
                var c = new idbModules.IDBRequest;
                new idbModules.IDBCursor(a, b, this.source, c, this.indexName, "value")
            }
            return c
        }, IDBIndex.prototype.openKeyCursor = function(a, b) {
            {
                var c = new idbModules.IDBRequest;
                new idbModules.IDBCursor(a, b, this.source, c, this.indexName, "key")
            }
            return c
        }, IDBIndex.prototype.__fetchIndexData = function(a, b) {
            var c = this;
            return c.__idbObjectStore.transaction.__addToTransactionQueue(function(d, e, f, g) {
                var h = ["SELECT * FROM ", idbModules.util.quote(c.__idbObjectStore.name), " WHERE", c.indexName, "NOT NULL"], i = [];
                "undefined" != typeof a && (h.push("AND", c.indexName, " = ?"), i.push(idbModules.Key.encode(a))), idbModules.DEBUG && console.log("Trying to fetch data for Index", h.join(" "), i), d.executeSql(h.join(" "), i, function(a, c) {
                    var d;
                    d = "count" === b ? c.rows.length : 0 === c.rows.length ? undefined : "key" === b ? idbModules.Key.decode(c.rows.item(0).key) : idbModules.Sca.decode(c.rows.item(0).value), f(d)
                }, g)
            })
        }, IDBIndex.prototype.get = function(a) {
            return this.__fetchIndexData(a, "value")
        }, IDBIndex.prototype.getKey = function(a) {
            return this.__fetchIndexData(a, "key")
        }, IDBIndex.prototype.count = function(a) {
            return this.__fetchIndexData(a, "count")
        }, idbModules.IDBIndex = IDBIndex
    }(idbModules), function(idbModules) {
        var IDBObjectStore = function(a, b, c) {
            this.name = a, this.transaction = b, this.__ready = {}, this.__setReadyState("createObjectStore", "undefined" == typeof c ? !0 : c), this.indexNames = new idbModules.util.StringList
        };
        IDBObjectStore.prototype.__setReadyState = function(a, b) {
            this.__ready[a] = b
        }, IDBObjectStore.prototype.__waitForReady = function(a, b) {
            var c = !0;
            if ("undefined" != typeof b)
                c = "undefined" == typeof this.__ready[b] ? !0 : this.__ready[b];
            else
                for (var d in this.__ready)
                    this.__ready[d] || (c = !1);
            if (c)
                a();
            else {
                idbModules.DEBUG && console.log("Waiting for to be ready", b);
                var e = this;
                window.setTimeout(function() {
                    e.__waitForReady(a, b)
                }, 100)
            }
        }, IDBObjectStore.prototype.__getStoreProps = function(a, b, c) {
            var d = this;
            this.__waitForReady(function() {
                d.__storeProps ? (idbModules.DEBUG && console.log("Store properties - cached", d.__storeProps), b(d.__storeProps)) : a.executeSql("SELECT * FROM __sys__ where name = ?", [d.name], function(a, c) {
                    1 !== c.rows.length ? b() : (d.__storeProps = {name: c.rows.item(0).name,indexList: c.rows.item(0).indexList,autoInc: c.rows.item(0).autoInc,keyPath: c.rows.item(0).keyPath}, idbModules.DEBUG && console.log("Store properties", d.__storeProps), b(d.__storeProps))
                }, function() {
                    b()
                })
            }, c)
        }, IDBObjectStore.prototype.__deriveKey = function(tx, value, key, callback) {
            function getNextAutoIncKey() {
                tx.executeSql("SELECT * FROM sqlite_sequence where name like ?", [me.name], function(a, b) {
                    callback(1 !== b.rows.length ? 0 : b.rows.item(0).seq)
                }, function(a, b) {
                    idbModules.util.throwDOMException(0, "Data Error - Could not get the auto increment value for key", b)
                })
            }
            var me = this;
            me.__getStoreProps(tx, function(props) {
                if (props || idbModules.util.throwDOMException(0, "Data Error - Could not locate defination for this table", props), props.keyPath)
                    if ("undefined" != typeof key && idbModules.util.throwDOMException(0, "Data Error - The object store uses in-line keys and the key parameter was provided", props), value)
                        try {
                            var primaryKey = eval("value['" + props.keyPath + "']");
                            primaryKey ? callback(primaryKey) : "true" === props.autoInc ? getNextAutoIncKey() : idbModules.util.throwDOMException(0, "Data Error - Could not eval key from keyPath")
                        } catch (e) {
                            idbModules.util.throwDOMException(0, "Data Error - Could not eval key from keyPath", e)
                        }
                    else
                        idbModules.util.throwDOMException(0, "Data Error - KeyPath was specified, but value was not");
                else
                    "undefined" != typeof key ? callback(key) : "false" === props.autoInc ? idbModules.util.throwDOMException(0, "Data Error - The object store uses out-of-line keys and has no key generator and the key parameter was not provided. ", props) : getNextAutoIncKey()
            })
        }, IDBObjectStore.prototype.__insertData = function(tx, encoded, value, primaryKey, success, error) {
            var paramMap = {};
            "undefined" != typeof primaryKey && (paramMap.key = idbModules.Key.encode(primaryKey));
            var indexes = JSON.parse(this.__storeProps.indexList);
            for (var key in indexes)
                try {
                    paramMap[indexes[key].columnName] = idbModules.Key.encode(eval("value['" + indexes[key].keyPath + "']"))
                } catch (e) {
                    error(e)
                }
            var sqlStart = ["INSERT INTO ", idbModules.util.quote(this.name), "("], sqlEnd = [" VALUES ("], sqlValues = [];
            for (key in paramMap)
                sqlStart.push(key + ","), sqlEnd.push("?,"), sqlValues.push(paramMap[key]);
            sqlStart.push("value )"), sqlEnd.push("?)"), sqlValues.push(encoded);
            var sql = sqlStart.join(" ") + sqlEnd.join(" ");
            idbModules.DEBUG && console.log("SQL for adding", sql, sqlValues), tx.executeSql(sql, sqlValues, function() {
                success(primaryKey)
            }, function(a, b) {
                error(b)
            })
        }, IDBObjectStore.prototype.add = function(a, b) {
            var c = this, d = c.transaction.__createRequest(function() {
            });
            return idbModules.Sca.encode(a, function(e) {
                c.transaction.__pushToQueue(d, function(d, f, g, h) {
                    c.__deriveKey(d, a, b, function(b) {
                        c.__insertData(d, e, a, b, g, h)
                    })
                })
            }), d
        }, IDBObjectStore.prototype.put = function(a, b) {
            var c = this, d = c.transaction.__createRequest(function() {
            });
            return idbModules.Sca.encode(a, function(e) {
                c.transaction.__pushToQueue(d, function(d, f, g, h) {
                    c.__deriveKey(d, a, b, function(b) {
                        var f = "DELETE FROM " + idbModules.util.quote(c.name) + " where key = ?";
                        d.executeSql(f, [idbModules.Key.encode(b)], function(d, f) {
                            idbModules.DEBUG && console.log("Did the row with the", b, "exist? ", f.rowsAffected), c.__insertData(d, e, a, b, g, h)
                        }, function(a, b) {
                            h(b)
                        })
                    })
                })
            }), d
        }, IDBObjectStore.prototype.get = function(a) {
            var b = this;
            return b.transaction.__addToTransactionQueue(function(c, d, e, f) {
                b.__waitForReady(function() {
                    var d = idbModules.Key.encode(a);
                    idbModules.DEBUG && console.log("Fetching", b.name, d), c.executeSql("SELECT * FROM " + idbModules.util.quote(b.name) + " where key = ?", [d], function(a, b) {
                        idbModules.DEBUG && console.log("Fetched data", b);
                        try {
                            if (0 === b.rows.length)
                                return e();
                            e(idbModules.Sca.decode(b.rows.item(0).value))
                        } catch (c) {
                            idbModules.DEBUG && console.log(c), e(void 0)
                        }
                    }, function(a, b) {
                        f(b)
                    })
                })
            })
        }, IDBObjectStore.prototype["delete"] = function(a) {
            var b = this;
            return b.transaction.__addToTransactionQueue(function(c, d, e, f) {
                b.__waitForReady(function() {
                    var d = idbModules.Key.encode(a);
                    idbModules.DEBUG && console.log("Fetching", b.name, d), c.executeSql("DELETE FROM " + idbModules.util.quote(b.name) + " where key = ?", [d], function(a, b) {
                        idbModules.DEBUG && console.log("Deleted from database", b.rowsAffected), e()
                    }, function(a, b) {
                        f(b)
                    })
                })
            })
        }, IDBObjectStore.prototype.clear = function() {
            var a = this;
            return a.transaction.__addToTransactionQueue(function(b, c, d, e) {
                a.__waitForReady(function() {
                    b.executeSql("DELETE FROM " + idbModules.util.quote(a.name), [], function(a, b) {
                        idbModules.DEBUG && console.log("Cleared all records from database", b.rowsAffected), d()
                    }, function(a, b) {
                        e(b)
                    })
                })
            })
        }, IDBObjectStore.prototype.count = function(a) {
            var b = this;
            return b.transaction.__addToTransactionQueue(function(c, d, e, f) {
                b.__waitForReady(function() {
                    var d = "SELECT * FROM " + idbModules.util.quote(b.name) + ("undefined" != typeof a ? " WHERE key = ?" : ""), g = [];
                    "undefined" != typeof a && g.push(idbModules.Key.encode(a)), c.executeSql(d, g, function(a, b) {
                        e(b.rows.length)
                    }, function(a, b) {
                        f(b)
                    })
                })
            })
        }, IDBObjectStore.prototype.openCursor = function(a, b) {
            {
                var c = new idbModules.IDBRequest;
                new idbModules.IDBCursor(a, b, this, c, "key", "value")
            }
            return c
        }, IDBObjectStore.prototype.index = function(a) {
            var b = new idbModules.IDBIndex(a, this);
            return b
        }, IDBObjectStore.prototype.createIndex = function(a, b, c) {
            var d = this;
            c = c || {}, d.__setReadyState("createIndex", !1);
            var e = new idbModules.IDBIndex(a, d);
            return d.__waitForReady(function() {
                e.__createIndex(a, b, c)
            }, "createObjectStore"), d.indexNames.push(a), e
        }, IDBObjectStore.prototype.deleteIndex = function(a) {
            var b = new idbModules.IDBIndex(a, this, !1);
            return b.__deleteIndex(a), b
        }, idbModules.IDBObjectStore = IDBObjectStore
    }(idbModules), function(a) {
        var b = 0, c = 1, d = 2, e = function(d, e, f) {
            if ("number" == typeof e)
                this.mode = e, 2 !== e && a.DEBUG && console.log("Mode should be a string, but was specified as ", e);
            else if ("string" == typeof e)
                switch (e) {
                    case "readwrite":
                        this.mode = c;
                        break;
                    case "readonly":
                        this.mode = b;
                        break;
                    default:
                        this.mode = b
                }
            this.storeNames = "string" == typeof d ? [d] : d;
            for (var g = 0; g < this.storeNames.length; g++)
                f.objectStoreNames.contains(this.storeNames[g]) || a.util.throwDOMException(0, "The operation failed because the requested database object could not be found. For example, an object store did not exist but was being opened.", this.storeNames[g]);
            this.__active = !0, this.__running = !1, this.__requests = [], this.__aborted = !1, this.db = f, this.error = null, this.onabort = this.onerror = this.oncomplete = null
        };
        e.prototype.__executeRequests = function() {
            if (this.__running && this.mode !== d)
                return void (a.DEBUG && console.log("Looks like the request set is already running", this.mode));
            this.__running = !0;
            var b = this;
            window.setTimeout(function() {
                2 === b.mode || b.__active || a.util.throwDOMException(0, "A request was placed against a transaction which is currently not active, or which is finished", b.__active), b.db.__db.transaction(function(c) {
                    function d(b, c) {
                        c && (g.req = c), g.req.readyState = "done", g.req.result = b, delete g.req.error;
                        var d = a.Event("success");
                        a.util.callback("onsuccess", g.req, d), h++, f()
                    }
                    function e() {
                        g.req.readyState = "done", g.req.error = "DOMError";
                        var b = a.Event("error", arguments);
                        a.util.callback("onerror", g.req, b), h++, f()
                    }
                    function f() {
                        return h >= b.__requests.length ? (b.__active = !1, void (b.__requests = [])) : (g = b.__requests[h], void g.op(c, g.args, d, e))
                    }
                    b.__tx = c;
                    var g = null, h = 0;
                    try {
                        f()
                    } catch (i) {
                        a.DEBUG && console.log("An exception occured in transaction", arguments), "function" == typeof b.onerror && b.onerror()
                    }
                }, function() {
                    a.DEBUG && console.log("An error in transaction", arguments), "function" == typeof b.onerror && b.onerror()
                }, function() {
                    a.DEBUG && console.log("Transaction completed", arguments), "function" == typeof b.oncomplete && b.oncomplete()
                })
            }, 1)
        }, e.prototype.__addToTransactionQueue = function(b, c) {
            this.__active || this.mode === d || a.util.throwDOMException(0, "A request was placed against a transaction which is currently not active, or which is finished.", this.__mode);
            var e = this.__createRequest();
            return this.__pushToQueue(e, b, c), e
        }, e.prototype.__createRequest = function() {
            var b = new a.IDBRequest;
            return b.source = this.db, b.transaction = this, b
        }, e.prototype.__pushToQueue = function(a, b, c) {
            this.__requests.push({op: b,args: c,req: a}), this.__executeRequests()
        }, e.prototype.objectStore = function(b) {
            return new a.IDBObjectStore(b, this)
        }, e.prototype.abort = function() {
            !this.__active && a.util.throwDOMException(0, "A request was placed against a transaction which is currently not active, or which is finished", this.__active)
        }, e.prototype.READ_ONLY = 0, e.prototype.READ_WRITE = 1, e.prototype.VERSION_CHANGE = 2, a.IDBTransaction = e
    }(idbModules), function(a) {
        var b = function(b, c, d, e) {
            this.__db = b, this.version = d, this.__storeProperties = e, this.objectStoreNames = new a.util.StringList;
            for (var f = 0; f < e.rows.length; f++)
                this.objectStoreNames.push(e.rows.item(f).name);
            this.name = c, this.onabort = this.onerror = this.onversionchange = null
        };
        b.prototype.createObjectStore = function(b, c) {
            var d = this;
            c = c || {}, c.keyPath = c.keyPath || null;
            var e = new a.IDBObjectStore(b, d.__versionTransaction, !1), f = d.__versionTransaction;
            return f.__addToTransactionQueue(function(f, g, h) {
                function i() {
                    a.util.throwDOMException(0, "Could not create new object store", arguments)
                }
                d.__versionTransaction || a.util.throwDOMException(0, "Invalid State error", d.transaction);
                var j = ["CREATE TABLE", a.util.quote(b), "(key BLOB", c.autoIncrement ? ", inc INTEGER PRIMARY KEY AUTOINCREMENT" : "PRIMARY KEY", ", value BLOB)"].join(" ");
                a.DEBUG && console.log(j), f.executeSql(j, [], function(a) {
                    a.executeSql("INSERT INTO __sys__ VALUES (?,?,?,?)", [b, c.keyPath, c.autoIncrement ? !0 : !1, "{}"], function() {
                        e.__setReadyState("createObjectStore", !0), h(e)
                    }, i)
                }, i)
            }), d.objectStoreNames.push(b), e
        }, b.prototype.deleteObjectStore = function(b) {
            var c = function() {
                a.util.throwDOMException(0, "Could not delete ObjectStore", arguments)
            }, d = this;
            !d.objectStoreNames.contains(b) && c("Object Store does not exist"), d.objectStoreNames.splice(d.objectStoreNames.indexOf(b), 1);
            var e = d.__versionTransaction;
            e.__addToTransactionQueue(function() {
                d.__versionTransaction || a.util.throwDOMException(0, "Invalid State error", d.transaction), d.__db.transaction(function(d) {
                    d.executeSql("SELECT * FROM __sys__ where name = ?", [b], function(d, e) {
                        e.rows.length > 0 && d.executeSql("DROP TABLE " + a.util.quote(b), [], function() {
                            d.executeSql("DELETE FROM __sys__ WHERE name = ?", [b], function() {
                            }, c)
                        }, c)
                    })
                })
            })
        }, b.prototype.close = function() {
        }, b.prototype.transaction = function(b, c) {
            var d = new a.IDBTransaction(b, c || 1, this);
            return d
        }, a.IDBDatabase = b
    }(idbModules), function(a) {
        var b = 4194304;
        if (window.openDatabase) {
            var c = window.openDatabase("__sysdb__", 1, "System Database", b);
            c.transaction(function(b) {
                b.executeSql("SELECT * FROM dbVersions", [], function() {
                }, function() {
                    c.transaction(function(b) {
                        b.executeSql("CREATE TABLE IF NOT EXISTS dbVersions (name VARCHAR(255), version INT);", [], function() {
                        }, function() {
                            a.util.throwDOMException("Could not create table __sysdb__ to save DB versions")
                        })
                    })
                })
            }, function() {
                a.DEBUG && console.log("Error in sysdb transaction - when selecting from dbVersions", arguments)
            });
            var d = {open: function(d, e) {
                function f() {
                    if (!i) {
                        var b = a.Event("error", arguments);
                        h.readyState = "done", h.error = "DOMError", a.util.callback("onerror", h, b), i = !0
                    }
                }
                function g(g) {
                    var i = window.openDatabase(d, 1, d, b);
                    h.readyState = "done", "undefined" == typeof e && (e = g || 1), (0 >= e || g > e) && a.util.throwDOMException(0, "An attempt was made to open a database using a lower version than the existing version.", e), i.transaction(function(b) {
                        b.executeSql("CREATE TABLE IF NOT EXISTS __sys__ (name VARCHAR(255), keyPath VARCHAR(255), autoInc BOOLEAN, indexList BLOB)", [], function() {
                            b.executeSql("SELECT * FROM __sys__", [], function(b, j) {
                                var k = a.Event("success");
                                h.source = h.result = new a.IDBDatabase(i, d, e, j), e > g ? c.transaction(function(b) {
                                    b.executeSql("UPDATE dbVersions set version = ? where name = ?", [e, d], function() {
                                        var b = a.Event("upgradeneeded");
                                        b.oldVersion = g, b.newVersion = e, h.transaction = h.result.__versionTransaction = new a.IDBTransaction([], 2, h.source), a.util.callback("onupgradeneeded", h, b, function() {
                                            var b = a.Event("success");
                                            a.util.callback("onsuccess", h, b)
                                        })
                                    }, f)
                                }, f) : a.util.callback("onsuccess", h, k)
                            }, f)
                        }, f)
                    }, f)
                }
                var h = new a.IDBOpenRequest, i = !1;
                return c.transaction(function(a) {
                    a.executeSql("SELECT * FROM dbVersions where name = ?", [d], function(a, b) {
                        0 === b.rows.length ? a.executeSql("INSERT INTO dbVersions VALUES (?,?)", [d, e || 1], function() {
                            g(0)
                        }, f) : g(b.rows.item(0).version)
                    }, f)
                }, f), h
            },deleteDatabase: function(d) {
                function e(b) {
                    if (!h) {
                        g.readyState = "done", g.error = "DOMError";
                        var c = a.Event("error");
                        c.message = b, c.debug = arguments, a.util.callback("onerror", g, c), h = !0
                    }
                }
                function f() {
                    c.transaction(function(b) {
                        b.executeSql("DELETE FROM dbVersions where name = ? ", [d], function() {
                            g.result = void 0;
                            var b = a.Event("success");
                            b.newVersion = null, b.oldVersion = i, a.util.callback("onsuccess", g, b)
                        }, e)
                    }, e)
                }
                var g = new a.IDBOpenRequest, h = !1, i = null;
                return c.transaction(function(c) {
                    c.executeSql("SELECT * FROM dbVersions where name = ?", [d], function(c, h) {
                        if (0 === h.rows.length) {
                            g.result = void 0;
                            var j = a.Event("success");
                            return j.newVersion = null, j.oldVersion = i, void a.util.callback("onsuccess", g, j)
                        }
                        i = h.rows.item(0).version;
                        var k = window.openDatabase(d, 1, d, b);
                        k.transaction(function(b) {
                            b.executeSql("SELECT * FROM __sys__", [], function(b, c) {
                                var d = c.rows;
                                !function g(c) {
                                    c >= d.length ? b.executeSql("DROP TABLE __sys__", [], function() {
                                        f()
                                    }, e) : b.executeSql("DROP TABLE " + a.util.quote(d.item(c).name), [], function() {
                                        g(c + 1)
                                    }, function() {
                                        g(c + 1)
                                    })
                                }(0)
                            }, function() {
                                f()
                            })
                        }, e)
                    })
                }, e), g
            },cmp: function(b, c) {
                return a.Key.encode(b) > a.Key.encode(c) ? 1 : b === c ? 0 : -1
            }};
            a.shimIndexedDB = d
        }
    }(idbModules), function(a, b) {
        "undefined" != typeof a.openDatabase && (a.shimIndexedDB = b.shimIndexedDB, a.shimIndexedDB && (a.shimIndexedDB.__useShim = function() {
            a.indexedDB = b.shimIndexedDB, a.IDBDatabase = b.IDBDatabase, a.IDBTransaction = b.IDBTransaction, a.IDBCursor = b.IDBCursor, a.IDBKeyRange = b.IDBKeyRange, a.indexedDB !== b.shimIndexedDB && Object.defineProperty && Object.defineProperty(a, "indexedDB", {value: b.shimIndexedDB})
        }, a.shimIndexedDB.__debug = function(a) {
            b.DEBUG = a
        })), "indexedDB" in a || (a.indexedDB = a.indexedDB || a.webkitIndexedDB || a.mozIndexedDB || a.oIndexedDB || a.msIndexedDB);
        var c = !1;
        if ((navigator.userAgent.match(/Android 2/) || navigator.userAgent.match(/Android 3/) || navigator.userAgent.match(/Android 4\.[0-3]/)) && (navigator.userAgent.match(/Chrome/) || (c = !0)), "undefined" != typeof a.indexedDB && !c || "undefined" == typeof a.openDatabase) {
            a.IDBDatabase = a.IDBDatabase || a.webkitIDBDatabase, a.IDBTransaction = a.IDBTransaction || a.webkitIDBTransaction, a.IDBCursor = a.IDBCursor || a.webkitIDBCursor, a.IDBKeyRange = a.IDBKeyRange || a.webkitIDBKeyRange, a.IDBTransaction || (a.IDBTransaction = {});
            try {
                a.IDBTransaction.READ_ONLY = a.IDBTransaction.READ_ONLY || "readonly", a.IDBTransaction.READ_WRITE = a.IDBTransaction.READ_WRITE || "readwrite"
            } catch (d) {
            }
        } else
            a.shimIndexedDB.__useShim()
    }(window, idbModules)
}
!function(a, b, c) {
    "function" == typeof define ? define(b) : "undefined" != typeof module && module.exports ? module.exports = b() : c[a] = b()
}("IDBStore", function() {
    var a = function(a) {
        throw a
    }, b = {storeName: "Store",storePrefix: "IDBWrapper-",dbVersion: 1,keyPath: "id",autoIncrement: !0,onStoreReady: function() {
    },onError: a,indexes: []}, c = function(a, c) {
        "undefined" == typeof c && "function" == typeof a && (c = a), "[object Object]" != Object.prototype.toString.call(a) && (a = {});
        for (var d in b)
            this[d] = "undefined" != typeof a[d] ? a[d] : b[d];
        this.dbName = this.storePrefix + this.storeName, this.dbVersion = parseInt(this.dbVersion, 10) || 1, c && (this.onStoreReady = c), d = "object" == typeof window ? window : self, this.idb = d.indexedDB || d.webkitIndexedDB || d.mozIndexedDB, this.keyRange = d.IDBKeyRange || d.webkitIDBKeyRange || d.mozIDBKeyRange, this.features = {hasAutoIncrement: !d.mozIndexedDB}, this.consts = {READ_ONLY: "readonly",READ_WRITE: "readwrite",VERSION_CHANGE: "versionchange",NEXT: "next",NEXT_NO_DUPLICATE: "nextunique",PREV: "prev",PREV_NO_DUPLICATE: "prevunique"}, this.openDB()
    };
    c.prototype = {constructor: c,version: "1.4.1",db: null,dbName: null,dbVersion: null,store: null,storeName: null,keyPath: null,autoIncrement: null,indexes: null,features: null,onStoreReady: null,onError: null,_insertIdCount: 0,openDB: function() {
        var a = this.idb.open(this.dbName, this.dbVersion), b = !1;
        a.onerror = function(a) {
            var b = !1;
            "error" in a.target ? b = "VersionError" == a.target.error.name : "errorCode" in a.target && (b = 12 == a.target.errorCode), this.onError(b ? Error("The version number provided is lower than the existing one.") : a)
        }.bind(this), a.onsuccess = function(a) {
            if (!b)
                if (this.db)
                    this.onStoreReady();
                else if (this.db = a.target.result, "string" == typeof this.db.version)
                    this.onError(Error("The IndexedDB implementation in this browser is outdated. Please upgrade your browser."));
                else if (this.db.objectStoreNames.contains(this.storeName)) {
                    this.store = this.db.transaction([this.storeName], this.consts.READ_ONLY).objectStore(this.storeName);
                    var c = Array.prototype.slice.call(this.getIndexList());
                    this.indexes.forEach(function(a) {
                        var d = a.name;
                        d ? (this.normalizeIndexData(a), this.hasIndex(d) ? (this.indexComplies(this.store.index(d), a) || (b = !0, this.onError(Error('Cannot modify index "' + d + '" for current version. Please bump version number to ' + (this.dbVersion + 1) + "."))), c.splice(c.indexOf(d), 1)) : (b = !0, this.onError(Error('Cannot create new index "' + d + '" for current version. Please bump version number to ' + (this.dbVersion + 1) + ".")))) : (b = !0, this.onError(Error("Cannot create index: No index name given.")))
                    }, this), c.length && (b = !0, this.onError(Error('Cannot delete index(es) "' + c.toString() + '" for current version. Please bump version number to ' + (this.dbVersion + 1) + "."))), b || this.onStoreReady()
                } else
                    this.onError(Error("Something is wrong with the IndexedDB implementation in this browser. Please upgrade your browser."))
        }.bind(this), a.onupgradeneeded = function(a) {
            this.db = a.target.result, this.db.objectStoreNames.contains(this.storeName) ? this.store = a.target.transaction.objectStore(this.storeName) : (a = {autoIncrement: this.autoIncrement}, null !== this.keyPath && (a.keyPath = this.keyPath), this.store = this.db.createObjectStore(this.storeName, a));
            var c = Array.prototype.slice.call(this.getIndexList());
            this.indexes.forEach(function(a) {
                var d = a.name;
                d || (b = !0, this.onError(Error("Cannot create index: No index name given."))), this.normalizeIndexData(a), this.hasIndex(d) ? (this.indexComplies(this.store.index(d), a) || (this.store.deleteIndex(d), this.store.createIndex(d, a.keyPath, {unique: a.unique,multiEntry: a.multiEntry})), c.splice(c.indexOf(d), 1)) : this.store.createIndex(d, a.keyPath, {unique: a.unique,multiEntry: a.multiEntry})
            }, this), c.length && c.forEach(function(a) {
                this.store.deleteIndex(a)
            }, this)
        }.bind(this)
    },deleteDatabase: function() {
        this.idb.deleteDatabase && this.idb.deleteDatabase(this.dbName)
    },put: function(b, c, e, f) {
        null !== this.keyPath && (f = e, e = c, c = b), f || (f = a), e || (e = d);
        var g = !1, h = null, i = this.db.transaction([this.storeName], this.consts.READ_WRITE);
        return i.oncomplete = function() {
            (g ? e : f)(h)
        }, i.onabort = f, i.onerror = f, null !== this.keyPath ? (this._addIdPropertyIfNeeded(c), b = i.objectStore(this.storeName).put(c)) : b = i.objectStore(this.storeName).put(c, b), b.onsuccess = function(a) {
            g = !0, h = a.target.result
        }, b.onerror = f, i
    },get: function(b, c, e) {
        e || (e = a), c || (c = d);
        var f = !1, g = null, h = this.db.transaction([this.storeName], this.consts.READ_ONLY);
        return h.oncomplete = function() {
            (f ? c : e)(g)
        }, h.onabort = e, h.onerror = e, b = h.objectStore(this.storeName).get(b), b.onsuccess = function(a) {
            f = !0, g = a.target.result
        }, b.onerror = e, h
    },remove: function(b, c, e) {
        e || (e = a), c || (c = d);
        var f = !1, g = null, h = this.db.transaction([this.storeName], this.consts.READ_WRITE);
        return h.oncomplete = function() {
            (f ? c : e)(g)
        }, h.onabort = e, h.onerror = e, b = h.objectStore(this.storeName)["delete"](b), b.onsuccess = function(a) {
            f = !0, g = a.target.result
        }, b.onerror = e, h
    },batch: function(b, c, e) {
        e || (e = a), c || (c = d), "[object Array]" != Object.prototype.toString.call(b) && e(Error("dataArray argument must be of type Array."));
        var f = this.db.transaction([this.storeName], this.consts.READ_WRITE);
        f.oncomplete = function() {
            (i ? c : e)(i)
        }, f.onabort = e, f.onerror = e;
        var g = b.length, h = !1, i = !1, j = function() {
            g--, 0 === g && !h && (i = h = !0)
        };
        return b.forEach(function(a) {
            var b = a.type, c = a.key, d = a.value, a = function(a) {
                f.abort(), h || (h = !0, e(a, b, c))
            };
            "remove" == b ? (d = f.objectStore(this.storeName)["delete"](c), d.onsuccess = j, d.onerror = a) : "put" == b && (null !== this.keyPath ? (this._addIdPropertyIfNeeded(d), d = f.objectStore(this.storeName).put(d)) : d = f.objectStore(this.storeName).put(d, c), d.onsuccess = j, d.onerror = a)
        }, this), f
    },putBatch: function(a, b, c) {
        return this.batch(a.map(function(a) {
            return {type: "put",value: a}
        }), b, c)
    },removeBatch: function(a, b, c) {
        return this.batch(a.map(function(a) {
            return {type: "remove",key: a}
        }), b, c)
    },getBatch: function(b, c, e, f) {
        e || (e = a), c || (c = d), f || (f = "sparse"), "[object Array]" != Object.prototype.toString.call(b) && e(Error("keyArray argument must be of type Array."));
        var g = this.db.transaction([this.storeName], this.consts.READ_ONLY);
        g.oncomplete = function() {
            (j ? c : e)(k)
        }, g.onabort = e, g.onerror = e;
        var h = [], i = b.length, j = !1, k = null, l = function(a) {
            a.target.result || "dense" == f ? h.push(a.target.result) : "sparse" == f && h.length++, i--, 0 === i && (j = !0, k = h)
        };
        return b.forEach(function(a) {
            a = g.objectStore(this.storeName).get(a), a.onsuccess = l, a.onerror = function(a) {
                k = a, e(a), g.abort()
            }
        }, this), g
    },getAll: function(b, c) {
        c || (c = a), b || (b = d);
        var e = this.db.transaction([this.storeName], this.consts.READ_ONLY), f = e.objectStore(this.storeName);
        return f.getAll ? this._getAllNative(e, f, b, c) : this._getAllCursor(e, f, b, c), e
    },_getAllNative: function(a, b, c, d) {
        var e = !1, f = null;
        a.oncomplete = function() {
            (e ? c : d)(f)
        }, a.onabort = d, a.onerror = d, a = b.getAll(), a.onsuccess = function(a) {
            e = !0, f = a.target.result
        }, a.onerror = d
    },_getAllCursor: function(a, b, c, d) {
        var e = [], f = !1, g = null;
        a.oncomplete = function() {
            (f ? c : d)(g)
        }, a.onabort = d, a.onerror = d, a = b.openCursor(), a.onsuccess = function(a) {
            (a = a.target.result) ? (e.push(a.value), a["continue"]()) : (f = !0, g = e)
        }, a.onError = d
    },clear: function(b, c) {
        c || (c = a), b || (b = d);
        var e = !1, f = null, g = this.db.transaction([this.storeName], this.consts.READ_WRITE);
        g.oncomplete = function() {
            (e ? b : c)(f)
        }, g.onabort = c, g.onerror = c;
        var h = g.objectStore(this.storeName).clear();
        return h.onsuccess = function(a) {
            e = !0, f = a.target.result
        }, h.onerror = c, g
    },_addIdPropertyIfNeeded: function(a) {
        !this.features.hasAutoIncrement && "undefined" == typeof a[this.keyPath] && (a[this.keyPath] = this._insertIdCount++ + Date.now())
    },getIndexList: function() {
        return this.store.indexNames
    },hasIndex: function(a) {
        return this.store.indexNames.contains(a)
    },normalizeIndexData: function(a) {
        a.keyPath = a.keyPath || a.name, a.unique = !!a.unique, a.multiEntry = !!a.multiEntry
    },indexComplies: function(a, b) {
        return ["keyPath", "unique", "multiEntry"].every(function(c) {
            if ("multiEntry" == c && void 0 === a[c] && !1 === b[c])
                return !0;
            if ("keyPath" == c && "[object Array]" == Object.prototype.toString.call(b[c])) {
                var c = b.keyPath, d = a.keyPath;
                if ("string" == typeof d)
                    return c.toString() == d;
                if ("function" != typeof d.contains && "function" != typeof d.indexOf || d.length !== c.length)
                    return !1;
                for (var e = 0, f = c.length; f > e; e++)
                    if (!(d.contains && d.contains(c[e]) || d.indexOf(-1 !== c[e])))
                        return !1;
                return !0
            }
            return b[c] == a[c]
        })
    },iterate: function(b, c) {
        var c = f({index: null,order: "ASC",autoContinue: !0,filterDuplicates: !1,keyRange: null,writeAccess: !1,onEnd: null,onError: a}, c || {}), d = "desc" == c.order.toLowerCase() ? "PREV" : "NEXT";
        c.filterDuplicates && (d += "_NO_DUPLICATE");
        var e = !1, g = this.db.transaction([this.storeName], this.consts[c.writeAccess ? "READ_WRITE" : "READ_ONLY"]), h = g.objectStore(this.storeName);
        return c.index && (h = h.index(c.index)), g.oncomplete = function() {
            e ? c.onEnd ? c.onEnd() : b(null) : c.onError(null)
        }, g.onabort = c.onError, g.onerror = c.onError, d = h.openCursor(c.keyRange, this.consts[d]), d.onerror = c.onError, d.onsuccess = function(a) {
            (a = a.target.result) ? (b(a.value, a, g), c.autoContinue && a["continue"]()) : e = !0
        }, g
    },query: function(a, b) {
        var c = [], b = b || {};
        return b.onEnd = function() {
            a(c)
        }, this.iterate(function(a) {
            c.push(a)
        }, b)
    },count: function(b, c) {
        var c = f({index: null,keyRange: null}, c || {}), d = c.onError || a, e = !1, g = null, h = this.db.transaction([this.storeName], this.consts.READ_ONLY);
        h.oncomplete = function() {
            (e ? b : d)(g)
        }, h.onabort = d, h.onerror = d;
        var i = h.objectStore(this.storeName);
        return c.index && (i = i.index(c.index)), i = i.count(c.keyRange), i.onsuccess = function(a) {
            e = !0, g = a.target.result
        }, i.onError = d, h
    },makeKeyRange: function(a) {
        var b = "undefined" != typeof a.lower, c = "undefined" != typeof a.upper, d = "undefined" != typeof a.only;
        switch (!0) {
            case d:
                a = this.keyRange.only(a.only);
                break;
            case b && c:
                a = this.keyRange.bound(a.lower, a.upper, a.excludeLower, a.excludeUpper);
                break;
            case b:
                a = this.keyRange.lowerBound(a.lower, a.excludeLower);
                break;
            case c:
                a = this.keyRange.upperBound(a.upper, a.excludeUpper);
                break;
            default:
                throw Error('Cannot create KeyRange. Provide one or both of "lower" or "upper" value, or an "only" value.')
        }
        return a
    }};
    var d = function() {
    }, e = {}, f = function(a, b) {
        var c, d;
        for (c in b)
            d = b[c], d !== e[c] && d !== a[c] && (a[c] = d);
        return a
    };
    return c.version = c.prototype.version, c
}, this), function() {
    var a = this, b = a._, c = {}, d = Array.prototype, e = Object.prototype, f = Function.prototype, g = d.push, h = d.slice, i = d.concat, j = (d.unshift, e.toString), k = e.hasOwnProperty, l = d.forEach, m = d.map, n = d.reduce, o = d.reduceRight, p = d.filter, q = d.every, r = d.some, s = d.indexOf, t = d.lastIndexOf, u = Array.isArray, v = Object.keys, w = f.bind, x = function(a) {
        return a instanceof x ? a : this instanceof x ? void (this._wrapped = a) : new x(a)
    };
    "undefined" != typeof exports ? ("undefined" != typeof module && module.exports && (exports = module.exports = x), exports._ = x) : a._ = x, x.VERSION = "1.4.2";
    var y = x.each = x.forEach = function(a, b, d) {
        if (null != a)
            if (l && a.forEach === l)
                a.forEach(b, d);
            else if (a.length === +a.length) {
                for (var e = 0, f = a.length; f > e; e++)
                    if (b.call(d, a[e], e, a) === c)
                        return
            } else
                for (var g in a)
                    if (x.has(a, g) && b.call(d, a[g], g, a) === c)
                        return
    };
    x.map = x.collect = function(a, b, c) {
        var d = [];
        return null == a ? d : m && a.map === m ? a.map(b, c) : (y(a, function(a, e, f) {
            d[d.length] = b.call(c, a, e, f)
        }), d)
    }, x.reduce = x.foldl = x.inject = function(a, b, c, d) {
        var e = arguments.length > 2;
        if (null == a && (a = []), n && a.reduce === n)
            return d && (b = x.bind(b, d)), e ? a.reduce(b, c) : a.reduce(b);
        if (y(a, function(a, f, g) {
                e ? c = b.call(d, c, a, f, g) : (c = a, e = !0)
            }), !e)
            throw new TypeError("Reduce of empty array with no initial value");
        return c
    }, x.reduceRight = x.foldr = function(a, b, c, d) {
        var e = arguments.length > 2;
        if (null == a && (a = []), o && a.reduceRight === o)
            return d && (b = x.bind(b, d)), arguments.length > 2 ? a.reduceRight(b, c) : a.reduceRight(b);
        var f = a.length;
        if (f !== +f) {
            var g = x.keys(a);
            f = g.length
        }
        if (y(a, function(h, i, j) {
                i = g ? g[--f] : --f, e ? c = b.call(d, c, a[i], i, j) : (c = a[i], e = !0)
            }), !e)
            throw new TypeError("Reduce of empty array with no initial value");
        return c
    }, x.find = x.detect = function(a, b, c) {
        var d;
        return z(a, function(a, e, f) {
            return b.call(c, a, e, f) ? (d = a, !0) : void 0
        }), d
    }, x.filter = x.select = function(a, b, c) {
        var d = [];
        return null == a ? d : p && a.filter === p ? a.filter(b, c) : (y(a, function(a, e, f) {
            b.call(c, a, e, f) && (d[d.length] = a)
        }), d)
    }, x.reject = function(a, b, c) {
        var d = [];
        return null == a ? d : (y(a, function(a, e, f) {
            b.call(c, a, e, f) || (d[d.length] = a)
        }), d)
    }, x.every = x.all = function(a, b, d) {
        b || (b = x.identity);
        var e = !0;
        return null == a ? e : q && a.every === q ? a.every(b, d) : (y(a, function(a, f, g) {
            return (e = e && b.call(d, a, f, g)) ? void 0 : c
        }), !!e)
    };
    var z = x.some = x.any = function(a, b, d) {
        b || (b = x.identity);
        var e = !1;
        return null == a ? e : r && a.some === r ? a.some(b, d) : (y(a, function(a, f, g) {
            return e || (e = b.call(d, a, f, g)) ? c : void 0
        }), !!e)
    };
    x.contains = x.include = function(a, b) {
        var c = !1;
        return null == a ? c : s && a.indexOf === s ? -1 != a.indexOf(b) : c = z(a, function(a) {
            return a === b
        })
    }, x.invoke = function(a, b) {
        var c = h.call(arguments, 2);
        return x.map(a, function(a) {
            return (x.isFunction(b) ? b : a[b]).apply(a, c)
        })
    }, x.pluck = function(a, b) {
        return x.map(a, function(a) {
            return a[b]
        })
    }, x.where = function(a, b) {
        return x.isEmpty(b) ? [] : x.filter(a, function(a) {
            for (var c in b)
                if (b[c] !== a[c])
                    return !1;
            return !0
        })
    }, x.max = function(a, b, c) {
        if (!b && x.isArray(a) && a[0] === +a[0] && a.length < 65535)
            return Math.max.apply(Math, a);
        if (!b && x.isEmpty(a))
            return -1 / 0;
        var d = {computed: -1 / 0};
        return y(a, function(a, e, f) {
            var g = b ? b.call(c, a, e, f) : a;
            g >= d.computed && (d = {value: a,computed: g})
        }), d.value
    }, x.min = function(a, b, c) {
        if (!b && x.isArray(a) && a[0] === +a[0] && a.length < 65535)
            return Math.min.apply(Math, a);
        if (!b && x.isEmpty(a))
            return 1 / 0;
        var d = {computed: 1 / 0};
        return y(a, function(a, e, f) {
            var g = b ? b.call(c, a, e, f) : a;
            g < d.computed && (d = {value: a,computed: g})
        }), d.value
    }, x.shuffle = function(a) {
        var b, c = 0, d = [];
        return y(a, function(a) {
            b = x.random(c++), d[c - 1] = d[b], d[b] = a
        }), d
    };
    var A = function(a) {
        return x.isFunction(a) ? a : function(b) {
            return b[a]
        }
    };
    x.sortBy = function(a, b, c) {
        var d = A(b);
        return x.pluck(x.map(a, function(a, b, e) {
            return {value: a,index: b,criteria: d.call(c, a, b, e)}
        }).sort(function(a, b) {
            var c = a.criteria, d = b.criteria;
            if (c !== d) {
                if (c > d || void 0 === c)
                    return 1;
                if (d > c || void 0 === d)
                    return -1
            }
            return a.index < b.index ? -1 : 1
        }), "value")
    };
    var B = function(a, b, c, d) {
        var e = {}, f = A(b);
        return y(a, function(b, g) {
            var h = f.call(c, b, g, a);
            d(e, h, b)
        }), e
    };
    x.groupBy = function(a, b, c) {
        return B(a, b, c, function(a, b, c) {
            (x.has(a, b) ? a[b] : a[b] = []).push(c)
        })
    }, x.countBy = function(a, b, c) {
        return B(a, b, c, function(a, b) {
            x.has(a, b) || (a[b] = 0), a[b]++
        })
    }, x.sortedIndex = function(a, b, c, d) {
        c = null == c ? x.identity : A(c);
        for (var e = c.call(d, b), f = 0, g = a.length; g > f; ) {
            var h = f + g >>> 1;
            c.call(d, a[h]) < e ? f = h + 1 : g = h
        }
        return f
    }, x.toArray = function(a) {
        return a ? a.length === +a.length ? h.call(a) : x.values(a) : []
    }, x.size = function(a) {
        return a.length === +a.length ? a.length : x.keys(a).length
    }, x.first = x.head = x.take = function(a, b, c) {
        return null == b || c ? a[0] : h.call(a, 0, b)
    }, x.initial = function(a, b, c) {
        return h.call(a, 0, a.length - (null == b || c ? 1 : b))
    }, x.last = function(a, b, c) {
        return null == b || c ? a[a.length - 1] : h.call(a, Math.max(a.length - b, 0))
    }, x.rest = x.tail = x.drop = function(a, b, c) {
        return h.call(a, null == b || c ? 1 : b)
    }, x.compact = function(a) {
        return x.filter(a, function(a) {
            return !!a
        })
    };
    var C = function(a, b, c) {
        return y(a, function(a) {
            x.isArray(a) ? b ? g.apply(c, a) : C(a, b, c) : c.push(a)
        }), c
    };
    x.flatten = function(a, b) {
        return C(a, b, [])
    }, x.without = function(a) {
        return x.difference(a, h.call(arguments, 1))
    }, x.uniq = x.unique = function(a, b, c, d) {
        var e = c ? x.map(a, c, d) : a, f = [], g = [];
        return y(e, function(c, d) {
            (b ? d && g[g.length - 1] === c : x.contains(g, c)) || (g.push(c), f.push(a[d]))
        }), f
    }, x.union = function() {
        return x.uniq(i.apply(d, arguments))
    }, x.intersection = function(a) {
        var b = h.call(arguments, 1);
        return x.filter(x.uniq(a), function(a) {
            return x.every(b, function(b) {
                return x.indexOf(b, a) >= 0
            })
        })
    }, x.difference = function(a) {
        var b = i.apply(d, h.call(arguments, 1));
        return x.filter(a, function(a) {
            return !x.contains(b, a)
        })
    }, x.zip = function() {
        for (var a = h.call(arguments), b = x.max(x.pluck(a, "length")), c = new Array(b), d = 0; b > d; d++)
            c[d] = x.pluck(a, "" + d);
        return c
    }, x.object = function(a, b) {
        for (var c = {}, d = 0, e = a.length; e > d; d++)
            b ? c[a[d]] = b[d] : c[a[d][0]] = a[d][1];
        return c
    }, x.indexOf = function(a, b, c) {
        if (null == a)
            return -1;
        var d = 0, e = a.length;
        if (c) {
            if ("number" != typeof c)
                return d = x.sortedIndex(a, b), a[d] === b ? d : -1;
            d = 0 > c ? Math.max(0, e + c) : c
        }
        if (s && a.indexOf === s)
            return a.indexOf(b, c);
        for (; e > d; d++)
            if (a[d] === b)
                return d;
        return -1
    }, x.lastIndexOf = function(a, b, c) {
        if (null == a)
            return -1;
        var d = null != c;
        if (t && a.lastIndexOf === t)
            return d ? a.lastIndexOf(b, c) : a.lastIndexOf(b);
        for (var e = d ? c : a.length; e--; )
            if (a[e] === b)
                return e;
        return -1
    }, x.range = function(a, b, c) {
        arguments.length <= 1 && (b = a || 0, a = 0), c = arguments[2] || 1;
        for (var d = Math.max(Math.ceil((b - a) / c), 0), e = 0, f = new Array(d); d > e; )
            f[e++] = a, a += c;
        return f
    };
    var D = function() {
    };
    x.bind = function(a, b) {
        var c, d;
        if (a.bind === w && w)
            return w.apply(a, h.call(arguments, 1));
        if (!x.isFunction(a))
            throw new TypeError;
        return d = h.call(arguments, 2), c = function() {
            if (!(this instanceof c))
                return a.apply(b, d.concat(h.call(arguments)));
            D.prototype = a.prototype;
            var e = new D, f = a.apply(e, d.concat(h.call(arguments)));
            return Object(f) === f ? f : e
        }
    }, x.bindAll = function(a) {
        var b = h.call(arguments, 1);
        return 0 == b.length && (b = x.functions(a)), y(b, function(b) {
            a[b] = x.bind(a[b], a)
        }), a
    }, x.memoize = function(a, b) {
        var c = {};
        return b || (b = x.identity), function() {
            var d = b.apply(this, arguments);
            return x.has(c, d) ? c[d] : c[d] = a.apply(this, arguments)
        }
    }, x.delay = function(a, b) {
        var c = h.call(arguments, 2);
        return setTimeout(function() {
            return a.apply(null, c)
        }, b)
    }, x.defer = function(a) {
        return x.delay.apply(x, [a, 1].concat(h.call(arguments, 1)))
    }, x.throttle = function(a, b) {
        var c, d, e, f, g, h, i = x.debounce(function() {
            g = f = !1
        }, b);
        return function() {
            c = this, d = arguments;
            var j = function() {
                e = null, g && (h = a.apply(c, d)), i()
            };
            return e || (e = setTimeout(j, b)), f ? g = !0 : (f = !0, h = a.apply(c, d)), i(), h
        }
    }, x.debounce = function(a, b, c) {
        var d, e;
        return function() {
            var f = this, g = arguments, h = function() {
                d = null, c || (e = a.apply(f, g))
            }, i = c && !d;
            return clearTimeout(d), d = setTimeout(h, b), i && (e = a.apply(f, g)), e
        }
    }, x.once = function(a) {
        var b, c = !1;
        return function() {
            return c ? b : (c = !0, b = a.apply(this, arguments), a = null, b)
        }
    }, x.wrap = function(a, b) {
        return function() {
            var c = [a];
            return g.apply(c, arguments), b.apply(this, c)
        }
    }, x.compose = function() {
        var a = arguments;
        return function() {
            for (var b = arguments, c = a.length - 1; c >= 0; c--)
                b = [a[c].apply(this, b)];
            return b[0]
        }
    }, x.after = function(a, b) {
        return 0 >= a ? b() : function() {
            return --a < 1 ? b.apply(this, arguments) : void 0
        }
    }, x.keys = v || function(a) {
        if (a !== Object(a))
            throw new TypeError("Invalid object");
        var b = [];
        for (var c in a)
            x.has(a, c) && (b[b.length] = c);
        return b
    }, x.values = function(a) {
        var b = [];
        for (var c in a)
            x.has(a, c) && b.push(a[c]);
        return b
    }, x.pairs = function(a) {
        var b = [];
        for (var c in a)
            x.has(a, c) && b.push([c, a[c]]);
        return b
    }, x.invert = function(a) {
        var b = {};
        for (var c in a)
            x.has(a, c) && (b[a[c]] = c);
        return b
    }, x.functions = x.methods = function(a) {
        var b = [];
        for (var c in a)
            x.isFunction(a[c]) && b.push(c);
        return b.sort()
    }, x.extend = function(a) {
        return y(h.call(arguments, 1), function(b) {
            for (var c in b)
                a[c] = b[c]
        }), a
    }, x.pick = function(a) {
        var b = {}, c = i.apply(d, h.call(arguments, 1));
        return y(c, function(c) {
            c in a && (b[c] = a[c])
        }), b
    }, x.omit = function(a) {
        var b = {}, c = i.apply(d, h.call(arguments, 1));
        for (var e in a)
            x.contains(c, e) || (b[e] = a[e]);
        return b
    }, x.defaults = function(a) {
        return y(h.call(arguments, 1), function(b) {
            for (var c in b)
                null == a[c] && (a[c] = b[c])
        }), a
    }, x.clone = function(a) {
        return x.isObject(a) ? x.isArray(a) ? a.slice() : x.extend({}, a) : a
    }, x.tap = function(a, b) {
        return b(a), a
    };
    var E = function(a, b, c, d) {
        if (a === b)
            return 0 !== a || 1 / a == 1 / b;
        if (null == a || null == b)
            return a === b;
        a instanceof x && (a = a._wrapped), b instanceof x && (b = b._wrapped);
        var e = j.call(a);
        if (e != j.call(b))
            return !1;
        switch (e) {
            case "[object String]":
                return a == String(b);
            case "[object Number]":
                return a != +a ? b != +b : 0 == a ? 1 / a == 1 / b : a == +b;
            case "[object Date]":
            case "[object Boolean]":
                return +a == +b;
            case "[object RegExp]":
                return a.source == b.source && a.global == b.global && a.multiline == b.multiline && a.ignoreCase == b.ignoreCase
        }
        if ("object" != typeof a || "object" != typeof b)
            return !1;
        for (var f = c.length; f--; )
            if (c[f] == a)
                return d[f] == b;
        c.push(a), d.push(b);
        var g = 0, h = !0;
        if ("[object Array]" == e) {
            if (g = a.length, h = g == b.length)
                for (; g-- && (h = E(a[g], b[g], c, d)); )
                    ;
        } else {
            var i = a.constructor, k = b.constructor;
            if (i !== k && !(x.isFunction(i) && i instanceof i && x.isFunction(k) && k instanceof k))
                return !1;
            for (var l in a)
                if (x.has(a, l) && (g++, !(h = x.has(b, l) && E(a[l], b[l], c, d))))
                    break;
            if (h) {
                for (l in b)
                    if (x.has(b, l) && !g--)
                        break;
                h = !g
            }
        }
        return c.pop(), d.pop(), h
    };
    x.isEqual = function(a, b) {
        return E(a, b, [], [])
    }, x.isEmpty = function(a) {
        if (null == a)
            return !0;
        if (x.isArray(a) || x.isString(a))
            return 0 === a.length;
        for (var b in a)
            if (x.has(a, b))
                return !1;
        return !0
    }, x.isElement = function(a) {
        return !(!a || 1 !== a.nodeType)
    }, x.isArray = u || function(a) {
        return "[object Array]" == j.call(a)
    }, x.isObject = function(a) {
        return a === Object(a)
    }, y(["Arguments", "Function", "String", "Number", "Date", "RegExp"], function(a) {
        x["is" + a] = function(b) {
            return j.call(b) == "[object " + a + "]"
        }
    }), x.isArguments(arguments) || (x.isArguments = function(a) {
        return !(!a || !x.has(a, "callee"))
    }), "function" != typeof /./ && (x.isFunction = function(a) {
        return "function" == typeof a
    }), x.isFinite = function(a) {
        return x.isNumber(a) && isFinite(a)
    }, x.isNaN = function(a) {
        return x.isNumber(a) && a != +a
    }, x.isBoolean = function(a) {
        return a === !0 || a === !1 || "[object Boolean]" == j.call(a)
    }, x.isNull = function(a) {
        return null === a
    }, x.isUndefined = function(a) {
        return void 0 === a
    }, x.has = function(a, b) {
        return k.call(a, b)
    }, x.noConflict = function() {
        return a._ = b, this
    }, x.identity = function(a) {
        return a
    }, x.times = function(a, b, c) {
        for (var d = 0; a > d; d++)
            b.call(c, d)
    }, x.random = function(a, b) {
        return null == b && (b = a, a = 0), a + (0 | Math.random() * (b - a + 1))
    };
    var F = {escape: {"&": "&amp;","<": "&lt;",">": "&gt;",'"': "&quot;","'": "&#x27;","/": "&#x2F;"}};
    F.unescape = x.invert(F.escape);
    var G = {escape: new RegExp("[" + x.keys(F.escape).join("") + "]", "g"),unescape: new RegExp("(" + x.keys(F.unescape).join("|") + ")", "g")};
    x.each(["escape", "unescape"], function(a) {
        x[a] = function(b) {
            return null == b ? "" : ("" + b).replace(G[a], function(b) {
                return F[a][b]
            })
        }
    }), x.result = function(a, b) {
        if (null == a)
            return null;
        var c = a[b];
        return x.isFunction(c) ? c.call(a) : c
    }, x.mixin = function(a) {
        y(x.functions(a), function(b) {
            var c = x[b] = a[b];
            x.prototype[b] = function() {
                var a = [this._wrapped];
                return g.apply(a, arguments), L.call(this, c.apply(x, a))
            }
        })
    };
    var H = 0;
    x.uniqueId = function(a) {
        var b = H++;
        return a ? a + b : b
    }, x.templateSettings = {evaluate: /<%([\s\S]+?)%>/g,interpolate: /<%=([\s\S]+?)%>/g,escape: /<%-([\s\S]+?)%>/g};
    var I = /(.)^/, J = {"'": "'","\\": "\\","\r": "r","\n": "n","	": "t","\u2028": "u2028","\u2029": "u2029"}, K = /\\|'|\r|\n|\t|\u2028|\u2029/g;
    x.template = function(a, b, c) {
        c = x.defaults({}, c, x.templateSettings);
        var d = new RegExp([(c.escape || I).source, (c.interpolate || I).source, (c.evaluate || I).source].join("|") + "|$", "g"), e = 0, f = "__p+='";
        a.replace(d, function(b, c, d, g, h) {
            f += a.slice(e, h).replace(K, function(a) {
                return "\\" + J[a]
            }), f += c ? "'+\n((__t=(" + c + "))==null?'':_.escape(__t))+\n'" : d ? "'+\n((__t=(" + d + "))==null?'':__t)+\n'" : g ? "';\n" + g + "\n__p+='" : "", e = h + b.length
        }), f += "';\n", c.variable || (f = "with(obj||{}){\n" + f + "}\n"), f = "var __t,__p='',__j=Array.prototype.join,print=function(){__p+=__j.call(arguments,'');};\n" + f + "return __p;\n";
        try {
            var g = new Function(c.variable || "obj", "_", f)
        } catch (h) {
            throw h.source = f, h
        }
        if (b)
            return g(b, x);
        var i = function(a) {
            return g.call(this, a, x)
        };
        return i.source = "function(" + (c.variable || "obj") + "){\n" + f + "}", i
    }, x.chain = function(a) {
        return x(a).chain()
    };
    var L = function(a) {
        return this._chain ? x(a).chain() : a
    };
    x.mixin(x), y(["pop", "push", "reverse", "shift", "sort", "splice", "unshift"], function(a) {
        var b = d[a];
        x.prototype[a] = function() {
            var c = this._wrapped;
            return b.apply(c, arguments), "shift" != a && "splice" != a || 0 !== c.length || delete c[0], L.call(this, c)
        }
    }), y(["concat", "join", "slice"], function(a) {
        var b = d[a];
        x.prototype[a] = function() {
            return L.call(this, b.apply(this._wrapped, arguments))
        }
    }), x.extend(x.prototype, {chain: function() {
        return this._chain = !0, this
    },value: function() {
        return this._wrapped
    }})
}.call(this), !function(a, b) {
    "use strict";
    var c = b.prototype.trim, d = b.prototype.trimRight, e = b.prototype.trimLeft, f = function(a) {
        return 1 * a || 0
    }, g = function(a, b) {
        if (1 > b)
            return "";
        for (var c = ""; b > 0; )
            1 & b && (c += a), b >>= 1, a += a;
        return c
    }, h = [].slice, i = function(a) {
        return null == a ? "\\s" : a.source ? a.source : "[" + _s.escapeRegExp(a) + "]"
    }, j = {lt: "<",gt: ">",quot: '"',amp: "&",apos: "'"}, k = {};
    for (var l in j)
        k[j[l]] = l;
    k["'"] = "#39";
    var m = function() {
        function a(a) {
            return Object.prototype.toString.call(a).slice(8, -1).toLowerCase()
        }
        var c = g, d = function() {
            return d.cache.hasOwnProperty(arguments[0]) || (d.cache[arguments[0]] = d.parse(arguments[0])), d.format.call(null, d.cache[arguments[0]], arguments)
        };
        return d.format = function(d, e) {
            var f, g, h, i, j, k, l, n = 1, o = d.length, p = "", q = [];
            for (g = 0; o > g; g++)
                if (p = a(d[g]), "string" === p)
                    q.push(d[g]);
                else if ("array" === p) {
                    if (i = d[g], i[2])
                        for (f = e[n], h = 0; h < i[2].length; h++) {
                            if (!f.hasOwnProperty(i[2][h]))
                                throw new Error(m('[_.sprintf] property "%s" does not exist', i[2][h]));
                            f = f[i[2][h]]
                        }
                    else
                        f = i[1] ? e[i[1]] : e[n++];
                    if (/[^s]/.test(i[8]) && "number" != a(f))
                        throw new Error(m("[_.sprintf] expecting number but found %s", a(f)));
                    switch (i[8]) {
                        case "b":
                            f = f.toString(2);
                            break;
                        case "c":
                            f = b.fromCharCode(f);
                            break;
                        case "d":
                            f = parseInt(f, 10);
                            break;
                        case "e":
                            f = i[7] ? f.toExponential(i[7]) : f.toExponential();
                            break;
                        case "f":
                            f = i[7] ? parseFloat(f).toFixed(i[7]) : parseFloat(f);
                            break;
                        case "o":
                            f = f.toString(8);
                            break;
                        case "s":
                            f = (f = b(f)) && i[7] ? f.substring(0, i[7]) : f;
                            break;
                        case "u":
                            f = Math.abs(f);
                            break;
                        case "x":
                            f = f.toString(16);
                            break;
                        case "X":
                            f = f.toString(16).toUpperCase()
                    }
                    f = /[def]/.test(i[8]) && i[3] && f >= 0 ? "+" + f : f, k = i[4] ? "0" == i[4] ? "0" : i[4].charAt(1) : " ", l = i[6] - b(f).length, j = i[6] ? c(k, l) : "", q.push(i[5] ? f + j : j + f)
                }
            return q.join("")
        }, d.cache = {}, d.parse = function(a) {
            for (var b = a, c = [], d = [], e = 0; b; ) {
                if (null !== (c = /^[^\x25]+/.exec(b)))
                    d.push(c[0]);
                else if (null !== (c = /^\x25{2}/.exec(b)))
                    d.push("%");
                else {
                    if (null === (c = /^\x25(?:([1-9]\d*)\$|\(([^\)]+)\))?(\+)?(0|'[^$])?(-)?(\d+)?(?:\.(\d+))?([b-fosuxX])/.exec(b)))
                        throw new Error("[_.sprintf] huh?");
                    if (c[2]) {
                        e |= 1;
                        var f = [], g = c[2], h = [];
                        if (null === (h = /^([a-z_][a-z_\d]*)/i.exec(g)))
                            throw new Error("[_.sprintf] huh?");
                        for (f.push(h[1]); "" !== (g = g.substring(h[0].length)); )
                            if (null !== (h = /^\.([a-z_][a-z_\d]*)/i.exec(g)))
                                f.push(h[1]);
                            else {
                                if (null === (h = /^\[(\d+)\]/.exec(g)))
                                    throw new Error("[_.sprintf] huh?");
                                f.push(h[1])
                            }
                        c[2] = f
                    } else
                        e |= 2;
                    if (3 === e)
                        throw new Error("[_.sprintf] mixing positional and named placeholders is not (yet) supported");
                    d.push(c)
                }
                b = b.substring(c[0].length)
            }
            return d
        }, d
    }();
    window._s = {VERSION: "2.3.0",isBlank: function(a) {
        return null == a && (a = ""), /^\s*$/.test(a)
    },stripTags: function(a) {
        return null == a ? "" : b(a).replace(/<\/?[^>]+>/g, "")
    },capitalize: function(a) {
        return a = null == a ? "" : b(a), a.charAt(0).toUpperCase() + a.slice(1)
    },chop: function(a, c) {
        return null == a ? [] : (a = b(a), c = ~~c, c > 0 ? a.match(new RegExp(".{1," + c + "}", "g")) : [a])
    },clean: function(a) {
        return _s.strip(a).replace(/\s+/g, " ")
    },count: function(a, c) {
        if (null == a || null == c)
            return 0;
        a = b(a), c = b(c);
        for (var d = 0, e = 0, f = c.length; ; ) {
            if (e = a.indexOf(c, e), -1 === e)
                break;
            d++, e += f
        }
        return d
    },chars: function(a) {
        return null == a ? [] : b(a).split("")
    },swapCase: function(a) {
        return null == a ? "" : b(a).replace(/\S/g, function(a) {
            return a === a.toUpperCase() ? a.toLowerCase() : a.toUpperCase()
        })
    },escapeHTML: function(a) {
        return null == a ? "" : b(a).replace(/[&<>"']/g, function(a) {
            return "&" + k[a] + ";"
        })
    },unescapeHTML: function(a) {
        return null == a ? "" : b(a).replace(/\&([^;]+);/g, function(a, c) {
            var d;
            return c in j ? j[c] : (d = c.match(/^#x([\da-fA-F]+)$/)) ? b.fromCharCode(parseInt(d[1], 16)) : (d = c.match(/^#(\d+)$/)) ? b.fromCharCode(~~d[1]) : a
        })
    },escapeRegExp: function(a) {
        return null == a ? "" : b(a).replace(/([.*+?^=!:${}()|[\]\/\\])/g, "\\$1")
    },splice: function(a, b, c, d) {
        var e = _s.chars(a);
        return e.splice(~~b, ~~c, d), e.join("")
    },insert: function(a, b, c) {
        return _s.splice(a, b, 0, c)
    },include: function(a, c) {
        return "" === c ? !0 : null == a ? !1 : -1 !== b(a).indexOf(c)
    },join: function() {
        var a = h.call(arguments), b = a.shift();
        return null == b && (b = ""), a.join(b)
    },lines: function(a) {
        return null == a ? [] : b(a).split("\n")
    },reverse: function(a) {
        return _s.chars(a).reverse().join("")
    },startsWith: function(a, c) {
        return "" === c ? !0 : null == a || null == c ? !1 : (a = b(a), c = b(c), a.length >= c.length && a.slice(0, c.length) === c)
    },endsWith: function(a, c) {
        return "" === c ? !0 : null == a || null == c ? !1 : (a = b(a), c = b(c), a.length >= c.length && a.slice(a.length - c.length) === c)
    },succ: function(a) {
        return null == a ? "" : (a = b(a), a.slice(0, -1) + b.fromCharCode(a.charCodeAt(a.length - 1) + 1))
    },titleize: function(a) {
        return null == a ? "" : b(a).replace(/(?:^|\s)\S/g, function(a) {
            return a.toUpperCase()
        })
    },camelize: function(a) {
        return _s.trim(a).replace(/[-_\s]+(.)?/g, function(a, b) {
            return b.toUpperCase()
        })
    },underscored: function(a) {
        return _s.trim(a).replace(/([a-z\d])([A-Z]+)/g, "$1_$2").replace(/[-\s]+/g, "_").toLowerCase()
    },dasherize: function(a) {
        return _s.trim(a).replace(/([A-Z])/g, "-$1").replace(/[-_\s]+/g, "-").toLowerCase()
    },classify: function(a) {
        return _s.titleize(b(a).replace(/_/g, " ")).replace(/\s/g, "")
    },humanize: function(a) {
        return _s.capitalize(_s.underscored(a).replace(/_id$/, "").replace(/_/g, " "))
    },trim: function(a, d) {
        return null == a ? "" : !d && c ? c.call(a) : (d = i(d), b(a).replace(new RegExp("^" + d + "+|" + d + "+$", "g"), ""))
    },ltrim: function(a, c) {
        return null == a ? "" : !c && e ? e.call(a) : (c = i(c), b(a).replace(new RegExp("^" + c + "+"), ""))
    },rtrim: function(a, c) {
        return null == a ? "" : !c && d ? d.call(a) : (c = i(c), b(a).replace(new RegExp(c + "+$"), ""))
    },truncate: function(a, c, d) {
        return null == a ? "" : (a = b(a), d = d || "...", c = ~~c, a.length > c ? a.slice(0, c) + d : a)
    },prune: function(a, c, d) {
        if (null == a)
            return "";
        if (a = b(a), c = ~~c, d = null != d ? b(d) : "...", a.length <= c)
            return a;
        var e = function(a) {
            return a.toUpperCase() !== a.toLowerCase() ? "A" : " "
        }, f = a.slice(0, c + 1).replace(/.(?=\W*\w*$)/g, e);
        return f = f.slice(f.length - 2).match(/\w\w/) ? f.replace(/\s*\S+$/, "") : _s.rtrim(f.slice(0, f.length - 1)), (f + d).length > a.length ? a : a.slice(0, f.length) + d
    },words: function(a, b) {
        return _s.isBlank(a) ? [] : _s.trim(a, b).split(b || /\s+/)
    },pad: function(a, c, d, e) {
        a = null == a ? "" : b(a), c = ~~c;
        var f = 0;
        switch (d ? d.length > 1 && (d = d.charAt(0)) : d = " ", e) {
            case "right":
                return f = c - a.length, a + g(d, f);
            case "both":
                return f = c - a.length, g(d, Math.ceil(f / 2)) + a + g(d, Math.floor(f / 2));
            default:
                return f = c - a.length, g(d, f) + a
        }
    },lpad: function(a, b, c) {
        return _s.pad(a, b, c)
    },rpad: function(a, b, c) {
        return _s.pad(a, b, c, "right")
    },lrpad: function(a, b, c) {
        return _s.pad(a, b, c, "both")
    },sprintf: m,vsprintf: function(a, b) {
        return b.unshift(a), m.apply(null, b)
    },toNumber: function(a, b) {
        return a ? (a = _s.trim(a), a.match(/^-?\d+(?:\.\d+)?$/) ? f(f(a).toFixed(~~b)) : 0 / 0) : 0
    },numberFormat: function(a, b, c, d) {
        if (isNaN(a) || null == a)
            return "";
        a = a.toFixed(~~b), d = "string" == typeof d ? d : ",";
        var e = a.split("."), f = e[0], g = e[1] ? (c || ".") + e[1] : "";
        return f.replace(/(\d)(?=(?:\d{3})+$)/g, "$1" + d) + g
    },strRight: function(a, c) {
        if (null == a)
            return "";
        a = b(a), c = null != c ? b(c) : c;
        var d = c ? a.indexOf(c) : -1;
        return ~d ? a.slice(d + c.length, a.length) : a
    },strRightBack: function(a, c) {
        if (null == a)
            return "";
        a = b(a), c = null != c ? b(c) : c;
        var d = c ? a.lastIndexOf(c) : -1;
        return ~d ? a.slice(d + c.length, a.length) : a
    },strLeft: function(a, c) {
        if (null == a)
            return "";
        a = b(a), c = null != c ? b(c) : c;
        var d = c ? a.indexOf(c) : -1;
        return ~d ? a.slice(0, d) : a
    },strLeftBack: function(a, b) {
        if (null == a)
            return "";
        a += "", b = null != b ? "" + b : b;
        var c = a.lastIndexOf(b);
        return ~c ? a.slice(0, c) : a
    },toSentence: function(a, b, c, d) {
        b = b || ", ", c = c || " and ";
        var e = a.slice(), f = e.pop();
        return a.length > 2 && d && (c = _s.rtrim(b) + c), e.length ? e.join(b) + c + f : f
    },toSentenceSerial: function() {
        var a = h.call(arguments);
        return a[3] = !0, _s.toSentence.apply(_s, a)
    },slugify: function(a) {
        if (null == a)
            return "";
        var c = "ąàáäâãåæćęèéëêìíïîłńòóöôõøùúüûñçżź", d = "aaaaaaaaceeeeeiiiilnoooooouuuunczz", e = new RegExp(i(c), "g");
        return a = b(a).toLowerCase().replace(e, function(a) {
            var b = c.indexOf(a);
            return d.charAt(b) || "-"
        }), _s.dasherize(a.replace(/[^\w\s-]/g, ""))
    },surround: function(a, b) {
        return [b, a, b].join("")
    },quote: function(a) {
        return _s.surround(a, '"')
    },exports: function() {
        var a = {};
        for (var b in this)
            this.hasOwnProperty(b) && !b.match(/^(?:include|contains|reverse)$/) && (a[b] = this[b]);
        return a
    },repeat: function(a, c, d) {
        if (null == a)
            return "";
        if (c = ~~c, null == d)
            return g(b(a), c);
        for (var e = []; c > 0; e[--c] = a)
            ;
        return e.join(d)
    },levenshtein: function(a, c) {
        if (null == a && null == c)
            return 0;
        if (null == a)
            return b(c).length;
        if (null == c)
            return b(a).length;
        a = b(a), c = b(c);
        for (var d, e, f = [], g = 0; g <= c.length; g++)
            for (var h = 0; h <= a.length; h++)
                e = g && h ? a.charAt(h - 1) === c.charAt(g - 1) ? d : Math.min(f[h], f[h - 1], d) + 1 : g + h, d = f[h], f[h] = e;
        return f.pop()
    }}, _s.strip = _s.trim, _s.lstrip = _s.ltrim, _s.rstrip = _s.rtrim, _s.center = _s.lrpad, _s.rjust = _s.lpad, _s.ljust = _s.rpad, _s.contains = _s.include, _s.q = _s.quote, "undefined" != typeof exports && ("undefined" != typeof module && module.exports && (module.exports = _s), exports._s = _s), "function" == typeof define && define.amd && define("underscore.string", [], function() {
        return _s
    }), a._ = a._ || {}, a._.string = a._.str = _s
}(this, String), function() {
    var a, b;
    jQuery.uaMatch = function(a) {
        a = a.toLowerCase();
        var b = /(chrome)[ \/]([\w.]+)/.exec(a) || /(webkit)[ \/]([\w.]+)/.exec(a) || /(opera)(?:.*version|)[ \/]([\w.]+)/.exec(a) || /(msie) ([\w.]+)/.exec(a) || a.indexOf("compatible") < 0 && /(mozilla)(?:.*? rv:([\w.]+)|)/.exec(a) || [];
        return {browser: b[1] || "",version: b[2] || "0"}
    }, a = jQuery.uaMatch(navigator.userAgent), b = {}, a.browser && (b[a.browser] = !0, b.version = a.version), b.chrome ? b.webkit = !0 : b.webkit && (b.safari = !0), $.fn.findNextAll = function(a) {
        var b = this[0], c = $(a).get();
        return this.pushStack(!b && c || $.grep(c, function(a) {
            return [4, 12, 20].indexOf(b.compareDocumentPosition(a)) > -1
        }))
    }, $.fn.findPrevAll = function(a) {
        var b = this[0], c = $(a).get();
        return this.pushStack(!b && c || $.grep(c, function(a) {
            return [2, 10, 18].indexOf(b.compareDocumentPosition(a)) > -1
        }))
    }, $.fn.findNext = function(a) {
        return this.pushStack(this.findNextAll(a).first())
    }, $.fn.findPrev = function(a) {
        return this.pushStack(this.findPrevAll(a).last())
    }, jQuery.browser = b
}(), helpers = {parseyear: function(a) {
    return a.substr(0, 4)
},localStorageSafety: function(a) {
    (null == localStorage[a] || void 0 == localStorage[a] || "undefined" == localStorage[a]) && (localStorage[a] = "[]")
},localStorageSafetyObject: function(a) {
    (null == localStorage[a] || void 0 == localStorage[a] || "undefined" == localStorage[a]) && (localStorage[a] = "{}")
},getLocalStorage: function(a) {
    return this.localStorageSafety(a), JSON.parse(localStorage[a])
},addToLocalStorage: function(a, b, c) {
    this.localStorageSafety(a);
    var d = this.getLocalStorage(a);
    return c ? d.unshift(b) : d.push(b), "history" == a && (d = _.last(d, 50)), localStorage[a] = JSON.stringify(d), this.getLocalStorage(a)
},clearLocalStorage: function(a) {
    return localStorage[a] = "[]", this.getLocalStorage(a)
},parseDOM: function(a) {
    var b = a instanceof HTMLElement ? $(a).data() : a;
    return b && (b.id = b.id + ""), b
},parsetime: function(a) {
    var b = a > 5e3 ? 1e3 : 1, c = Math.round(a / b), d = Math.floor(c / 60), e = c - 60 * d;
    return 10 > e && (e = "0" + e), d + ":" + e
},slugify: function(a) {
    if (null == a)
        return "";
    var b = "ąàáäâãåæćęèéëêìíïîłńòóöôõøśùúüûñçżź", c = "aaaaaaaaceeeeeiiiilnoooooosuuuunczz", d = new RegExp(helpers.defaultToWhiteSpace(b), "g");
    return a = String(a).toLowerCase().replace(d, function(a) {
        var d = b.indexOf(a);
        return c.charAt(d) || "-"
    }), _s.dasherize(a.replace(/[^\w\s-]/g, ""))
},defaultToWhiteSpace: function(a) {
    return null == a ? "\\s" : a.source ? a.source : "[" + helpers.escapeRegExp(a) + "]"
},escapeRegExp: function(a) {
    return null == a ? "" : String(a).replace(/([.*+?^=!:${}()|[\]\/\\])/g, "\\$1")
},parseYTId: function(a) {
    return void 0 == a ? null : a.basic.id.videoId
},createID: function(a) {
    for (var b = "", c = "ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789", d = 0; a > d; d++)
        b += c.charAt(Math.floor(Math.random() * c.length));
    return b
},getHQAlbumImage: function(a, b) {
    var c = a.image;
    return c ? -1 != c.indexOf("hqdefault") && b > 480 ? c.replace("hqdefault", "maxresdefault") : b ? c.replace("100x100-75.jpg", b + "x" + b + "-75.jpg") : c : "data:image/gif;base64,R0lGODlhAQABAIAAAP///wAAACH5BAEAAAAALAAAAAABAAEAAAICRAEAOw=="
},coverArrayToHQ: function(a, b) {
    var c = [];
    for (i = 0; i < a.length; i++)
        c.push(helpers.getHQAlbumImage({image: a[i]}, b));
    return c
},parsetext: function(a) {
    var a = a + "";
    if ("null" == a)
        return "";
    var b = -1 != a.indexOf("(") ? '<span class="lighttext">' + a.substr(a.indexOf("(")).substr(1).replace(")", "") + "</span>" : "", c = -1 != a.indexOf("(") ? a.substr(0, a.indexOf("(")) : a;
    return c + b
},parsetextstrict: function(a) {
    var a = a + "";
    return "null" == a ? "" : -1 != a.indexOf("(") ? a.substr(0, a.indexOf("(")) : a
},remap: function(a) {
    return {name: a.trackName,duration: a.trackTimeMillis,album: a.collectionName,albumid: a.collectionId,artistid: a.artistId,artist: a.artistName,image: a.artworkUrl100,id: a.trackId,explicit: "explicit" == a.trackExplicitness ? !0 : !1,genre: a.primaryGenreName,numberinalbum: a.trackNumber,cdinalbum: a.discNumber,tracks: a.trackCount,cdcount: a.discCount,preview: a.previewUrl,release: a.releaseDate}
},parseMainText: function(a) {
    return -1 != a.indexOf("(") ? a.substr(0, a.indexOf("(")) : a
},parsehours: function(a) {
    var b, c = a / 1e3;
    return b = 10 > c ? "a few seconds" : 50 > c ? 10 * Math.round(c / 10) + " seconds" : 90 > c ? "one minute" : 3600 > c ? Math.round(c / 60) + " minutes" : c >= 3600 ? Math.round(c / 360) / 10 + " hours" : "Unknown length"
},albumRelevance: function(a, b) {
    var c = b, d = [{word: "instrumental",reason: "This is is the Instrumental version of"}, {word: "acoustic",reason: "This album is an acoustic version:"}, {word: "itunes",reason: "This album is an iTunes version:"}, {word: "live",reason: "This is a live album:"}, {word: "karaoke",reason: "This is a karaoke/instrumental version: "}, {word: "remix",reason: "This album only contains Remixes of one song:"}];
    return c.each(d, function(b) {
        -1 != (a.name + "").toLowerCase().indexOf(b.word) && (a.hidden = b.reason)
    }), a.tracks > 30 && (a.hidden = "This album is very long (" + a.tracks + " tracks):"), a
},parseAlbumTitle: function(a) {
    var b = a.name + "", c = b.substr(0, -1 == b.indexOf("(") ? b.length : b.indexOf("(") - 1), d = /\(([^()]+)\)/g, e = b.match(d), f = e ? e[0].substr(1, e[0].length - 2) : null;
    return a.name = c, a.subtitle = f, a
},sortTracks: function(a, b) {
    var c = [];
    return _.each(a, function(a) {
        var d = _.find(b, function(b) {
            return b.id + "" == a + ""
        });
        d && c.push(d)
    }), c
},makeAlbum: function(a, b) {
    return a.album ? {id: a.album.collectionId,tracks: a.songs.length,artist: a.album.artistName,artistid: a.album.artistId,release: a.album.releaseDate,image: a.album.artworkUrl100,name: a.album.collectionName,hours: b.reduce(b.pluck(a.songs, "duration"), function(a, b) {
        return a + parseFloat(b)
    }, 0)} : null
},parseReleaseLeft: function(a) {
    var b = new Date(a);
    if ("Invalid Date" == b)
        return "";
    var c = b - new Date, d = c / 1e3;
    if (3600 > d)
        return "Album will be released within 1 hour";
    var e = d / 3600;
    if (24 > e)
        return "Album will be available in " + Math.floor(e) + " hours";
    var f = Math.floor(e / 24);
    return 1 == f ? "Album will be available tomorrow" : "Album will be available in " + f + " days"
},titleMatcher: function(a, b) {
    return b.chain(a.toLowerCase().split(/[.&()\[\]\-\s]/g)).compact().without("ft", "feat", "lyric", "lyrics", "official", "hd", "music", "audio", "hq", "video")._wrapped
},getAuthorFromPlaylistURL: function(a) {
    return a.match(/\/u\/([\\a-zA-Z0-9\-_\.]+)\/p\//)[1]
},parseNewYTTime: function(a) {
    var b = a.match(/\d+/g);
    return a.indexOf("M") >= 0 && -1 == a.indexOf("H") && -1 == a.indexOf("S") && (b = [0, b[0], 0]), a.indexOf("H") >= 0 && -1 == a.indexOf("M") && (b = [b[0], 0, b[1]]), a.indexOf("H") >= 0 && -1 == a.indexOf("M") && -1 == a.indexOf("S") && (b = [b[0], 0, 0]), a = 0, 3 == b.length && (a += 3600 * parseInt(b[0]), a += 60 * parseInt(b[1]), a += parseInt(b[2])), 2 == b.length && (a += 60 * parseInt(b[0]), a += parseInt(b[1])), 1 == b.length && (a += parseInt(b[0])), a
}}, this.helpers = helpers, views = {artist: {load: function(a) {
    $.ajax({url: "/api/artist/" + a,dataType: "html",success: function(b) {
        $("#view[data-route='/artist/" + a + "']").html(b), views.loadingindicator.hide(), $.publish("/artist/" + a + "/loaded"), $.publish("new-tracks-entered-dom"), $.publish("view-got-loaded")
    },error: function() {
        errors.draw(404)
    }})
}},song: {load: function(a) {
    DB.getTracks({ids: [a],callback: function(b) {
        var c = function(b) {
            $("#view[data-route='/song/" + a + "']").html(templates.buildSongPage(b)), views.loadingindicator.hide(), $.publish("new-tracks-entered-dom"), $.publish("/song/" + a + "/loaded"), $.publish("view-got-loaded")
        };
        b.length > 0 ? c(b[0]) : $.ajax({url: "/api/song/" + a,dataType: "json",success: function(a) {
            return a.success ? (c(a.song), void DB.addTrack(a.song)) : void errors.draw(a.error)
        }})
    }})
}},newsong: function(a) {
    $("#view").html(templates.buildNewSongPage()), ko.cleanNode(document.getElementById("view")), ko.applyBindings(new SongPage(a), document.getElementById("view")), views.loadingindicator.hide()
},album: {load: function(a) {
    $.ajax({url: "/api/album/" + a,dataType: "html",success: function(b) {
        var c = $("#view[data-route='/album/" + a + "']");
        c.html(b), views.loadingindicator.hide(), $.publish("/album/" + a + "/loaded"), $.publish("new-tracks-entered-dom"), $.publish("view-got-loaded")
    },error: function() {
        errors.draw(404)
    }})
}},charts: {load: function() {
    $.ajax({url: "/api/charts",dataType: "html",success: function(a) {
        var b = $("#view[data-route='/charts']");
        b.html(a), views.loadingindicator.hide(), $.publish("/charts/loaded"), $.publish("new-tracks-entered-dom"), $.publish("view-got-loaded")
    },error: function() {
        errors.draw(404)
    }})
},loadGenre: function(a) {
    $.ajax({url: "/api/" + a + "/charts",dataType: "html",success: function(b) {
        var c = $("#view[data-route='/one/" + a + "/charts']");
        c.html(b), views.loadingindicator.hide(), $.publish("/one/" + a + "/charts/loaded"), $.publish("new-tracks-entered-dom"), $.publish("view-got-loaded")
    },error: function() {
        errors.draw(404)
    }})
}},redditdetail: {load: function(a) {
    $.ajax({url: "/api/r/" + a,dataType: "html",success: function(b) {
        var c = $('#view[data-route="/r/' + a + '"]');
        c.html(b), views.loadingindicator.hide(), $.publish("/r/" + a + "/loaded"), $.publish("/new-tracks-entered-dom"), $("view-got-loaded")
    },error: function() {
        errors.draw(404)
    }})
}},retrocharts: {load: function(a) {
    $.ajax({url: "/api/charts/" + a,dataType: "html",success: function(b) {
        var c = $("#view[data-route='/time-machine/" + a + "']");
        c.html(b), views.loadingindicator.hide(), $.publish("/retro-charts/" + a + "/loaded"), $.publish("new-tracks-entered-dom"), $.publish("view-got-loaded")
    }})
}},info: {load: function() {
    $.ajax({url: "/api/info",dataType: "html",success: function(a) {
        var b = $("#view[data-route='/info']");
        b.html(a), views.loadingindicator.hide(), $.publish("view-got-loaded")
    },error: function() {
        errors.draw(404)
    }})
}},sway: {load: function() {
    $.ajax({url: "/api/sway",dataType: "html",success: function(a) {
        var b = $("#view[data-route='/sway']");
        b.html(a), views.loadingindicator.hide(), $.publish("view-got-loaded")
    },error: function() {
        errors.draw(404)
    }})
}},loadingindicator: {hide: function() {
    $("#view,#loading-indicator").removeClass("loading-indicator-visible"), $("#view").scrollTop(0)
}},library: {load: function() {
    var a = oneTune.library(), b = {user: chinchilla.loggedin}, c = function(b) {
        var c = b, e = _.difference(a, _.pluck(c, "id"));
        0 != e.length ? ($('#view[data-route="/library"]').html(""), showSpinner(), $.ajax({url: "/api/tracks/get",data: {tracks: e},dataType: "json",success: function(a) {
            var b = _.union(a.tracks, c);
            d(b), _.each(a.tracks, function(a) {
                DB.addTrack(a)
            })
        }})) : d(c)
    }, d = function(c) {
        b.tracks = helpers.sortTracks(a, c).reverse();
        var d = templates.buildLibrary(b);
        $('#view[data-route="/library"]').html(d).scrollTop(0), views.loadingindicator.hide(), $.publish("/library/loaded"), $.publish("new-tracks-entered-dom"), $.publish("view-got-loaded")
    };
    DB.getTracks({ids: a,callback: c})
}},user: {load: function(a) {
    $.ajax({url: "/api/u/" + a,dataType: "json",data: {token: chinchilla.token},success: function(b) {
        b.success && (b.username = a, userpage.buildHomePage(b))
    },error: function() {
        errors.draw(404)
    }})
}},playlistsplash: {load: function() {
    views.library.load()
}},playlist: {load: function(a) {
    var b = _.where(oneTune.playlists(), {url: a})[0], c = {user: chinchilla.loggedin,playlist: b}, d = function(c) {
        var d = c, f = _.difference(b.tracks, _.pluck(d, "id"));
        0 != f.length ? ($('#view[data-route="' + a + '"]').html(""), showSpinner(), $.ajax({url: "/api/tracks/get",data: {tracks: f},dataType: "json",success: function(a) {
            var b = _.union(a.tracks, d), c = _.map(b, function(a) {
                return a.inlib = _.contains(oneTune.library(), a.id + ""), a
            });
            e(c), _.each(a.tracks, function(a) {
                DB.addTrack(a)
            })
        }})) : e(d)
    }, e = function(d) {
        c.tracks = helpers.sortTracks(b.tracks, d), c.playlist.followercount || (c.playlist.followercount = 0), b.newestattop && (c.tracks = c.tracks.reverse());
        var e = templates.buildPlaylist(c);
        $('#view[data-route="' + a + '"]').html(e).scrollTop(0), c.playlist.style || colors.getMostCommon(b.url), views.loadingindicator.hide(), $.publish(a + "/loaded"), $.publish("new-tracks-entered-dom"), $.publish("view-got-loaded")
    };
    b ? DB.getTracks({ids: b.tracks,callback: d}) : ($('#view[data-route="' + a + '"]').html(""), showSpinner(), $.ajax({url: "/api/playlists/get-tracks",dataType: "json",data: {playlist: a,token: chinchilla.token},success: function(a) {
        a.success ? (b = a.playlist, c.playlist = a.playlist, oneTune.playlists.push(b), DB.getTracks({ids: a.playlist.tracks,callback: d})) : $.ajax({url: "/api/error/502",dataType: "html",success: function(a) {
            var b = $("#view");
            b.html(a), views.loadingindicator.hide(), $.publish("view-got-loaded")
        }})
    }}))
}},lyrics: {load: function(a) {
    $.ajax({url: "/api/lyrics/" + a,dataType: "html",success: function(b) {
        var c = $('#view[data-route="/lyrics/' + a + '"]');
        c.html(b), views.loadingindicator.hide(), $.publish("view-got-loaded")
    }})
}},redditpl: {load: function(a) {
    $.ajax({url: "/api/thread/" + a,dataType: "html",success: function(b) {
        var c = $('#view[data-route="/thread/' + a + '"]');
        c.html(b), views.loadingindicator.hide(), $.publish("/thread/" + a + "/loaded"), $.publish("view-got-loaded"), $.publish("new-tracks-entered-dom")
    }})
}},services: {load: function() {
    $.ajax({url: "/api/services/",dataType: "html",success: function(a) {
        var b = $('#view[data-route="/services"]');
        b.html(a), views.loadingindicator.hide(), $.publish("/services"), $.publish("view-got-loaded")
    }})
}},reddit: {load: function() {
    $.ajax({url: "/api/genres",dataType: "html",success: function(a) {
        var b = $("#view[data-route='/genres']");
        b.html(a), views.loadingindicator.hide(), $.publish("/genres/loaded"), $.publish("new-tracks-entered-dom"), $.publish("view-got-loaded")
    },error: function() {
        errors.draw(404)
    }})
}},settings: {get: function() {
    $.ajax({url: "/api/settings",dataType: "html",success: function(a) {
        $("#view[data-route='/settings']").html(a), views.loadingindicator.hide(), $.publish("view-got-loaded")
    },error: function() {
        errors.draw(404)
    }})
}},main: {get: function() {
    $("#view").html(templates.buildHome()), ko.cleanNode(document.getElementById("view")), ko.applyBindings(new HomeView, document.getElementById("view")), views.loadingindicator.hide(), $.publish("new-tracks-entered-dom"), $.publish("view-got-loaded")
}},home: {get: function() {
    var a = {}, b = function() {
        chinchilla.loggedin ? DB.getTracks({ids: oneTune.library(),callback: function(b) {
            a.library = helpers.sortTracks(oneTune.library(), b).reverse(), c()
        }}) : c()
    }, c = function() {
        homepage.build(a)
    };
    $.ajax({url: "/api/homepage",data: {token: chinchilla.token,date: Date.now()},dataType: "json",success: function(c) {
        a = c, b()
    }})
}},remote: {get: function() {
    $.ajax({url: "/api/remote",dataType: "html",success: function(a) {
        $('#view[data-route="/remote"]').html(a), views.loadingindicator.hide(), $.publish("view-got-loaded")
    },error: function() {
        errors.draw(404)
    }})
}},report: {load: function(a) {
    $.ajax({url: "/api/report/" + a,dataType: "html",success: function(b) {
        $('#view[data-route="/report/' + a + '"]').html(b), views.loadingindicator.hide(), $.publish("view-got-loaded")
    },error: function() {
        errors.draw(404)
    }})
}},select_username: {load: function(a) {
    $.ajax({url: "/api/select_username/" + a,dataType: "html",success: function(b) {
        $('#view[data-route="/select_username/' + a + '"]').html(b), views.loadingindicator.hide(), $("#view-got-loaded")
    },error: function() {
        errors.draw(404)
    }})
}},subs: {load: function() {
    $.ajax({url: "/api/one",dataType: "html",success: function(a) {
        $("#view[data-route='/one']").html(a), views.loadingindicator.hide(), $.publish("view-got-loaded")
    },error: function() {
        errors.draw(404)
    }})
}},one: {load: function(a) {
    $.ajax({url: "/api/one/" + a,dataType: "json",data: {token: chinchilla.token,time: Date.now()},success: function(a) {
        a.success && (one.buildHomePage(a), $.publish("new-tracks-entered-dom"))
    },error: function() {
        errors.draw(404)
    }})
}},register: {load: function() {
    $.ajax({url: "/api/register/",dataType: "html",success: function(a) {
        $('#view[data-route="/register"]').html(a), views.loadingindicator.hide(), $.publish("view-got-loaded")
    },error: function() {
        errors.draw(404)
    }})
}},submit: {load: function(a, b, c) {
    $.ajax({url: "/api/submit",dataType: "html",data: {sub: a,entity: b,id: c},success: function(a) {
        $("#view").html(a), views.loadingindicator.hide(), $.publish("view-got-loaded")
    },error: function() {
        errors.draw(404)
    }})
}},posts: {load: function(a, b) {
    $.ajax({url: "/api/community/post" + window.location.search,data: {sub: a,post: b},dataType: "html",success: function(a) {
        $("#view").html(a), views.loadingindicator.hide(), $.publish("view-got-loaded"), $.publish("new-tracks-entered-dom")
    }})
},loadList: function(a, b) {
    $.ajax({url: "/api/" + (a ? a + "/" : "") + b + window.location.search,dataType: "html",success: function(a) {
        $("#view").html(a), views.loadingindicator.hide(), $.publish("view-got-loaded")
    }})
}},privacy: {load: function() {
    $.ajax({url: "/api/privacy",dataType: "html",success: function(a) {
        $('#view[data-route="/privacy"]').html(a), views.loadingindicator.hide(), $.publish("view-got-loaded")
    },error: function() {
        errors.draw(404)
    }})
}},freebase: {load: function(a, b) {
    $.ajax({url: "https://www.googleapis.com/freebase/v1/reconcile?name=" + helpers.parseMainText(a.replace(/&#39;/g, "'")) + "&indent=true&kind=/music/recording&prop=/music/recording/artist:" + helpers.parseMainText(b.replace(/&#39;/g, "'")) + "&key=AIzaSyDYwd_Qaxn79RMKUtFuf7t9u8E4GHKCfm8",dataType: "json",success: function(a) {
        if (console.log(a), a.candidate && 0 != a.candidate.length) {
            var b = a.candidate[0];
            b.confidence > .5 ? views.freebase.loadRecording(b) : views.freebaseerror.make()
        } else
            views.freebaseerror.make()
    },error: function() {
        views.freebaseerror.make()
    }})
},loadRecording: function(a) {
    $.ajax({url: "https://www.googleapis.com/freebase/v1/topic" + a.mid,dataType: "json",success: function(a) {
        return a && a.property["/music/recording/song"] ? void views.freebase.loadSong(a.property["/music/recording/song"].values[0]) : void views.freebaseerror.make()
    },error: function() {
        views.freebaseerror.make()
    }})
},loadSong: function(a) {
    $.ajax({url: "https://www.googleapis.com/freebase/v1/topic" + a.id,dataType: "json",success: function(a) {
        var b = $(".song-page-wikipedia").empty(), c = a.property;
        if (b.append("<h2>About this song</h2>"), c["/common/topic/description"] && 0 != c["/common/topic/description"].values.length) {
            var d = c["/common/topic/description"].values[0].citation;
            b.append(templates.buildFreebase("wikipedia-description wiki-collapsed", "Description", c["/common/topic/description"].values[0].value, d ? d.provider : null, d ? d.uri : null))
        }
        c["/music/composition/composer"] && 0 != c["/music/composition/composer"].values.length && b.append(templates.buildFreebase("freebase-composer", "Composers", _.pluck(c["/music/composition/composer"].values, "text").join(", "))), c["/award/award_winning_work/awards_won"] && 0 != c["/award/award_winning_work/awards_won"].values.length && b.append(templates.buildFreebase("freebase-awards", "Awards won", _.map(c["/award/award_winning_work/awards_won"].values, function(a) {
            return a.property["/award/award_honor/award"].values[0].text + " " + a.property["/award/award_honor/year"].values[0].text
        }).join("<br>"))), c["/award/award_nominated_work/award_nominations"] && 0 != c["/award/award_nominated_work/award_nominations"].values.length && b.append(templates.buildFreebase("freebase-nominations", "Award nominations", _.map(c["/award/award_nominated_work/award_nominations"].values, function(a) {
            return a.property["/award/award_nomination/award"].values[0].text + " " + a.property["/award/award_nomination/year"].values[0].text
        }).join("<br>")))
    },error: function() {
        views.freebaseerror.make()
    }})
}},freebaseerror: {make: function() {
    $(".song-page-wikipedia").remove()
}}}, routes = {"/charts": function() {
    views.charts.load()
},"/album/:id": function(a) {
    views.album.load(a[1])
},"/about": function() {
    views.about.load()
},"/track/:id": function(a) {
    views.track.load(a[1])
},"/register": function() {
    registration.facebook.load()
},"/library": function() {
    views.library.load()
},"/new-playlist": function() {
    views.playlistsplash.load()
},"/settings": function() {
    views.settings.get()
},"/home": function() {
    views.main.get()
},"/artist/:id": function(a) {
    views.artist.load(a[1])
},"/lyrics/:name": function(a) {
    views.lyrics.load(a[1])
},"/u/:name/p/:name": function(a) {
    views.playlist.load(a[0]), $("#drop-target-label").text("this playlist")
},"/thread/:name": function(a) {
    views.redditpl.load(a[1])
},"/genres": function() {
    views.reddit.load()
},"/": function() {
    views.main.get()
},"/song/:name": function(a) {
    views.song.load(a[1])
},"/time-machine/:id": function(a) {
    views.retrocharts.load(a[1])
},"/logout": function() {
    window.location = "/logout"
},"/login": function() {
    window.location = "/auth/facebook"
},"/info": function() {
    views.info.load()
},"/remote": function() {
    views.remote.get()
},"/youtube": function() {
    showYouTubePage(), views.loadingindicator.hide()
},"/import": function() {
    showImportPage(), views.loadingindicator.hide()
},"/radio": function() {
    radio.showRadioPage(), views.loadingindicator.hide()
},"/report/:id": function(a) {
    player.pause(), views.report.load(a[1])
},"/select_username/:name": function(a) {
    views.select_username.load(a[1])
},"/register": function() {
    views.register.load()
},"/r/:name": function(a) {
    views.redditdetail.load(a[1])
},"/one": function() {
    views.subs.load()
},"/submit": function() {
    views.submit.load()
},"/one/submit": function() {
    views.submit.load()
},"/one/:name": function(a) {
    views.one.load(a[1])
},"/one/submit/:name/:name": function(a) {
    views.submit.load(null, a[1], a[2])
},"/one/:name/submit": function(a) {
    views.submit.load(a[1])
},"/one/:name/submit/:name/:name": function(a) {
    views.submit.load(a[1], a[2], a[3])
},"/u/:name": function(a) {
    views.user.load(a[1])
},"/one/:name/:name/:name": function(a) {
    views.posts.load(a[1], a[2])
},"/one/:name/songs": function(a) {
    views.posts.loadList(a[1], "songs")
},"/one/:name/playlists": function(a) {
    views.posts.loadList(a[1], "playlists")
},"/one/:name/stories": function(a) {
    views.posts.loadList(a[1], "stories")
},"/songs": function() {
    views.posts.loadList(null, "songs")
},"/playlists": function() {
    views.posts.loadList(null, "playlists")
},"/stories": function() {
    views.posts.loadList(null, "stories")
},"/one/:name/charts": function(a) {
    views.charts.loadGenre(a[1])
},"/privacy": function() {
    views.privacy.load()
},"/sway": function() {
    views.sway.load()
},"/services": function() {
    views.services.load()
}};
var navfunction = function(a) {
    if (2 != a.button) {
        var b = $(this).attr("data-navigate");
        a.preventDefault(), navigation.to(b)
    }
};
$(document).on("ready", function() {
    var a = window.location.pathname + window.location.search;
    navigation.to(a)
}).on("mousedown", "[data-navigate]:not(.navigateup)", navfunction).on("click", "[data-navigate].navigateup", navfunction);
var showSpinner = function() {
    $("#view,#loading-indicator").addClass("loading-indicator-visible")
};
loader = {spinner: function() {
    return '<div class="loading-indicator"><div class="spinner"></div></div>'
}}, navigation = {to: function(a, b) {
    var c = "menuselected", d = {path: a,timestamp: Date.now()}, e = d.timestamp - window.currentroute.timestamp, f = d.path == window.currentroute.path;
    return f && "/youtube" == d.path ? void window.history.back() : void ((e > 3e3 || !f) && (window.currentroute = d, $.each(routes, function(d, e) {
        var f = a.substr(0, -1 == a.indexOf("?") ? a.length : a.indexOf("?")), g = new RegExp("^" + d.replace(/:[name]+/g, "([\\a-zA-Z0-9-_.]+)").replace(/:[id]+/g, "([\\d]+)") + "$"), h = f.match(g);
        if (h && "/" != h || "/" == h && "/" == a) {
            $("." + c).removeClass(c), $("#sidebar, #right-sidebar").find('[data-navigate="' + a + '"]').addClass(c), $("#drop-target-label").text("your library"), hideYouTubePage(), showSpinner();
            var i = b ? "replaceState" : "pushState";
            return "/" == h && "/" == a && console.log("/", window.currentroute), history[i](null, null, a), e(h), $.publish("view-gets-loaded"), $("#view").attr("data-route", a), !1
        }
    })))
}}, window.onpopstate = function() {
    var a = window.location.pathname;
    window.currentroute.path != a && navigation.to(a + window.location.search, !0)
}, window.currentroute = {path: "",timestamp: Date.now()}, notifications = {create: function(a) {
    $("#statusbar").html(a + ' <span class="close-notification">Dismiss</span>').css("display", "inline-block"), clearTimeout(notifications.timeout), notifications.timeout = setTimeout(function() {
        $("#statusbar").fadeOut()
    }, 5e3)
},timeout: setTimeout(function() {
}, 999999999),addBanner: function(a) {
    $('<div class="browser-message">').html(a).prependTo("#view")
}};
var pladdfail = function(a) {
    $(".new-playlist-input").hide();
    var b = $("<div>", {"class": "playlist-addition-failed"}).text(a);
    b.prependTo(".playlists-menu").delay(3e3).slideUp()
}, pladded = function(a) {
    oneTune.playlists.push(a.playlist), $(".new-playlist-input").hide(), $(".playlists-menu").prepend(a.div)
}, plrenamed = function(a) {
    $(".new-playlist-input").hide(), $('.playlists-menu .playlistmenuitem[data-navigate="' + a.old_url + '"]').attr("data-navigate", a.new_url).find(".pl-label").text(a.new_name), oneTune.playlists(_.map(oneTune.playlists(), function(b) {
        return b.url == a.old_url && (b.url = a.new_url, b.name = a.new_name), b
    })), $("#view").data("route") == a.old_url && ($("#view").data("route", a.new_url), $("#view").find("h1").text(a.new_name), $("#view").find("[data-represents]").data("represents", a.new_url)), player.queues.current.represents == a.old_url && (player.queues.current.represents = a.new_url), window.location.pathname == a.old_url && window.history.replaceState({}, null, a.new_url)
}, onTracksAdded = function(a) {
    var b = $('[data-route="/library"] .extendedtable .table-wrapper table'), c = b.find("tbody");
    $.each(a.divs, function(d, e) {
        var f = c.find(".song").eq(0);
        "top" == a.position && f.length > 0 ? $(f[0]).before(e) : $(e).appendTo(b), $('.song[data-id="' + $(e).attr("data-id") + '"]').addClass("in-library animated").removeClass("not-in-library")
    }), _.each(a.tracks, function(a) {
        oneTune.library.push(a + "")
    }), notifications.create(a.notification), listChanged("/library")
}, onTracksRemoved = function(a) {
    console.log("on library tracks removed", a);
    var b = $('[data-route="/library"]  .extendedtable tbody');
    $.each(a.tracks, function(a, c) {
        var c = b.find('[data-id="' + c + '"]').remove()
    }), notifications.create(a.notification), _.each(a.tracks, function(a) {
        oneTune.library(_.without(oneTune.library(), a + "")), libdom.markAsNotInLibrary(a + "")
    }), listChanged("/library")
}, plremoved = function(a) {
    $("#sidebar [data-navigate='" + a.url + "']").remove(), $("#view").data("route") == a.url && navigation.to("/"), player.queues.current.represents == a.url && (player.queues.current.represents = "/", player.queues.current.name = "Deleted playlist"), window.location.pathname == a.url && navigation.to("/"), oneTune.playlists(_.reject(oneTune.playlists(), function(b) {
        return b.url == a.url
    }))
}, onNotification = function(a) {
    notifications.create(a.html)
}, onPlaylistTracksRemoved = function(a) {
    a.view || (a.view = a.destination), libdom.removeSongsFromPlaylistLocal(a.view, a.tracks), _.each(a.tracks, function(b) {
        $('[data-represents="' + a.view + '"]').find('.song[data-id="' + b + '"]').remove()
    }), oneTune.playlists(_.map(oneTune.playlists(), function(b) {
        return b.url == a.destination && (b.tracks = _.reject(b.tracks, function(b) {
            return _.contains(a.tracks, b)
        })), b
    })), notifications.create(a.notification), listChanged(a.view), colors.getMostCommon(a.destination)
}, onRegisterFailed = function(a) {
    $(".username-disable").prop("disabled", !1), $(".username-availability-indicator").text(a.reason).removeClass("available").addClass("not-available")
}, onRegisterSuccessful = function(a) {
    document.cookie = "token=" + a.token + "; expires=Fri, 31 Dec 9999 23:59:59 GMT 12:00:00 GMT; path=/", window.location.href = "/"
}, onLoginSuccessful = function(a) {
    document.cookie = "token=" + a.token + "; expires=Fri, 31 Dec 9999 23:59:59 GMT 12:00:00 GMT; path=/", window.location.href = "/"
}, onLoginFailed = function(a) {
    $(".login-submit").prop("disabled", !1).text("Login"), $(".login-fail-indicator").text(a.reason).removeClass("available").addClass("not-available")
}, onMultiplePlaylistSongsAdded = function(a) {
    listChanged(a.view);
    var b = $('[data-route="' + a.view + '"] .extendedtable .album-tracks table'), c = b.find("tbody");
    $.each(a.divs, function(d, e) {
        var f = c.find(".song").eq(0);
        "top" == a.position && f.length > 0 ? $(f[0]).before(e) : ($(e).appendTo(b), $(".no-playlist-text").remove())
    }), libdom.addSongsToPlaylistLocal(a.view, a.tracks), _.each(a.songs, function(a) {
        DB.addTrack(a)
    }), _.each(a.tracks, function(b) {
        $('[data-route="/song/' + b + '"]').find("[data-url='" + a.view + "']").removeClass("add-song-to-playlist-button not-in-playlist").addClass("remove-song-from-playlist-button in-playlist contains-song").find(".song-page-playlist-trackcount").text(a.trackcount)
    }), notifications.create(a.notification), listChanged(a.view), colors.getMostCommon(a.view)
};
templates = {}, templates.buildLibrary = function(a) {
    var b = _.template($("#template-library").html());
    return a.coverstack = helpers.coverArrayToHQ(_.first(_.pluck(a.tracks, "image"), 4), 100), a.showartistalbum = !0, a.rawduration = _.reduce(a.tracks, function(a, b) {
        return a + parseFloat(b.duration)
    }, 0), a.duration = helpers.parsehours(a.rawduration), a.trackcount = a.tracks.length, a.tracks = _.map(a.tracks, function(a) {
        return a.inlib = !0, a
    }), a.tracklist = templates.buildTrackList(a), b({data: a})
}, templates.buildPlaylist = function(a) {
    var b = _.template($("#template-playlist").html());
    a.coverstack = helpers.coverArrayToHQ(_.first(_.pluck(a.tracks, "image"), 4), 100), a.showartistalbum = !0, a.tracklist = templates.buildTrackList(a), a.playlist.rawduration = _.reduce(a.tracks, function(a, b) {
        return a + parseFloat(b.duration)
    }, 0), a.playlist.duration = helpers.parsehours(a.playlist.rawduration), a.playlist.trackcount = a.tracks.length;
    var c = b({data: a});
    return c
}, templates.buildTrackList = function(a) {
    a.album = {cds: [[a.tracks]]};
    var b = _.template($("#template-tracklist").html());
    return b(a)
}, templates.buildSongsInList = function(a, b) {
    data = {cd: a};
    var c = _.template($("#template-song").html());
    return $.each(b, function(a, b) {
        data[a] = b
    }), c({data: data})
}, templates.buildSongContextMenu = function(a) {
    var b = (oneTune.playlists(), _.where(oneTune.playlists(), {url: a.represents})[0]);
    a.isPlaylist = _s.contains(a.represents, "/u/") && _s.contains(a.represents, "/p/"), console.log(b, chinchilla.user), a.isOwner = b ? b.owner == chinchilla.user : !1, a.isItunesTrack = !_.isNaN(parseInt(a.song.id));
    var c = _.template($("#template-contextmenu").html());
    return c({data: a})
}, templates.buildMultipleSongContextMenu = function(a) {
    a.isPlaylist = _s.contains(a.represents, "/u/") && _s.contains(a.represents, "/p/"), a.allInLibrary = _.every(a.songs, function(a) {
        return _.contains(oneTune.library(), a)
    }), a.noneInLibrary = _.every(a.songs, function(a) {
        return !_.contains(oneTune.library(), a)
    }), a.ids_string = a.songs.join(",");
    var b = _.template($("#template-contextmenu-multiple").html());
    return b({data: a})
}, templates.buildSidebarQueue = function(a) {
    if (player.queues.current) {
        var b = _.template($("#template-sidebar-queue").html());
        return b(a)
    }
}, templates.buildSidebarQueueEntry = function(a) {
    var b = _.template(['<div class="queue-entry <% if (data.special) { %> queue-entry-special <% } %>">', '	<img class="queue-entry-image" src="<%= helpers.getHQAlbumImage(data.song, 100) %>">', '	<p class="queue-entry-song"><%= data.song.name %></p>', '	<p class="queue-entry-artist"><%= data.song.artist %></p>', "</div>"].join("\n"));
    return b({data: a})
}, templates.buildQueue = function(a) {
    if (a) {
        var b = _.template($("#template-single-queue").html());
        return b(a)
    }
}, templates.buildSongPage = function(a) {
    if (a) {
        var b = _.template($("#song-page-template").html());
        return a.releaseyear = a.release.substr(0, 4), b({song: a,yt_page: a.provider && "youtube" == a.provider ? "youtube-page" : "",headerimage: helpers.getHQAlbumImage(a, 1200),hqimage: helpers.getHQAlbumImage(a, 400),parseduration: helpers.parsetime,user: chinchilla.user,inlib: _.contains(oneTune.library(), a.id),playlists: oneTune.playlists()})
    }
}, templates.buildNewSongPage = function() {
    return $("#template-v2-song-page").html()
}, templates.buildReport = function(a) {
    var b = _.template($("#template-report").html());
    return b(a)
}, templates.buildHome = function() {
    return $("#template-home").html()
}, templates.buildFilter = function(a) {
    var b = function(b) {
        var c = _.groupBy(b, function(a) {
            return a.genre
        }), d = $("#template-filter").html(), e = $(".filter-dropdown");
        e.html(_.template(d, {data: c})), _.each($(".filter-genre"), function(b) {
            $(b).on("change", function() {
                var b = _.map($(".filter-genre:checked"), function(a) {
                    return $(a).data("genre")
                }), c = $('[data-represents="' + a.list + '"] .song');
                0 == b.length ? $(c).show() : _.each(c, function(a) {
                    _.contains(b, $(a).data("genre")) ? $(a).show() : $(a).hide()
                })
            })
        })
    };
    DB.getTracks("/library" == a.list ? {ids: oneTune.library(),callback: b} : {ids: _.where(oneTune.playlists(), {url: a.list})[0].tracks,callback: b})
}, templates.buildFreebase = function(a, b, c, d, e) {
    return _.template(['<div class="freebase-info <%= data.classname %>">', "<h3><%= data.title %></h3>", '<p><%= data.text %><span><a target="_blank" href="<%= data.source %>"><%= data.citation %></a></span></p>', "</div>"].join("\n"), {data: {classname: a,title: b,text: c,citation: d,source: e}})
}, player = {}, player.playSong = function(a, b, c) {
    if (!b && player.nowPlaying.get() && a.id + "" == player.nowPlaying.get().id + "" && ytplayer && ytplayer.seekTo)
        return void ytplayer.seekTo(0);
    var d = helpers.parseDOM(a);
    $(a).hasClass("recognized") || void 0 != d.ytid ? (d = videoIdReplacements(d), b ? ytplayer.cueVideoById(d.ytid) : (ytplayer.loadVideoById ? setTimeout(function() {
        ytplayer.loadVideoById(d.ytid)
    }, 80) : (ytplayer.d && ytplayer.d.contentWindow || youtubeinit(), setTimeout(function() {
        player.playSong(a, b, c)
    }, 80)), $("#seek-bar").addClass("buffering"), $("#seek-progress").css("width", 0)), player.nowPlaying.replace(d, c), displaySpeaker()) : recognition.findVideo(d, function(a) {
        a && (d.ytid = a.basic.id.videoId, player.playSong(d))
    })
}, displaySpeaker = function() {
    $(".queue-now-playing").removeClass("queue-now-playing"), player && player.queues && player.queues.current && ($('[data-navigate="' + player.queues.current.represents + '"]').addClass("queue-now-playing"), $('.play-list[data-id="' + player.queues.current.represents + '"]').addClass("queue-now-playing"))
}, updateHints = function() {
    var a = player.queues.current.predictNext(), b = player.queues.current.predictPrev();
    nextlabel = void 0 != a ? "<strong>" + a.name + "</strong><br>" + a.artist : "Go to start of this song", prevlabel = void 0 != b ? "<strong>" + b.name + "</strong><br>" + b.artist : "Go to start of this song", $(".next-update").html(nextlabel), $(".prev-update").html(prevlabel), $("#skip").attr("data-tooltip", "<div class='next-update'>" + nextlabel + "</div>"), $("#rewind").attr("data-tooltip", "<div class='prev-update'>" + prevlabel + "</div>")
}, player.scrobbleTimeout = null, player.nowPlaying = {replace: function(a) {
    var b = player.nowPlaying.get(), a = helpers.parseDOM(a);
    localStorage.nowPlaying = JSON.stringify(a), oneTune.nowPlaying(a);
    var c = !1;
    chinchilla.loggedin && (_.contains(oneTune.library(), a.id + "") && (c = !0), $("#nowplaying-heart-container").attr("class", c ? "in-library" : "not-in-library"), $("#nowplaying-heart").attr("data-id", a.id + "")), $("#track-title a").text(a.name).attr("data-navigate", "/song/" + a.id), $("#track-artist a").text(a.artist).attr("data-navigate", "/artist/" + a.artistid), $("#track-album a").text("null" == a.album ? "" : a.album).attr("data-navigate", "/album/" + a.albumid), $("title").text(a.name + " - " + a.artist);
    var d = helpers.getHQAlbumImage(a, 225);
    window.SwayState = {playing: !0,title: a.name,artist: a.artist,favorite: c,albumArt: d}, unity.sendState(window.SwayState), "true" == localStorage.scrobble && (player.scrobbleTimeout && clearTimeout(player.scrobbleTimeout), player.scrobbleTimeout = setTimeout(function() {
        $.ajax({url: "/lastfm/scrobble",data: {track: a.name,artist: a.artist},type: "POST",success: function(a) {
            console.log("Tried to scrobble. Success:", a.success)
        }})
    }, 3e4)), (chinchilla.settings.favicon_album || !chinchilla.settings) && $("#favicon").attr("href", a.image);
    var e = $("#nowplaying-image"), f = $("#nowplaying-image2"), d = helpers.getHQAlbumImage(a, 225);
    1 != $("#player-controls").css("opacity") && player.show(), (b && b.image != a.image || "" == e.attr("src") && "" == e.attr("src")) && (e.hasClass("np-placeholder-used") ? (e.removeClass("np-placeholder-used"), f.attr("src") == d ? playerimgload2() : f.attr("src", d).addClass("np-placeholder-used")) : (f.removeClass("np-placeholder-used"), e.attr("src") == d ? playerimgload1() : e.attr("src", d).addClass("np-placeholder-used")));
    var g = $('.one-track-wrapper[data-represents="' + player.queues.current.represents + '"]').find(".one-track-wrapper-cover");
    g.attr("src", helpers.getHQAlbumImage(a, $(g).attr("data-px"))), $(".song").removeClass("now-playing hearable"), oneTune.hearable(!1), $(".song[data-id='" + a.id + "']").addClass("now-playing"), updateHints(), remote.updateTrack()
},get: function() {
    return helpers.localStorageSafety("nowPlaying"), "[]" == localStorage.nowPlaying ? null : JSON.parse(localStorage.nowPlaying)
}};
var Queue = function(a, b) {
    this.current = null, this.queue = [], this.represents = b, this.name = a, this.history = [], this.add = function(a, b) {
        var a = helpers.parseDOM(a);
        return this.queue[b ? "unshift" : "push"](a), player.saveQueQue(), this.queue
    }, this.setCurrent = function(a) {
        this.current = helpers.parseDOM(a), player.saveQueQue()
    }, this.clearQueue = function() {
        return this.queue = [], this.queue
    }, this.clearHistory = function() {
        return this.history = [], this.history
    }, this.nextTrack = function() {
        if (0 != player.queues.primaryQueue.length) {
            var a = player.queues.primaryQueue.splice(0, 1)[0];
            return $.publish("queue-changed"), a
        }
        if (0 == this.queue.length) {
            if (0 == this.history.length)
                return this.current;
            var b = this.history.shift()
        } else
            var b = this.queue.shift();
        return this.current && this.history.push(this.current), player.saveQueQue(), this.current = b, $.publish("queue-changed"), b
    }, this.nthTrack = function(a) {
        if (0 != player.queues.primaryQueue.length) {
            if (!(a > player.queues.primaryQueue.length)) {
                var b = player.queues.primaryQueue.splice(a - 1, 1)[0];
                return $.publish("queue-changed"), b
            }
            a -= player.queues.primaryQueue.length
        }
        if (0 == this.queue.length) {
            if (0 == this.history.length)
                return this.current;
            var c = this.history.length, d = this.history.splice(0, a), e = a - c;
            e > 0 && (d = d.concat(this.queue.splice(0, e)))
        } else {
            var f = this.queue.length, d = this.queue.splice(0, a), e = a - f;
            e && (d = d.concat(this.history.splice(0, e)))
        }
        var g = d.pop();
        return console.log(d, this.current), this.current && (this.history.push(this.current), this.history = this.history.concat(d)), player.saveQueQue(), this.current = g, $.publish("queue-changed"), g
    }, this.previousTrack = function() {
        if (0 == this.history.length) {
            if (0 == this.queue.length)
                return this.current;
            var a = this.queue.pop()
        } else
            var a = this.history.pop();
        return this.current && this.queue.unshift(this.current), player.saveQueQue(), this.current = a, $.publish("queue-changed"), a
    }, this.predictNext = function() {
        return 0 != player.queues.primaryQueue.length ? player.queues.primaryQueue[0] : 0 == this.queue.length ? 0 == this.history.length ? this.current : this.history[0] : this.queue[0]
    }, this.predictPrev = function() {
        return 0 == this.history.length ? 0 == this.queue.length ? this.current : _.last(this.queue) : _.last(this.history)
    }
}, QueQue = function() {
    this.current = null, this.next = [], this.prev = [], this.primaryQueue = [], this.nextQueue = function() {
        0 != this.next.length && (this.current && this.prev.push(this.current), this.current = this.next.shift(), player.saveQueQue(), player.playQueue(), $.publish("queue-changed"))
    }, this.prevQueue = function() {
        0 != this.prev.length && (this.next.unshift(this.current), this.current = this.prev.pop(), player.saveQueQue(), player.playQueue(), $.publish("queue-changed"))
    }, this.newQueue = function(a) {
        if (this.current) {
            if (this.current.represents == a.represents)
                return this.current = a, void $.publish("queue-changed");
            this.prev.push(this.current)
        }
        _.each(this.next, function(a) {
            this.prev.push(a)
        }.bind(this)), this.current = a;
        var b = function(b) {
            return b.represents == a.represents
        };
        this.prev = _.last(_.reject(this.prev, b), 15), this.next = _.first(_.reject(this.next, b), 15), $.publish("queue-changed")
    }, this.hasPrevious = function() {
        return 0 != this.prev.length
    }, this.hasNext = function() {
        return 0 != this.next.length
    }
}, convertToNormalQueue = function(a) {
    if (!a)
        return null;
    var b = new Queue(a.name, a.represents);
    return b.current = a.current, b.history = a.history, b.queue = a.queue, b
}, convertToNormalQueQue = function(a) {
    var b = new QueQue;
    return b.current = a.current, b.next = a.next, b.prev = a.prev, b
};
player.saveQueQue = function() {
    localStorage.queues = JSON.stringify(player.queues)
}, player.backUpQueue = function() {
    localStorage.queues && (player.queues = JSON.parse(localStorage.queues), player.queues = convertToNormalQueQue(player.queues), player.queues.current = convertToNormalQueue(player.queues.current), player.queues.next = _.map(player.queues.next, function(a) {
        return convertToNormalQueue(a)
    }), player.queues.prev = _.map(player.queues.prev, function(a) {
        return convertToNormalQueue(a)
    }))
}, player.queues = new QueQue, player.backUpQueue(), player.automaticseekblocked = !1;
var stateChange = function(a) {
    1 == a.data ? (window.SwayState && (window.SwayState.playing = !0, unity.sendState(window.SwayState)), $("#play").hide(), $("#pause").show(), $("#seek-bar").removeClass("buffering"), $(".now-playing").addClass("hearable"), oneTune.hearable(!0)) : (0 == a.data && player.playNext(), 2 == a.data && ($(".now-playing").removeClass("hearable"), oneTune.hearable(!1)), $("#pause").hide(), $("#play").show(), window.SwayState && (window.SwayState.playing = !1, unity.sendState(window.SwayState)))
}, videoEnded = function() {
    player.playNext()
}, videoIdReplacements = function(a) {
    helpers.localStorageSafetyObject("videoIdReplacements");
    var b = helpers.getLocalStorage("videoIdReplacements"), c = b[a.ytid];
    return void 0 != c && (a.ytid = c), a
}, replaceVideo = function(a, b) {
    helpers.localStorageSafety("videoIdReplacements");
    var c = JSON.parse(localStorage.videoIdReplacements);
    c[a] = b, localStorage.videoIdReplacements = JSON.stringify(c)
}, errorOccured = function(a) {
    notifications.create(0 == a ? "The video could not be loaded due to some country restrictions. Looking for an alternative..." : "A unknown error happened while trying to play the video. Looking for an altenative..."), helpers.localStorageSafety("banned_videos");
    var b = JSON.parse(localStorage.banned_videos);
    b.push(player.nowPlaying.get().ytid), localStorage.banned_videos = JSON.stringify(b);
    var c = player.nowPlaying.get();
    recognition.findVideo(c, function(a) {
        if (void 0 != a) {
            var b = c.ytid, d = a.basic.id.videoId;
            c.ytid = d, replaceVideo(b, d), ytplayer.loadVideoById(c.ytid), notifications.create("Original video not available in your country. Alternative was found.")
        } else
            notifications.create("No video available in your country was found. We cannot play this song, sorry.")
    }, void 0, void 0, void 0, ["restricted"])
};
player.show = function() {
   // $("#player-controls").animate({opacity: 1}, 100), $('[data-navigate="/youtube"]').show(), $("#nowplaying-speaker-icon").show()
}, player.setUpEvents = function() {
   /* var a = function() {
        var b = ytplayer.getCurrentTime(), c = ytplayer.getDuration(), d = helpers.parsetime(b), e = helpers.parsetime(c);
        document.getElementById("time-right").innerHTML = "NaN:NaN" == e ? "0:00" : e, document.getElementById("time-left").innerHTML = "NaN:NaN" == d ? "0:00" : d;
        var f, g = b / c * 100;
        if (!player.automaticseekblocked && g)
            var f = g;
        if ("NaN" == g)
            var f = 0;
        document.getElementById("seek-progress").style.width = f + "%", setTimeout(a, 500)
    };
    a()*/
}, player.playQueue = function() {
    player.playSong(player.queues.current.current), player.saveQueQue()
}, player.pause = function() {
    ytplayer && ytplayer.pauseVideo && ytplayer.pauseVideo()
}, player.play = function() {
    ytplayer.playVideo()
}, player.seek = function(a) {
    ytplayer.seekTo(a)
}, player.playNext = function() {
    player.playSong(player.queues.current.nextTrack())
}, player.skipNTracks = function(a) {
    player.playSong(player.queues.current.nthTrack(a))
}, player.playLast = function() {
    player.playSong(player.queues.current.previousTrack())
}, player.togglePlayState = function() {
    var a = ytplayer.getPlayerState();
    1 == a ? player.pause() : player.play()
}, search = {calls: [],autocomplete: function(a) {
    var b = $("#search-results-wrapper");
    search.calls = [];
    var c = {artist: {iTunesName: "musicArtist",title: "artistName",sub: "primaryGenreName",element: $("#results-artists"),link: "/artist/$1",id: "artistId",image: "svg-artist-black"},album: {iTunesName: "album",title: "collectionName",sub: "artistName",element: $("#results-albums"),link: "/album/$1",id: "collectionId",image: "svg-album-black"},track: {iTunesName: "song",title: "trackName",sub: "artistName",element: $("#results-tracks"),link: "/song/$1",id: "trackId",image: "svg-music-black"}}, d = {count: 0,album: [],track: [],artist: [],youtube: []}, e = function() {
        $("#search-spinner").show()
    }, f = function() {
        $("#search-spinner").hide()
    };
    if ("" == a)
        return void f();
    var g = function(c) {
        var d, e = c.track.length > 0 ? _s.levenshtein(c.track[0].title.toLowerCase(), a.toLowerCase()) : 1e3, g = c.artist.length > 0 ? _s.levenshtein(c.artist[0].title.toLowerCase(), a.toLowerCase()) : 1e3, h = c.album.length > 0 ? _s.levenshtein(c.album[0].title.toLowerCase(), a.toLowerCase()) : 1e3;
        Math.min(e, h, g) == e ? d = c.track.splice(0, 1) : Math.min(e, h, g) == h ? d = c.album.splice(0, 1) : Math.min(e, h, g) == g && (d = c.artist.splice(0, 1)), b.empty(), $(".search-placeholder").hide();
        var i = function(a) {
            var c = $('<li class="search-result" data-navigate="' + a.link + '"><img src="/api/i/pixel" class="' + a.image + '"><p>' + a.title + '</p><p class="search-result-sub">' + a.sub + "</p></li>");
            f(), b.append(c)
        }, j = function(a) {
            b.append("<h2>" + a + "</h2>")
        };
        d.length > 0 && (j("Top result"), i(d[0], 0, !0)), c.track.length > 0 && j("Songs"), _.each(c.track, i), c.artist.length > 0 && j("Artists"), _.each(c.artist, i), c.album.length > 0 && j("Albums"), _.each(c.album, i), c.youtube.length > 0 && j("Youtube results"), _.each(c.youtube, i), $("#search-results").addClass("search-results-visible"), $(".search-result").eq(0).addClass("search-selected")
    };
    e(), $.each(c, function(b, c) {
        var e = $.ajax({url: "http://itunes.apple.com/search",data: {term: a,entity: c.iTunesName,limit: 3},dataType: "jsonp",success: function(a) {
            _.each(a.results, function(a) {
                d[b].push({title: a[c.title],sub: a[c.sub],type: b,link: c.link.replace("$1", a[c.id]),image: c.image})
            }), d.count++, 4 == d.count && g(d)
        }});
        search.calls.push(e)
    });
    $.ajax({url: "https://www.googleapis.com/youtube/v3/search",data: {part: "snippet",maxResults: 5,q: a,key: "AIzaSyCCRAemuZXM6GwYQWXOQI1e4kMnB57LtX0"},success: function(a) {
        console.log(a), _.each(a.items, function(a) {
            d.youtube.push({title: a.snippet.title,sub: a.snippet.channelTitle,type: "youtube",link: "/song/" + a.id.videoId,image: "svg-music-black"})
        }), d.count++, 4 == d.count && g(d)
    }})
}}, addtracks = {calls: [],lastrequest: null,autocomplete: function(a) {
    search.calls = [];
    var b = {track: {iTunesName: "song",title: "trackName",sub: "artistName",element: $(".add-tracks-results"),id: "trackId"}};
    this.lastrequest = a, $.each(b, function(b, c) {
        var d = $.ajax({url: "http://itunes.apple.com/search",data: {term: a,entity: c.iTunesName,limit: 3},dataType: "jsonp",success: function(b) {
            a == addtracks.lastrequest && "" != $(".add-tracks-input").val() && (c.element.show().empty(), $.each(b.results, function(a, b) {
                var d = $("<div>", {"class": "search-result"});
                $("<div>", {"class": "search-result-title"}).text(b[c.title]).appendTo(d), $("<div>", {"class": "search-result-sub"}).text(b[c.sub]).appendTo(d);
                var e = helpers.remap(b), f = $("<span>", {"data-id": e.id,"data-name": e.name,"data-artist": e.artist,"data-image": e.image}).html(d).on("click", function() {
                    c.element.hide();
                    var a = $("#view").attr("data-route");
                    "/library" == a ? library.add({id: b.trackId}) : "/u/" == a.substr(0, 3) ? playlist.add({id: b.trackId}, a) : a.match("/submit") && submit.selectSong(e), $(".add-tracks-input").val("").focus(), c.element.html(""), window.lastsearchtimestamp = null
                });
                f.appendTo(c.element), 0 == a && $(f).addClass("add-tracks-selected")
            }))
        }});
        search.calls.push(d)
    })
}};
var addToCollections, addToImportQueue, cancelEverything, determineProvider, determineTarget, droparea, fileDropped, importqueue, queuechanged, queuestarted, recognize, recognizeFile, recognizeSpotify, recognizeTracks, startQueue, stopQueue, textDropped, weirdThingDropped;
droparea = $("#view"), importqueue = [], queuestarted = !1, cancelEverything = function(a) {
    return a.stopPropagation(), a.preventDefault()
}, fileDropped = function(a) {
    return _.each(a, function(a) {
        var b;
        return b = {type: {provider: "file",id: a},target: determineTarget()}, addToImportQueue(b)
    })
}, textDropped = function(a) {
    var b;
    return b = a.replace(/\r/g, "").split(/\n/), _.each(b, function(a) {
        var b;
        return b = {type: determineProvider(a),target: determineTarget()}, b.type ? addToImportQueue(b) : void 0
    })
}, weirdThingDropped = function() {
    return console.log("something was dropped")
}, determineTarget = function() {
    return $("#view").attr("data-route")
}, determineProvider = function(a) {
    return 52 === a.length && "http://open.spotify.com/track/" === a.substr(0, 30) ? {provider: "spotify",id: a.substr(30)} : "http://www.youtube.com/watch" === a.substr(0, 28) ? {provider: "youtube",id: a.substr(31, 11)} : !1
}, addToImportQueue = function(a) {
    importqueue.push(a), $(".import-trackcount").text(importqueue.length + (1 == importqueue.length ? " track" : " tracks")), $("#importqueue").append(_.template($("#import-track-template").html(), {track: a})), 0 != importqueue.length && $(".import-no-tracks").remove()
}, queuechanged = function() {
    if (queuestarted) {
        if (0 === importqueue.length)
            return stopQueue()
    } else if (0 !== importqueue.length)
        return startQueue()
}, startQueue = function() {
    return queuestarted = !0, console.log("Queue started"), $("body").addClass("queuestarted"), recognizeTracks()
}, stopQueue = function() {
    return queuestarted = !1, $("body").removeClass("queuestarted"), console.log("Queue ended")
}, recognizeTracks = function() {
    var a;
    return 0 == importqueue.length ? void stopQueue() : (a = importqueue.shift(), recognize(a, function(b) {
        return addToCollections(a, b), queuechanged(), 0 !== importqueue.length ? recognizeTracks() : void 0
    }))
}, recognize = function(a, b) {
    return "spotify" === a.type.provider ? recognizeSpotify(a, function(a) {
        return b(a)
    }) : "file" === a.type.provider ? recognizeFile(a, function(a) {
        return b(a)
    }) : void 0
}, recognizeSpotify = function(a, b) {
    var c = $('.import-track[data-importid="' + a.type.provider + "-" + a.type.id + '"]'), d = $(c).find(".import-status"), e = $(c).find(".import-trackname");
    return d.text("Looking up track..."), $.getJSON("http://ws.spotify.com/lookup/1/.json?uri=spotify:track:" + a.type.id, function(c) {
        a = {name: c.track.name,artist: c.track.artists[0].name}, e.text(a.name + " - " + a.artist), d.text("Requesting track info..."), $.ajax({url: "http://itunes.apple.com/search?country=us",data: {entity: "song",limit: 1,term: a.name + " - " + a.artist},dataType: "jsonp",success: function(a) {
            if (a && a.results) {
                var b = _.first(a.results);
                if (b) {
                    var c = helpers.remap(b);
                    console.log(c), f({song: c})
                } else
                    f({error: 404})
            } else
                f({error: 403})
        },error: function() {
            f({error: 403})
        }});
        var f = function(a) {
            var c;
            return a.error ? (404 == a.error && d.text("Not found on OneTune."), 403 == a.error && d.text("iTunes rate limit"), b(null)) : (c = a.song, d.text("Finding YouTube video..."), recognition.findVideo(c, function(a) {
                return a ? (c.ytid = helpers.parseYTId(a), $.ajax({url: "/api/new-track",dataType: "json",data: c,success: function(a) {
                    return a.socket_body + "" == c.id + "" ? (d.text("Imported."), b(c)) : void 0
                }}), void d.text("Adding...")) : (d.text("No video found."), b(null))
            }))
        }
    })
}, addToCollections = function(a, b) {
    var c;
    if (c = chinchilla.playlist_target ? chinchilla.playlist_target : "/library", b)
        if (_s.contains(c, "/u/") && _s.contains(c, "/p/")) {
            var d = {token: chinchilla.token,tracks: [b.id + ""],destination: c,type: "playlist"};
            $.ajax({url: "/api/add_tracks",dataType: "json",data: d,success: library.ajaxResponse})
        } else {
            var d = {token: chinchilla.token,tracks: [b.id + ""],destination: "library",type: "library"};
            $.ajax({url: "/api/add_tracks",dataType: "json",data: d,success: library.ajaxResponse})
        }
}, $(document).ready(function() {
    return document.addEventListener("dragenter", function(a) {
        return cancelEverything(a)
    }), document.getElementById("dropfiles").addEventListener("dragleave", function() {
        return document.getElementById("dropfiles").className = "", document.getElementById("dropfilescontent").className = ""
    }), document.addEventListener("dragover", function(a) {
        return document.getElementById("dropfiles").className = "drag-hover", document.getElementById("dropfilescontent").className = "drag-hover", cancelEverything(a)
    }), document.addEventListener("drop", function(a) {
        var b, c;
        document.getElementById("dropfiles").className = "", document.getElementById("dropfilescontent").className = "", cancelEverything(a), b = a.dataTransfer.files, c = a.dataTransfer.getData("Text");
        var d = window.location.pathname;
        return "/import" != window.location.pathname && ((_s.contains(d, "/u/") && _s.contains(d, "/p/") || "/library" == d) && (chinchilla.playlist_target = d), navigation.to("/import")), 0 !== b.length ? fileDropped(b) : "" !== c ? textDropped(c) : weirdThingDropped()
    })
}), errors = {draw: function(a) {
    $("#view").load("/api/error/" + a), views.loadingindicator.hide()
}};
var recognitionAdditionHandler = function() {
    0 == recognition.started && recognition.start()
};
recognition = {recognizeAlbum: function(a) {
    var b = $(a).find(".album-tracks table tbody tr.song.not-recognized");
    $.each(b, function(a, b) {
        recognition.queue.push(b)
    })
},recognizeTrackList: function(a) {
    var b = $(a).find("tr.song.not-recognized");
    $.each(b, function(a, b) {
        recognition.queue.push(b)
    })
},queue: new EventedArray(recognitionAdditionHandler),recognizeTrack: function(a) {
    var b = a.track, c = a.cb, d = helpers.parseDOM(b), e = void 0 != b.length && 0 != b.length ? b[0] : b, f = e instanceof HTMLElement ? $(e) : $(".song[data-id=" + e.id + "]")[0];
    return $(f).hasClass("recognized") ? void c() : void recognition.findVideo(d, function(a) {
        if (a) {
            var b = $('.song[data-id="' + d.id + '"]').attr("data-ytid", a.basic.id.videoId);
            b.addClass("recognized").removeClass("not-recognized pending"), d.ytid = a.basic.id.videoId, recognition.uploadTrack(d, a)
        } else
            $(f).addClass("no-video-found");
        c()
    })
},started: !1,start: function() {
    recognition.started = !0;
    var a = function() {
        recognition.recognizeTrack({track: recognition.queue.getArray()[0],cb: function() {
            recognition.started && (recognition.queue.shift(), 0 == recognition.queue.getArray().length ? recognition.stop() : a())
        }})
    };
    a()
},stop: function() {
    recognition.started = !1
},findVideo: function(a, b, c, d, e, f) {
    void 0 != c && ($ = c), void 0 != d && (_ = d), void 0 != e && (_s = e), a.name = void 0 == a.title ? a.name : a.title;
    var g = {part: "snippet",key: "AIzaSyCCRAemuZXM6GwYQWXOQI1e4kMnB57LtX0",maxResults: 15,videoEmbeddable: !0,type: "video",q: a.artist + " " + a.name};
    void 0 != f && _.contains(f, "restricted") && (g.regionCode = "DE"), $.ajax({url: "https://www.googleapis.com/youtube/v3/search",data: g,success: function(c) {
        var d = _.map(c.items, function(a) {
            return a.id.videoId
        });
        return $.ajax({url: "https://www.googleapis.com/youtube/v3/videos",data: {key: "AIzaSyCCRAemuZXM6GwYQWXOQI1e4kMnB57LtX0",maxResults: 15,part: "contentDetails,statistics",id: d.join(",")},success: function(d) {
            for (var e = [], g = 0; g < c.items.length; g++)
                e.push({basic: c.items[g],advanced: d.items[g]});
            recognition.findBestVideo(e, a, function(a) {
                b(a)
            }, _, _s, f)
        }})
    }})
},findBestVideo: function(a, b, c, d, e, f) {
    var g = a, h = d.max(g, function(a) {
        return parseInt(a.advanced.statistics.viewCount)
    });
    if (!h)
        return void c(null);
    var i = h.advanced.statistics.viewCount;
    if ("undefined" != typeof localStorage) {
        helpers.localStorageSafety("banned_videos");
        var j = JSON.parse(localStorage.banned_videos);
        g = d.reject(g, function(a) {
            return d.contains(j, a.basic.id.videoId)
        })
    }
    d.map(g, function(a) {
        a.points = 0;
        var c = e.slugify(a.basic.snippet.title), f = e.slugify(b.artist + " " + b.name), g = helpers.titleMatcher(a.basic.snippet.title, d), h = g.join(" "), j = helpers.titleMatcher(b.artist + " " + b.name, d), k = [], l = [];
        d.each(j, function(a) {
            var b = h.indexOf(a);
            -1 == b ? l.push(a) : (k.push(a), h = h.replace(a, ""))
        });
        var m = 300 * (k.length / j.length) - 2 * h.replace(/\s/g, "").length;
        m = 0 > m ? 0 : m, a.points += m;
        var n = helpers.parseNewYTTime(a.advanced.contentDetails.duration), o = b.duration / 1e3, p = Math.abs(n - o), q = 0 === p ? 0 : p - 1, r = q;
        a.points -= r;
        var s = parseInt(a.advanced.statistics.viewCount), t = s / i, u = Math.ceil(50 * t);
        a.points += u;
        var v = parseInt(a.advanced.statistics.likeCount), w = parseInt(a.advanced.statistics.dislikeCount);
        if (v + w > 0) {
            var x = v / (v + w), y = Math.ceil(150 * x);
            a.points += y
        }
        a.points += 200;
        var z = ["cover", "parod", "chipmunk", "snippet", "preview", "live", "review", "vocaloid", "dance", "remix"];
        d.each(z, function(b) {
            e.include(c.toLowerCase(), b) && !e.include(f, b) && (a.points -= 75)
        }), a.points += 50, e.include(c.toLowerCase()), b.album && (e.include(f, "skit") || e.include(f, "intro") || e.include(f, "outro")) && (a.points -= 50)
    });
    var k = d.sortBy(g, function(a) {
        return a.points
    }).reverse(), l = d.first(k);
    l && console.log("The best video has ", l.points, " points!", b.name), c(f && f.all_videos ? k : l)
},uploadTrack: function(a, b) {
    var c = b.basic.id.videoId, d = a;
    d.ytid = c, d.id = d.id + "", $.ajax({url: "/api/new-ytid",dataType: "json",data: d}), DB.addYTIDToTrack(a, c)
}}, this.recognition = recognition;
var swfobject = function() {
    function a() {
        if (!R) {
            try {
                var a = K.getElementsByTagName("body")[0].appendChild(q("span"));
                a.parentNode.removeChild(a)
            } catch (b) {
                return
            }
            R = !0;
            for (var c = N.length, d = 0; c > d; d++)
                N[d]()
        }
    }
    function b(a) {
        R ? a() : N[N.length] = a
    }
    function c(a) {
        if (typeof J.addEventListener != C)
            J.addEventListener("load", a, !1);
        else if (typeof K.addEventListener != C)
            K.addEventListener("load", a, !1);
        else if (typeof J.attachEvent != C)
            r(J, "onload", a);
        else if ("function" == typeof J.onload) {
            var b = J.onload;
            J.onload = function() {
                b(), a()
            }
        } else
            J.onload = a
    }
    function d() {
        M ? e() : f()
    }
    function e() {
        var a = K.getElementsByTagName("body")[0], b = q(D);
        b.setAttribute("type", G);
        var c = a.appendChild(b);
        if (c) {
            var d = 0;
            !function() {
                if (typeof c.GetVariable != C) {
                    var e = c.GetVariable("$version");
                    e && (e = e.split(" ")[1].split(","), U.pv = [parseInt(e[0], 10), parseInt(e[1], 10), parseInt(e[2], 10)])
                } else if (10 > d)
                    return d++, void setTimeout(arguments.callee, 10);
                a.removeChild(b), c = null, f()
            }()
        } else
            f()
    }
    function f() {
        var a = O.length;
        if (a > 0)
            for (var b = 0; a > b; b++) {
                var c = O[b].id, d = O[b].callbackFn, e = {success: !1,id: c};
                if (U.pv[0] > 0) {
                    var f = p(c);
                    if (f)
                        if (!s(O[b].swfVersion) || U.wk && U.wk < 312)
                            if (O[b].expressInstall && h()) {
                                var k = {};
                                k.data = O[b].expressInstall, k.width = f.getAttribute("width") || "0", k.height = f.getAttribute("height") || "0", f.getAttribute("class") && (k.styleclass = f.getAttribute("class")), f.getAttribute("align") && (k.align = f.getAttribute("align"));
                                for (var l = {}, m = f.getElementsByTagName("param"), n = m.length, o = 0; n > o; o++)
                                    "movie" != m[o].getAttribute("name").toLowerCase() && (l[m[o].getAttribute("name")] = m[o].getAttribute("value"));
                                i(k, l, c, d)
                            } else
                                j(f), d && d(e);
                        else
                            u(c, !0), d && (e.success = !0, e.ref = g(c), d(e))
                } else if (u(c, !0), d) {
                    var q = g(c);
                    q && typeof q.SetVariable != C && (e.success = !0, e.ref = q), d(e)
                }
            }
    }
    function g(a) {
        var b = null, c = p(a);
        if (c && "OBJECT" == c.nodeName)
            if (typeof c.SetVariable != C)
                b = c;
            else {
                var d = c.getElementsByTagName(D)[0];
                d && (b = d)
            }
        return b
    }
    function h() {
        return !S && s("6.0.65") && (U.win || U.mac) && !(U.wk && U.wk < 312)
    }
    function i(a, b, c, d) {
        S = !0, y = d || null, z = {success: !1,id: c};
        var e = p(c);
        if (e) {
            "OBJECT" == e.nodeName ? (w = k(e), x = null) : (w = e, x = c), a.id = H, (typeof a.width == C || !/%$/.test(a.width) && parseInt(a.width, 10) < 310) && (a.width = "310"), (typeof a.height == C || !/%$/.test(a.height) && parseInt(a.height, 10) < 137) && (a.height = "137"), K.title = K.title.slice(0, 47) + " - Flash Player Installation";
            var f = U.ie && U.win ? "ActiveX" : "PlugIn", g = "MMredirectURL=" + J.location.toString().replace(/&/g, "%26") + "&MMplayerType=" + f + "&MMdoctitle=" + K.title;
            if (typeof b.flashvars != C ? b.flashvars += "&" + g : b.flashvars = g, U.ie && U.win && 4 != e.readyState) {
                var h = q("div");
                c += "SWFObjectNew", h.setAttribute("id", c), e.parentNode.insertBefore(h, e), e.style.display = "none", function() {
                    4 == e.readyState ? e.parentNode.removeChild(e) : setTimeout(arguments.callee, 10)
                }()
            }
            l(a, b, c)
        }
    }
    function j(a) {
        if (U.ie && U.win && 4 != a.readyState) {
            var b = q("div");
            a.parentNode.insertBefore(b, a), b.parentNode.replaceChild(k(a), b), a.style.display = "none", function() {
                4 == a.readyState ? a.parentNode.removeChild(a) : setTimeout(arguments.callee, 10)
            }()
        } else
            a.parentNode.replaceChild(k(a), a)
    }
    function k(a) {
        var b = q("div");
        if (U.win && U.ie)
            b.innerHTML = a.innerHTML;
        else {
            var c = a.getElementsByTagName(D)[0];
            if (c) {
                var d = c.childNodes;
                if (d)
                    for (var e = d.length, f = 0; e > f; f++)
                        1 == d[f].nodeType && "PARAM" == d[f].nodeName || 8 == d[f].nodeType || b.appendChild(d[f].cloneNode(!0))
            }
        }
        return b
    }
    function l(a, b, c) {
        var d, e = p(c);
        if (U.wk && U.wk < 312)
            return d;
        if (e)
            if (typeof a.id == C && (a.id = c), U.ie && U.win) {
                var f = "";
                for (var g in a)
                    a[g] != Object.prototype[g] && ("data" == g.toLowerCase() ? b.movie = a[g] : "styleclass" == g.toLowerCase() ? f += ' class="' + a[g] + '"' : "classid" != g.toLowerCase() && (f += " " + g + '="' + a[g] + '"'));
                var h = "";
                for (var i in b)
                    b[i] != Object.prototype[i] && (h += '<param name="' + i + '" value="' + b[i] + '" />');
                e.outerHTML = '<object classid="clsid:D27CDB6E-AE6D-11cf-96B8-444553540000"' + f + ">" + h + "</object>", P[P.length] = a.id, d = p(a.id)
            } else {
                var j = q(D);
                j.setAttribute("type", G);
                for (var k in a)
                    a[k] != Object.prototype[k] && ("styleclass" == k.toLowerCase() ? j.setAttribute("class", a[k]) : "classid" != k.toLowerCase() && j.setAttribute(k, a[k]));
                for (var l in b)
                    b[l] != Object.prototype[l] && "movie" != l.toLowerCase() && m(j, l, b[l]);
                e.parentNode.replaceChild(j, e), d = j
            }
        return d
    }
    function m(a, b, c) {
        var d = q("param");
        d.setAttribute("name", b), d.setAttribute("value", c), a.appendChild(d)
    }
    function n(a) {
        var b = p(a);
        b && "OBJECT" == b.nodeName && (U.ie && U.win ? (b.style.display = "none", function() {
            4 == b.readyState ? o(a) : setTimeout(arguments.callee, 10)
        }()) : b.parentNode.removeChild(b))
    }
    function o(a) {
        var b = p(a);
        if (b) {
            for (var c in b)
                "function" == typeof b[c] && (b[c] = null);
            b.parentNode.removeChild(b)
        }
    }
    function p(a) {
        var b = null;
        try {
            b = K.getElementById(a)
        } catch (c) {
        }
        return b
    }
    function q(a) {
        return K.createElement(a)
    }
    function r(a, b, c) {
        a.attachEvent(b, c), Q[Q.length] = [a, b, c]
    }
    function s(a) {
        var b = U.pv, c = a.split(".");
        return c[0] = parseInt(c[0], 10), c[1] = parseInt(c[1], 10) || 0, c[2] = parseInt(c[2], 10) || 0, b[0] > c[0] || b[0] == c[0] && b[1] > c[1] || b[0] == c[0] && b[1] == c[1] && b[2] >= c[2] ? !0 : !1
    }
    function t(a, b, c, d) {
        if (!U.ie || !U.mac) {
            var e = K.getElementsByTagName("head")[0];
            if (e) {
                var f = c && "string" == typeof c ? c : "screen";
                if (d && (A = null, B = null), !A || B != f) {
                    var g = q("style");
                    g.setAttribute("type", "text/css"), g.setAttribute("media", f), A = e.appendChild(g), U.ie && U.win && typeof K.styleSheets != C && K.styleSheets.length > 0 && (A = K.styleSheets[K.styleSheets.length - 1]), B = f
                }
                U.ie && U.win ? A && typeof A.addRule == D && A.addRule(a, b) : A && typeof K.createTextNode != C && A.appendChild(K.createTextNode(a + " {" + b + "}"))
            }
        }
    }
    function u(a, b) {
        if (T) {
            var c = b ? "visible" : "hidden";
            R && p(a) ? p(a).style.visibility = c : t("#" + a, "visibility:" + c)
        }
    }
    function v(a) {
        var b = /[\\\"<>\.;]/, c = null != b.exec(a);
        return c && typeof encodeURIComponent != C ? encodeURIComponent(a) : a
    }
    {
        var w, x, y, z, A, B, C = "undefined", D = "object", E = "Shockwave Flash", F = "ShockwaveFlash.ShockwaveFlash", G = "application/x-shockwave-flash", H = "SWFObjectExprInst", I = "onreadystatechange", J = window, K = document, L = navigator, M = !1, N = [d], O = [], P = [], Q = [], R = !1, S = !1, T = !0, U = function() {
            var a = typeof K.getElementById != C && typeof K.getElementsByTagName != C && typeof K.createElement != C, b = L.userAgent.toLowerCase(), c = L.platform.toLowerCase(), d = /win/.test(c ? c : b), e = /mac/.test(c ? c : b), f = /webkit/.test(b) ? parseFloat(b.replace(/^.*webkit\/(\d+(\.\d+)?).*$/, "$1")) : !1, g = !1, h = [0, 0, 0], i = null;
            if (typeof L.plugins != C && typeof L.plugins[E] == D)
                i = L.plugins[E].description, !i || typeof L.mimeTypes != C && L.mimeTypes[G] && !L.mimeTypes[G].enabledPlugin || (M = !0, g = !1, i = i.replace(/^.*\s+(\S+\s+\S+$)/, "$1"), h[0] = parseInt(i.replace(/^(.*)\..*$/, "$1"), 10), h[1] = parseInt(i.replace(/^.*\.(.*)\s.*$/, "$1"), 10), h[2] = /[a-zA-Z]/.test(i) ? parseInt(i.replace(/^.*[a-zA-Z]+(.*)$/, "$1"), 10) : 0);
            else if (typeof J.ActiveXObject != C)
                try {
                    var j = new ActiveXObject(F);
                    j && (i = j.GetVariable("$version"), i && (g = !0, i = i.split(" ")[1].split(","), h = [parseInt(i[0], 10), parseInt(i[1], 10), parseInt(i[2], 10)]))
                } catch (k) {
                }
            return {w3: a,pv: h,wk: f,ie: g,win: d,mac: e}
        }();
        !function() {
            U.w3 && ((typeof K.readyState != C && "complete" == K.readyState || typeof K.readyState == C && (K.getElementsByTagName("body")[0] || K.body)) && a(), R || (typeof K.addEventListener != C && K.addEventListener("DOMContentLoaded", a, !1), U.ie && U.win && (K.attachEvent(I, function() {
                "complete" == K.readyState && (K.detachEvent(I, arguments.callee), a())
            }), J == top && !function() {
                if (!R) {
                    try {
                        K.documentElement.doScroll("left")
                    } catch (b) {
                        return void setTimeout(arguments.callee, 0)
                    }
                    a()
                }
            }()), U.wk && !function() {
                return R ? void 0 : /loaded|complete/.test(K.readyState) ? void a() : void setTimeout(arguments.callee, 0)
            }(), c(a)))
        }(), function() {
            U.ie && U.win && window.attachEvent("onunload", function() {
                for (var a = Q.length, b = 0; a > b; b++)
                    Q[b][0].detachEvent(Q[b][1], Q[b][2]);
                for (var c = P.length, d = 0; c > d; d++)
                    n(P[d]);
                for (var e in U)
                    U[e] = null;
                U = null;
                for (var f in swfobject)
                    swfobject[f] = null;
                swfobject = null
            })
        }()
    }
    return {registerObject: function(a, b, c, d) {
        if (U.w3 && a && b) {
            var e = {};
            e.id = a, e.swfVersion = b, e.expressInstall = c, e.callbackFn = d, O[O.length] = e, u(a, !1)
        } else
            d && d({success: !1,id: a})
    },getObjectById: function(a) {
        return U.w3 ? g(a) : void 0
    },embedSWF: function(a, c, d, e, f, g, j, k, m, n) {
        var o = {success: !1,id: c};
        U.w3 && !(U.wk && U.wk < 312) && a && c && d && e && f ? (u(c, !1), b(function() {
            d += "", e += "";
            var b = {};
            if (m && typeof m === D)
                for (var p in m)
                    b[p] = m[p];
            b.data = a, b.width = d, b.height = e;
            var q = {};
            if (k && typeof k === D)
                for (var r in k)
                    q[r] = k[r];
            if (j && typeof j === D)
                for (var t in j)
                    typeof q.flashvars != C ? q.flashvars += "&" + t + "=" + j[t] : q.flashvars = t + "=" + j[t];
            if (s(f)) {
                var v = l(b, q, c);
                b.id == c && u(c, !0), o.success = !0, o.ref = v
            } else {
                if (g && h())
                    return b.data = g, void i(b, q, c, n);
                u(c, !0)
            }
            n && n(o)
        })) : n && n(o)
    },switchOffAutoHideShow: function() {
        T = !1
    },ua: U,getFlashPlayerVersion: function() {
        return {major: U.pv[0],minor: U.pv[1],release: U.pv[2]}
    },hasFlashPlayerVersion: s,createSWF: function(a, b, c) {
        return U.w3 ? l(a, b, c) : void 0
    },showExpressInstall: function(a, b, c, d) {
        U.w3 && h() && i(a, b, c, d)
    },removeSWF: function(a) {
        U.w3 && n(a)
    },createCSS: function(a, b, c, d) {
        U.w3 && t(a, b, c, d)
    },addDomLoadEvent: b,addLoadEvent: c,getQueryParamValue: function(a) {
        var b = K.location.search || K.location.hash;
        if (b) {
            if (/\?/.test(b) && (b = b.split("?")[1]), null == a)
                return v(b);
            for (var c = b.split("&"), d = 0; d < c.length; d++)
                if (c[d].substring(0, c[d].indexOf("=")) == a)
                    return v(c[d].substring(c[d].indexOf("=") + 1))
        }
        return ""
    },expressInstallCallback: function() {
        if (S) {
            var a = p(H);
            a && w && (a.parentNode.replaceChild(w, a), x && (u(x, !0), U.ie && U.win && (w.style.display = "block")), y && y(z)), S = !1
        }
    }}
}();
libdom = {markAsNotInLibrary: function(a) {
    $(".song[data-id=" + a + "]").addClass("not-in-library").removeClass("in-library")
},markAsInLibrary: function(a) {
    var b = $(".song[data-id=" + a + "]");
    b.removeClass("not-in-library").addClass("in-library")
},addSongsToPlaylistLocal: function(a, b) {
    oneTune.playlists();
    oneTune.playlists(_.map(oneTune.playlists(), function(c) {
        return c.url == a && _.each(b, function(a) {
            c.tracks.push(a + "")
        }), c
    }))
},removeSongsFromPlaylistLocal: function(a, b) {
    oneTune.playlists();
    oneTune.playlists(_.map(oneTune.playlists(), function(c) {
        return c.url == a && _.each(b, function(a) {
            c.tracks = _.without(c.tracks, a + "")
        }), c
    }))
}}, library = {ajaxResponse: function(a) {
    console.log(a), a.success && ("multiple-playlist-songs-added" == a.socket && onMultiplePlaylistSongsAdded(a.socket_body), "tracks-added" == a.socket && onTracksAdded(a.socket_body), "multiple-playlist-songs-removed" == a.socket && ("/library" == a.socket_body.destination ? onTracksRemoved(a.socket_body) : onPlaylistTracksRemoved(a.socket_body), notifications.create("Removal successful."))), "notification" == a.socket && onNotification({html: a.socket_body}), library.checkForNotifications(a)
},add: function(a) {
    var b = {destination: "library",tracks: [a.id + ""],token: chinchilla.token,type: "library"};
    $.ajax({url: "/api/add_tracks",dataType: "json",data: b,success: library.ajaxResponse}), libdom.markAsInLibrary(a.id + ""), notifications.create("Adding..."), $("#nowplaying-heart").attr("data-id") == a.id + "" && $("#nowplaying-heart-container").attr("class", "in-library"), $(".library-button").text("Remove from library").removeClass("library-button").addClass("library-remove-button")
},batchAdd: function(a) {
    var b = {destination: "library",tracks: _.pluck(a, "id"),token: chinchilla.token,type: "library"};
    $.ajax({url: "/api/add_tracks",dataType: "json",data: b,success: library.ajaxResponse}), notifications.create("Adding..."), _.each(a, function(a) {
        libdom.markAsInLibrary(a.id + "")
    })
},addMultipleByIdList: function(a) {
    library.batchAdd(_.map(a, function(a) {
        return {id: a}
    }))
},remove: function(a) {
    $.ajax({url: "/api/remove_tracks",dataType: "json",data: {tracks: [a.id],type: "library",destination: "library",token: chinchilla.token,date: Date.now()},success: library.ajaxResponse}), libdom.markAsNotInLibrary(a.id + ""), notifications.create("Removing..."), $(".library-remove-button").text("Add to library").removeClass("library-remove-button").addClass("library-button"), $("#nowplaying-heart").attr("data-id") + "" == a.id + "" && $("#nowplaying-heart-container").attr("class", "not-in-library");
    $('#view[data-route="/library"] .song[data-id="' + a.id + '"]').remove()
},removeMultiple: function(a, b, c) {
    $.ajax({url: "/api/remove_tracks",dataType: "json",data: {tracks: a,type: b,destination: c,token: chinchilla.token,date: Date.now()},success: library.ajaxResponse}), notifications.create("Removing..."), _.each(a, function(a) {
        "/library" == c && (libdom.markAsNotInLibrary(a + ""), $("#nowplaying-heart").attr("data-id") + "" == a + "" && $("#nowplaying-heart-container").attr("class", "not-in-library"));
        $('#view[data-route="' + c + '"] .song[data-id="' + a + '"]').remove()
    })
},checkForNotifications: function(a) {
    a["create-notification"] && notifications.create(a["create-notification"])
}}, playlist = {add: function(a, b) {
    var c = {destination: b,tracks: [a.id + ""],token: chinchilla.token,type: "playlist"};
    $.ajax({url: "/api/add_tracks",dataType: "json",data: c,success: library.ajaxResponse}), notifications.create("Adding...")
},reorder: function(a, b) {
    notifications.create("Reordering..."), $.ajax({url: "/api/playlists/reorder",dataType: "json",data: {token: chinchilla.token,url: a,new_order: b},success: function(c) {
        c.success ? (oneTune.playlists(_.map(oneTune.playlists(), function(c) {
            return c.url == a && (c.newestattop && (b = b.reverse()), c.tracks = b), c
        })), notifications.create("Reordering successful.")) : notifications.create("Reordering failed.")
    }})
}}, collections = {add: function(a, b) {
    "/library" == a ? library.add({id: b}) : "/u/" == a.substr(0, 3) && playlist.add({id: b}, a)
}};
var select = function(a) {
    if (a.shiftKey)
        return void shiftSelect(this);
    if (a.ctrlKey || a.metaKey)
        return void cmdSelect(this);
    var b = a.srcElement || a.target;
    if (!$(b).hasClass("heart") && void 0 == $(b).data("navigate")) {
        if ($(this).hasClass("selected") && (0 == a.button || document.getElementsByClassName("selected").length < 2)) {
            var c = $(".song.selected").not(this), d = $(this);
            return $(document).one("mouseup", function() {
                d.addClass("selected"), $(c).removeClass("selected")
            }), void dragsongs(a)
        }
        if (0 == a.button || document.getElementsByClassName("selected").length < 2) {
            var c = $(".song.selected").not(this);
            $(this).addClass("selected"), $(c).removeClass("selected"), dragsongs(a)
        }
    }
}, dragsongs = function(a) {
    var b = {x: a.clientX,y: a.clientY}, c = _.map($(".selected"), function(a) {
        return $(a).data()
    }), d = $(".playlistmenuitem, .librarymenuitem, .playlist-editable tr.song");
    $("#draglabel").text(1 == c.length ? c[0].name + " - " + c[0].artist : c.length + " tracks"), document.body.style.cursor = "default", $(document).on("mousemove", function(a) {
        var c = Math.sqrt(Math.pow(Math.abs(a.clientX - b.x), 2) + Math.pow(Math.abs(a.clientY - b.y), 2));
        c > 20 && $("#draglabel").css({top: a.clientY - 30,left: a.clientX + 10}).show()
    }), d.on("mouseenter", function() {
        if (!$(this).is(".selected")) {
            if ($(this).addClass("droppableindicator"), $(this).is("tr.song")) {
                var a = $("tr.song"), b = a.index($(".selected")[0]), c = a.index(this);
                c > b && $(this).addClass("droppable-bottom")
            }
            $(this).one("mouseleave", function() {
                $(this).removeClass("droppableindicator droppable-bottom")
            })
        }
    }), d.one("mouseup", function() {
        var a = $(this).is(".droppable-bottom");
        if ($(this).removeClass("droppableindicator droppable-bottom"), $(this).is(".song")) {
            if ($(this).is(".selected"))
                return;
            $(".selected")[a ? "insertAfter" : "insertBefore"](this);
            var b = _.map($(".playlist-editable tr.song"), function(a) {
                return $(a).data("id")
            });
            return void playlist.reorder($(this).parents("[data-represents]").attr("data-represents"), b)
        }
        var d = $(this).attr("data-navigate"), e = {token: chinchilla.token,tracks: _.pluck(c, "id"),destination: "/library" == d ? "library" : d,type: "/library" == d ? "library" : "playlist"};
        $.ajax({url: "/api/add_tracks",dataType: "json",data: e,success: library.ajaxResponse})
    }), $(document).one("mouseup", function() {
        $(document).off("mousemove"), $("#draglabel").hide(), d.off("mouseenter mouseup")
    })
};
window.playSong = function(a) {
    $.publish("radio-disabled"), $(a.srcElement || a.target).hasClass("heart") || convertDOMToQueue(this)
};
var convertDOMToQueue = function(a, b, c) {
    var d = $(a).parents("[data-represents]");
    c && d.parents("[data-represents]").length > 0 && (d = d.parents("[data-represents]"));
    var e = d.data("represents"), f = "[data-represents='" + e + "'] .song", g = $(f).slice(0, $(f).index(a)), h = $(f).slice($(f).index(a) + 1);
    b && (g = Array.prototype.slice.call(g), h = Array.prototype.slice.call(h), h = h.concat(g), h = _.shuffle(h), g = []);
    var i = represents_label(a, e), j = new Queue(i, e);
    j.setCurrent(a), j.queue = _.map(h, helpers.parseDOM), j.queue = j.queue.concat(_.map(g, helpers.parseDOM)), player.queues.newQueue(j), player.playQueue()
}, represents_label = function(a, b) {
    if (!b)
        return "/";
    if ("/library" == b)
        return "Library";
    if ("/charts" == b)
        return "Charts";
    if ("/genres" == b)
        return "Reddit";
    var c = helpers.parseDOM(a);
    return "/artist/" == b.substr(0, 8) ? c.artist : "/album/" == b.substr(0, 7) ? c.album : "/song/" == b.substr(0, 6) ? c.name : "/time-machine/" == b.substr(0, 14) ? "Time machine to " + b.substr(14) : "/r/" == b.substr(0, 3) ? "Reddit: " + b.substr(3) : "/one/" == b.substr(0, 5) ? b.substr(5) : _s.contains(b, "/u/") && _s.contains(b, "/p/") ? _.filter(oneTune.playlists(), function(a) {
        return a.url == b
    })[0].name : void 0
}, shiftSelect = function(a) {
    var b = $(a), c = b.prevAll(".selected")[0], d = b.nextAll(".selected")[0];
    void 0 !== c && b.prevUntil(c, ".song").andSelf().addClass("selected"), void 0 !== d && b.nextUntil(d, ".song").andSelf().addClass("selected")
}, cmdSelect = function(a) {
    $(a).toggleClass("selected")
}, dragSeek = function() {
    var a = 224;
    player.automaticseekblocked = !0;
    var b = function(b) {
        var c = b.pageX - $(document).width() + 225;
        $("#seek-progress").css("width", c / a * 100 + "%")
    };
    $(document).on("mousemove", b), $(document).one("mouseup", function(b) {
        $(document).off("mousemove");
        var c = b.pageX - $(document).width() + 225;
        if (c > 224)
            var c = 224;
        player.seek(c / a * ytplayer.getDuration()), player.automaticseekblocked = !1
    })
}, resume = function() {
    player.play()
}, pause = function() {
    player.pause()
}, skip = function() {
    if ($(this).hasClass("radio-skip") && $.publish("radio-enabled"), chinchilla.radio_mode) {
        var a = JSON.parse(localStorage.radio), b = a[localStorage.current_radio];
        if (0 == b.queue.length && !$(".album-slider").hasClass("load-tracks"))
            return $(".album-slider").addClass("load-tracks"), void (chinchilla.play_next_radio_track_instantly = !0);
        var c = b.current, d = b.queue.shift();
        if (b.current = d, b.history.push(c), b.history = _.last(b.history, 5), a[localStorage.current_radio] = b, !c)
            return;
        localStorage.radio = JSON.stringify(a), radio.addBox(b.current), player.playSong(d), 0 != b.queue.length || $(".album-slider").hasClass("load-tracks") || $(".album-slider").addClass("load-tracks");
        var e = $(".radio-album-covers .radio-box");
        e.size() > 5 && e.last().remove()
    } else
        player.playNext()
}, rewind = function() {
    player.playLast()
}, tooltip = function() {
    var a = this;
    if (!chinchilla.radio_mode) {
        var b = $("<div>", {"class": "tooltip"}).css({top: $(a).offset().top + $(a).height() - 75,right: $(document).width() - $(a).offset().left - 20}).html($(a).attr("data-tooltip")).appendTo("body");
        $(a).mouseout(function() {
            $(b).remove()
        })
    }
}, autocomplete = function(a) {
    37 != a.keyCode && 38 != a.keyCode && 39 != a.keyCode && 40 != a.keyCode && 13 != a.keyCode && 16 != a.keyCode && setTimeout(function() {
        var a = $("#search-field"), b = a.val(), c = ($("#search-results"), $("#clear-input"));
        if (window.lastsearchtimestamp) {
            var d = Date.now();
            window.lastsearchtimestamp = d, setTimeout(function() {
                d == window.lastsearchtimestamp && search.autocomplete(b)
            }, 500)
        } else
            window.lastsearchtimestamp = Date.now();
        "" === b ? ($(".search-placeholder").show(), $("#search-results-wrapper").empty(), c.hide()) : c.show()
    }, 1)
}, addtrack = function(a) {
    if (37 != a.keyCode && 38 != a.keyCode && 39 != a.keyCode && 40 != a.keyCode && 13 != a.keyCode && 16 != a.keyCode) {
        var b = $(".add-tracks-input"), c = b.val(), d = $(".add-tracks-results");
        "" == c ? d.hide() : d.show();
        var e = Date.now();
        window.lastsearchtimestamp = e, setTimeout(function() {
            e == window.lastsearchtimestamp && addtracks.autocomplete(c)
        }, 100)
    }
}, logout = function() {
    for (var a = document.cookie.split(";"), b = 0; b < a.length; b++) {
        var c = a[b], d = c.indexOf("="), e = d > -1 ? c.substr(0, d) : c;
        document.cookie = e + "=;expires=Thu, 01 Jan 1970 00:00:00 GMT"
    }
    window.location.reload()
}, addtolib = function() {
    if (console.log($(this).attr("data-id")), $(this).attr("data-id"))
        return void library.add({id: $(this).attr("data-id") + ""});
    if ($(this).hasClass("song") || $(this).hasClass("library-button"))
        var a = this;
    else
        var a = $(this).parents(".song")[0];
    var b = helpers.parseDOM(a);
    library.add(b)
}, remfromlib = function() {
    if ($(this).attr("data-id"))
        return void library.remove({id: $(this).attr("data-id") + ""});
    if ($(this).hasClass("song") || $(this).hasClass("library-remove-button"))
        var a = this;
    else
        var a = $(this).parents(".song")[0];
    var b = helpers.parseDOM(a);
    library.remove(b)
}, clearinput = function() {
    $("#search-field").val("").keyup().focus(), $(".search-placeholder").show(), $("#search-results-wrapper").empty(), $("#clear-input").hide(), window.lastsearchtimestamp = null
}, rightclick = function(a) {
    a.preventDefault();
    var b = {song: helpers.parseDOM(a.currentTarget),e: a,left: a.pageX};
    $(".selected").size() > 1 && (delete b.song, b.tracklist = _.map($(".selected").toArray(), function(a) {
        return $(a).attr("data-id")
    })), contextmenu(b)
}, playlistmenu = function(a) {
    a.preventDefault();
    var b = {e: a,left: a.pageX,playlist: a.currentTarget};
    contextmenu(b)
}, contextmenu = function(a) {
    $(".contextmenu").remove();
    var b = a.song ? "#view" : "#sidebar", c = ($(b)[0].scrollHeight, $(document).height()), d = $(document).width(), e = {top: a.e.pageY,left: a.left,bottom: c - a.e.pageY,right: d - a.left}, f = a.e.pageY < c / 2 ? e.top : e.bottom, g = a.e.pageX < d / 2 ? e.left : e.right, h = a.e.pageY < c / 2 ? "top" : "bottom", i = a.e.pageX < d / 2 ? "left" : "right", j = $("<div>", {"class": "contextmenu"}).css(i, g).css(h, f);
    if ($(b).append(j), a.song) {
        var k = $(a.e.currentTarget).parents("[data-represents]").data("represents");
        $(document).one("click", ".contextmenu-add-to-playlist", function(a) {
            $(this).parents(".context-options").html(loader.spinner()), a.stopPropagation(), $.ajax({url: "/api/playlist-dialogue",data: {song: $(this).attr("data-id") + "",token: chinchilla.token},dataType: "html",success: function(a) {
                $(".context-options").html(a)
            }})
        });
        var l = a.song, m = templates.buildSongContextMenu({song: l,inlib: _.contains(oneTune.library(), l.id + ""),loggedin: chinchilla.loggedin,represents: k});
        j.html(m)
    } else if (a.playlist) {
        var n = $(a.playlist).attr("data-navigate");
        $.ajax({url: "/api/playlist-menu",data: {playlist: n,token: chinchilla.token},dataType: "html",success: function(a) {
            j.addClass("playlist-contextmenu"), j.html(a)
        }})
    } else if (a.tracklist) {
        var k = $(a.e.currentTarget).parents("[data-represents]").data("represents");
        j.html(templates.buildMultipleSongContextMenu({songs: a.tracklist,loggedin: chinchilla.loggedin,represents: k}))
    }
    $(document).one("click", function() {
        j.remove()
    })
}, setchange = function() {
    var a = $(".settings .setting"), b = [];
    $.each(a, function(a, c) {
        var c = {key: $(c).data("setting"),label: $(c).find("label").text(),value: $(c).find("input").is(":checked")};
        b.push(c), chinchilla.settings[c.key] = c.value
    }), $.ajax({url: "/api/settings/update",data: {settings: b,token: chinchilla.token},dataType: "json",success: function(a) {
        a.success && notifications.create("Settings saved.")
    }}), notifications.create("Saving...")
}, ordersongs = function() {
    var a, b = $(this);
    b.hasClass("ascending") ? (b.addClass("descending"), b.removeClass("ascending"), a = "desc") : b.hasClass("descending") ? (b.removeClass("descending"), a = "default") : (b.addClass("ascending"), a = "asc"), $(b).siblings("[data-order]").removeClass("ascending descending");
    {
        var c = "default" == a ? "index" : b.attr("data-value"), d = b.parents(".table-wrapper").eq(0).find("table"), e = $(d).find(".song"), f = _.sortBy(e, function(a) {
            var b = $(a).data(c);
            return isNaN(b) ? b : parseFloat(b)
        });
        "desc" == a ? f.reverse() : f
    }
    html = "", console.log(d), e.remove(), $.each(f, function(a, b) {
        d.append(b)
    })
}, findindom = function(a) {
    var b = $(a).parents("[data-represents]"), c = $(a).attr("data-id");
    return $(b).find(".song[data-id=" + c + "]").eq(0)[0]
}, findandplay = function() {
    var a = $('.song[data-id="' + $(this).data("id") + '"]'), b = helpers.parseDOM(a[0]), c = player.nowPlaying.get();
    c && c.id + "" == b.id + "" ? player.togglePlayState() : a.dblclick()
}, playbutton = function(a) {
    var b = helpers.parseDOM(a), c = player.nowPlaying.get();
    if (c && b.id + "" == c.id + "") {
        var d = ytplayer.getPlayerState();
        1 == d ? ytplayer.pauseVideo() : (ytplayer.playVideo(), $(".now-playing").addClass("hearable"), oneTune.hearable(!0))
    } else
        convertDOMToQueue(a), $(".now-playing").addClass("hearable"), oneTune.hearable(!0)
}, findandqueue = function() {
    var a = _.pluck(player.queues.queue, "duration"), b = _.reduce(a, function(a, b) {
        return a + parseFloat(b)
    }, 0), c = ytplayer.getCurrentTime(), d = ytplayer.getDuration();
    untilplayed = b + 1e3 * d - 1e3 * c, label = helpers.parsehours(untilplayed), song = helpers.parseDOM($('.song[data-id="' + $(this).data("id") + '"]')[0]), player.queues.primaryQueue.push(song), $.publish("queue-changed"), notifications.create(song.name + " was added to the queue. It will be played in " + label + "."), updateHints()
}, addalbumtolib = function() {
    var a = $(this).parents(".album"), b = a.find(".song.recognized"), c = [];
    $.each(b, function(a, b) {
        c.push(helpers.parseDOM(b))
    }), library.batchAdd(c)
}, addtrackskeys = function(a) {
    var b = "add-tracks-selected";
    if (13 == a)
        $("." + b).click();
    else {
        var c = $("." + b), d = 38 == a ? "prev" : "next", e = c[d]("span");
        0 != e.length && ($(e).addClass(b), $(c).removeClass(b))
    }
}, searchkeys = function(a) {
    var b = "search-selected";
    if (13 == a && $("#search-results").hasClass("search-results-visible"))
        $("." + b).mousedown().click();
    else {
        var c = $("." + b), d = 38 == a ? "prevAll" : "nextAll", e = c[d]("li");
        0 != e.length && ($(e[0]).addClass(b), $(c).removeClass(b))
    }
}, keysdown = function(a) {
    var b = a.keyCode;
    if (70 == b && a.metaKey && window.location.pathname.match("/p/"))
        return a.preventDefault(), void showfilter();
    if (27 == b && ($(".pl-v3-filter").hide(), $(".add-menu-visible").removeClass("add-menu-visible"), $(".more-menu-visible").removeClass("more-menu-visible")), 40 == b || 38 == b) {
        if (a.preventDefault(), a.stopPropagation(), $("input:focus").length > 0)
            return void ($("#search-field").is(":focus") && searchkeys(b));
        var c = $(".song.selected"), d = 40 == b ? "next" : "prev", e = c[d](".song").addClass("selected");
        a.shiftKey || 0 == e.length || c.removeClass("selected")
    }
}, keys = function(a) {
    var b = a.keyCode, c = a.srcElement || a.target;
    if (!($(c).is("input") || $(c).is("[contenteditable]") || $(c).is("textarea")) || !($(c).is(".add-tracks-input") || $(c).is("#search-field") || $(c).is(".pl-label") || $(c).is(".new-playlist-input-field") || $(c).is(".edit-metadata-input") || $(c).is(".register-input") || $(c).is("textarea")) || 13 == b) {
        if (a.preventDefault(), 13 == b) {
            if ($(".add-tracks-dropdown").is(":visible"))
                return void addtrackskeys(b);
            if ($("#search-results").is(":visible"))
                return a.preventDefault(), void searchkeys(b);
            $(".compose-suggestions").is(":visible") && (a.preventDefault(), submit.selectSong($(".add-tracks-selected").eq(0).data()));
            {
                $(".song.selected").click()
            }
        }
        39 == b && player.playNext(), 37 == b && player.playLast(), 32 == b && ($("input").is(":focus") || player.togglePlayState())
    }
}, hidenotification = function() {
    $(this).parents(".notification").remove()
}, warnexit = function() {
    return chinchilla.loggedin && chinchilla.settings.warn_before_leave ? "You are leaving the page but the music is still playing. Do you really want to leave? (You can turn this notification off in the settings)" : void 0
}, showalbum = function() {
    $(this).hide().next(".hidden-album-container").show()
}, newplaylist = function() {
    $(".new-playlist-input").show().find("input").val("").focus(), $("html").one("click", function() {
        $(".new-playlist-input").hide().off(), $(".new-playlist-input-field").off()
    }), $(".new-playlist-input").on("click", function(a) {
        a.stopPropagation()
    }), $(".new-playlist-input-field").on("keypress", submitplaylist)
}, submitplaylist = function(a) {
    if (13 == a.keyCode) {
        var b = $(".new-playlist-input-field"), c = b.val();
        b.off(), $.ajax({url: "/api/playlists/create",dataType: "json",data: {name: c,token: chinchilla.token},success: function(a) {
            a.success ? "playlist-added" == a.socket && pladded(a.socket_body) : "playlist-addition-failed" == a.socket && pladdfail(a.socket_body)
        }})
    }
}, renameplaylistinline = function() {
    function a(a) {
        var b = document.createRange();
        b.selectNodeContents(a);
        var c = window.getSelection();
        c.removeAllRanges(), c.addRange(b)
    }
    $(".playlist-more-menu").removeClass("more-menu-visible");
    var b = $("#view").attr("data-route"), c = $("#view h1"), d = c.text();
    c.addClass("edit-mode").attr("contenteditable", !0).focus(), c.on("keypress", function(a) {
        13 == a.keyCode && ($(this).off().removeAttr("contenteditable").removeClass("edit-mode"), $("body").off(), $.ajax({url: "/api/playlists/rename",data: {oldname: b,newname: $(c).text(),token: chinchilla.token},dataType: "json",success: function(a) {
            a.success ? (console.log(a.socket), "playlist-renamed" == a.socket && plrenamed(a.socket_body)) : "playlist-renamed-failed" == a.socket && pladdfail(a.socket_body)
        }}))
    }), $("body").one("click", function() {
        $(c).off().removeAttr("contenteditable").removeClass("edit-mode"), $(c).text(d)
    }), a($(c)[0])
}, renameplaylist = function() {
    function a(a) {
        var b = document.createRange();
        b.selectNodeContents(a);
        var c = window.getSelection();
        c.removeAllRanges(), c.addRange(b)
    }
    var b = $(this).data("id"), c = $(this).data("name"), d = $('#sidebar [data-navigate="' + b + '"]'), e = d.find(".pl-label").attr("contenteditable", !0).focus();
    $(e).on("keypress", function(a) {
        13 == a.keyCode && ($(e).off().removeAttr("contenteditable"), $("body").off(), $.ajax({url: "/api/playlists/rename",data: {oldname: b,newname: $(e).text(),token: chinchilla.token},dataType: "json",success: function(a) {
            a.success ? (console.log(a.socket), "playlist-renamed" == a.socket && plrenamed(a.socket_body)) : "playlist-renamed-failed" == a.socket && pladdfail(a.socket_body)
        }}))
    }), a($(e)[0]), $("body").one("click", function() {
        $(e).off().removeAttr("contenteditable"), $(e).text(c)
    }), $(e).on("click", function(a) {
        a.stopPropagation()
    })
}, deleteplaylist = function(a) {
    if (!a)
        var a = $(this).data("id");
    $('#sidebar [data-navigate="' + a + '"]');
    $.ajax({url: "/api/playlists/delete",dataType: "json",data: {url: a,token: chinchilla.token},success: function(a) {
        a.success && "playlist-removed" == a.socket && plremoved(a.socket_body)
    }})
}, suppressrenaming = function(a) {
    a.stopPropagation()
}, addsongtopl = function() {
    var a = $(this).data(), b = {type: "playlist",tracks: [a.songid],token: chinchilla.token,destination: a.url,type: "playlist"};
    $.ajax({url: "/api/add_tracks",dataType: "json",data: b,success: library.ajaxResponse}), notifications.create("Adding...")
}, remsongfrompl = function() {
    var a = $(this).data();
    library.removeMultiple([a.songid], "playlist", a.url)
}, pldropdown = function() {
    $.ajax({url: "/api/pl-options",dataType: "html",data: {playlist: $("#view").attr("data-route"),token: chinchilla.token},success: function(a) {
        $(".playlist-options-dropdown").html(a)
    }})
}, mkplpublic = function() {
    notifications.create("Change privacy...");
    var a = $(this).attr("data-url");
    $.ajax({url: "/api/playlists/privacy",dataType: "json",data: {playlist: a,token: chinchilla.token,"public": !0,date: Date.now()},success: function(b) {
        b.success && (oneTune.playlists(_.map(oneTune.playlists(), function(b) {
            return b.url == a && (b["public"] = !0), b
        })), $(".publish-playlist").removeClass("publish-playlist").addClass("unpublish-playlist").find("span").text("Unpublish playlist"), notifications.create("Playlist published."))
    }})
}, mkplprivate = function() {
    notifications.create("Change privacy...");
    var a = $(this).attr("data-url");
    $.ajax({url: "/api/playlists/privacy",dataType: "json",data: {playlist: a,token: chinchilla.token,"public": !1,date: Date.now()},success: function(b) {
        b.success && (oneTune.playlists(_.map(oneTune.playlists(), function(b) {
            return b.url == a && (b["public"] = !1), b
        })), $(".unpublish-playlist").removeClass("unpublish-playlist").addClass("publish-playlist").find("span").text("Publish playlist"), notifications.create("Playlist unpublished."))
    }})
}, followplaylist = function() {
    notifications.create("Following...");
    var a = $(this).attr("data-url");
    $.ajax({url: "/api/playlists/follow",dataType: "json",data: {url: a,token: chinchilla.token,follow: !0,date: Date.now()},success: function(b) {
        if (b.success) {
            var c = $(".follow-playlist").removeClass("follow-playlist").addClass("unfollow-playlist").addClass("action-just-happened");
            if (c.find("span").text("Unfollow playlist"), c.find("img").removeClass("png-icon-unsave").addClass("png-icon-save"), $(c).one("mouseleave", function() {
                    $(c).removeClass("action-just-happened")
                }), notifications.create("You are now following this playlist."), oneTune.playlists(_.reject(oneTune.playlists(), function(b) {
                    return b.url == a
                })), oneTune.playlists.push(b.playlist), 0 == $(".followed-playlists").size()) {
                var d = $("<div>").addClass("followed-playlists");
                d.html(b.menuitem), $(".playlists-menu").after(d), $(".playlists-menu").after($('<h2 class="followed-playlist-h2">').text("Followed playlists"))
            } else
                $(".followed-playlists").append(b.menuitem);
            var e = parseInt($(".playlist-followercount").text());
            e++, $(".playlist-followercount").text(1 == e ? "1 follower" : e + " followers")
        } else
            notifications.create(b.notification)
    }})
}, unfollowplaylist = function() {
    notifications.create("Unfollowing...");
    var a = $(this).attr("data-url");
    $.ajax({url: "/api/playlists/follow",dataType: "json",data: {url: a,token: chinchilla.token,follow: !1},success: function(b) {
        if (b.success) {
            var c = $(".unfollow-playlist").removeClass("unfollow-playlist").addClass("follow-playlist").addClass("action-just-happened");
            c.find("span").text("Follow playlist"), c.find("img").removeClass("png-icon-save").addClass("png-icon-unsave"), $(c).one("mouseleave", function() {
                $(c).removeClass("action-just-happened")
            }), notifications.create("You have unfollowed this playlist."), oneTune.playlists(_.reject(oneTune.playlists(), function(b) {
                return b.url == a
            })), $('.followed-playlist-h2,.followed-playlists [data-navigate="' + a + '"]').remove();
            var d = parseInt($(".playlist-followercount").text());
            d--, $(".playlist-followercount").text(1 == d ? "1 follower" : d + " followers")
        } else
            notifications.create(b.notification)
    }})
}, mkplnwattop = function() {
    $(".make-playlist-newest-at-top").removeClass("dropdown-no-check").addClass("dropdown-check"), $(".make-playlist-newest-at-bottom").addClass("dropdown-no-check").removeClass("dropdown-check");
    {
        var a = $("#view").attr("data-route");
        $(".playlist-privacy")
    }
    $.ajax({url: "/api/playlists/order",dataType: "html",data: {playlist: a,token: chinchilla.token,newestattop: !0}}), oneTune.playlists(_.map(oneTune.playlists(), function(b) {
        return b.url == a && (b.newestattop = !0), b
    }))
}, mkplnwatbottom = function() {
    $(".make-playlist-newest-at-top").addClass("dropdown-no-check").removeClass("dropdown-check"), $(".make-playlist-newest-at-bottom").removeClass("dropdown-no-check").addClass("dropdown-check");
    {
        var a = $("#view").attr("data-route");
        $(".playlist-privacy")
    }
    $.ajax({url: "/api/playlists/order",dataType: "html",data: {playlist: a,token: chinchilla.token,newestattop: !1}}), oneTune.playlists(_.map(oneTune.playlists(), function(b) {
        return b.url == a && (b.newestattop = !1), console.log(b, a), b
    }))
}, closenotification = function() {
    $("#statusbar").hide()
}, playallsongs = function() {
    var a = $(this).parents("[data-represents]").find(".song"), b = a[Math.floor(Math.random() * a.length)];
    convertDOMToQueue(b, !0, !0)
}, playallsongsinorder = function() {
    var a = $($(this).parents("[data-represents]")[0]).find(".song").eq(0)[0];
    convertDOMToQueue(a)
}, playviewinorder = function() {
    var a = $("#view").find("[data-represents]").find(".song").eq(0)[0];
    convertDOMToQueue(a)
}, hoversearchresult = function() {
    var a = "search-selected";
    $("." + a).removeClass(a), $(this).addClass(a)
}, filterdropdown = function() {
    var a = $(this).data("list");
    templates.buildFilter({list: a})
}, preventScrolling = function(a) {
    var b = a.keyCode;
    return 38 == b || 40 == b ? !1 : void 0
}, trigger = function() {
    var a = document.querySelector("[data-untrigger]"), b = $(this).data("trigger"), c = function() {
        $(this).attr("data-untrigger", b), $("." + b).show(), $(this).removeAttr("data-trigger")
    };
    void 0 != a ? untrigger.bind(a)(c.bind(this)) : c.bind(this)(), "add-tracks-dropdown" == b && $(".add-tracks-input").focus()
}, untrigger = function(a) {
    var b = $(this).data("untrigger"), c = 0;
    "filter-dropdown" == b && (c = 300, $(".filter-dropdown").find("label").addClass("pop-away")), "add-tracks-dropdown" == b && (c = 300, $(".add-tracks-dropdown").find(".add-tracks-input").addClass("pop-away")), "playlist-import-tip" == b && (c = 300, $(".playlist-import-tip").addClass("pop-away")), setTimeout(function() {
        $("." + b).hide(), $(this).attr("data-trigger", b), _.isFunction(a) && a(), $(".pop-away").removeClass("pop-away")
    }.bind(this), c), $(this).removeAttr("data-untrigger")
}, loadcover = function() {
    $(this).fadeIn().addClass("coverstack-coer-loaded")
}, showYouTubePage = function() {
    $("body").addClass("youtube-player-visible"), $("#view").html(""), $.publish("view-got-loaded")
}, hideYouTubePage = function() {
    $("body").removeClass("youtube-player-visible")
}, showImportPage = function() {
    var a = $("#import-template").html(), b = _.template(a, {importqueue: importqueue,tracktmpl: $("#import-track-template").html(),playlists: oneTune.playlists()});
    $("#view").html(b), $("#playlist-target").val(chinchilla.playlist_target ? chinchilla.playlist_target : "/library"), $.publish("view-got-loaded")
}, startqueue = function() {
    startQueue()
}, stopqueue = function() {
    stopQueue()
}, pltargetchanged = function() {
    chinchilla.playlist_target = this.value
}, startradiosong = function() {
    notifications.create("Creating radio...")
}, radiostation = function() {
    radio.loadIntoDOM({radio_id: $(this).data("id")})
}, jumptorepresents = function() {
    return window.location.pathname == player.queues.current.represents ? ($('[data-represents="' + player.queues.current.represents + '"]').find("h1").addClass("orange-blink"), void setTimeout(function() {
        $(".orange-blink").removeClass("orange-blink")
    }, 2e3)) : void navigation.to(player.queues.current.represents)
}, reportselect = function() {
    $(".report-selected").removeClass("report-selected"), $(this).addClass("report-selected"), player.pause(), $(".report-preview").remove(), $(".report-youtube").html('<iframe width="560" height="315" src="//www.youtube.com/embed/' + $(this).data("reportytid") + '" frameborder="0" allowfullscreen></iframe>'), $(".report-youtube-input").val("http://youtube.com/watch?v=" + $(this).data("reportytid"))
}, reportsubmit = function() {
    $(".report-loading-indicator").show(), $(this).prop("disabled", "true");
    var a = $(this).data("submit"), b = $(".report-youtube-input").val().substr(27, 11);
    $.ajax({url: "/api/report",type: "POST",dataType: "json",data: {song_to_change: a,fields_to_change: {ytid: b},type: "change-video"},success: function(c) {
        $(".report-loading-indicator").hide(), c.success ? DB.putUpdates([{track_id: a,fields_changed: {ytid: b}}], function() {
        }) : $(this).prop("disabled", !1), $(".report-feedback").text(c.socket_body.msg)
    }})
}, searchresult = function() {
    $("#search-results").removeClass("search-results-visible")
}, doubleclickPlaylist = function() {
    $("#view").hasClass("view-loading") ? $.subscribe($("#view").data("route") + "/loaded", function() {
        playviewinorder()
    }) : playviewinorder()
}, prevQueue = function() {
    player.queues.prevQueue()
}, nextQueue = function() {
    player.queues.nextQueue()
}, searchfocused = function() {
    $("#search-results").addClass("search-results-visible")
}, mousedown = function(a) {
    var b = a.srcElement || a.target, c = $(b).parents("#search-results"), d = $(b).parents("#search-field"), e = $(b).is("#search-field") || $(b).is("#clear-input");
    0 != c.length || 0 != d.length || e || $("#search-results").removeClass("search-results-visible")
}, togglewikicollapse = function() {
    $(".wikipedia-description").toggleClass("wiki-collapsed")
}, editmetadata = function() {
    $(".edit-metadata-container").show(), $(".metadata-finished-container").hide()
}, submitmetadata = function() {
    if (!$(".song-page-submit-metadata").hasClass("metadata-submitting")) {
        var a = _.string.escapeHTML($("#edit-metadata-title-input").val()), b = _.string.escapeHTML($("#edit-metadata-artist-input").val()), c = _.string.escapeHTML($("#edit-metadata-album-input").val()), d = $(this).parents("[data-represents]").attr("data-represents").substr(6), e = {song_to_change: d,fields_to_change: {},type: "correct-metadata"};
        "" != a && (e.fields_to_change.name = a), "" != b && (e.fields_to_change.artist = b), "" != c && (e.fields_to_change.album = c), ("" != a || "" != b || "" != c) && ($(".song-page-submit-metadata").text("Saving...").addClass("metadata-submitting"), $.ajax({url: "/api/report",dataType: "json",type: "POST",data: e,success: function(a) {
            return $(".song-page-submit-metadata").removeClass("metadata-submitting"), a.success ? ($(".song-page-submit-metadata").text("Saved!"), notifications.create("Changes saved locally. We'll take a look and apply is globally soon."), DB.putUpdates([{track_id: d,fields_changed: e.fields_to_change}], function() {
            }), $(".edit-metadata-container").hide(), $(".metadata-finished-container").show(), e.fields_to_change.name && $(".song-page-track-title").text(e.fields_to_change.name), e.fields_to_change.artist && $(".song-page-subtitle").text(e.fields_to_change.artist), void $(".song-page-edit-metadata").hide()) : void $(".song-page-submit-metadata").text(a.socket_body.msg)
        }}))
    }
}, playerimgload1 = function() {
    $("#nowplaying-image").css({opacity: 1}), $("#nowplaying-image2").css({opacity: 0})
}, playerimgload2 = function() {
    $("#nowplaying-image2").css({opacity: 1}), $("#nowplaying-image").css({opacity: 0})
}, checkusername = function() {
    $(".username-disable").prop("disabled", !0), "" == $(this).val() ? $(".username-availability-indicator").text("No username entered").removeClass("not-available available") : ($(".username-availability-indicator").text("Checking...").removeClass("not-available available"), $.ajax({url: "/api/register/check-name",data: {username: $(this).val()},dataType: "json",success: function(a) {
        $("#register-username-input").val() == a.query.username && ($(".username-availability-indicator").removeClass("not-available available").addClass(a.exists ? "not-available" : "available").text(a.exists ? "Username taken." : "Username is available!"), $(".username-disable").prop("disabled", a.exists))
    }}))
}, sendusername = function() {
    $(".username-disable").prop("disabled", !0), $(".username-availability-indicator").text("Sending...").removeClass("not-available available"), $.ajax({url: "/api/register/name-chosen",dataType: "json",data: {id: $(this).attr("data-id"),username: $("#register-username-input").val()},success: function(a) {
        document.cookie = "token=" + a.token + "; expires=Fri, 31 Dec 9999 23:59:59 GMT 12:00:00 GMT; path=/", window.location.href = "/"
    }})
}, register = function(a) {
    a.preventDefault();
    var b = $(".register-email").val(), c = $("#register-username-input").val(), d = $(".register-password").val();
    b && c && d ? ($.ajax({url: "/api/register/classic",dataType: "json",data: {email: b,username: c,password: d},success: function(a) {
        a.success ? "register-successful" == a.socket && onRegisterSuccessful(a.socket_body) : "register-failed" == a.socket && onRegisterFailed(a.socket_body)
    }}), $(".username-availability-indicator").text("Sending...").removeClass("not-available available"), $(".username-disable").prop("disabled", !0)) : $(".username-availability-indicator").text("Please fill out all fields.").addClass("not-available").removeClass("available")
}, login = function(a) {
    a.preventDefault();
    var b = $(".login-username").val(), c = $(".login-password").val();
    b && c ? ($.ajax({url: "/api/register/login",data: {username: b,password: c},dataType: "json",type: "POST",success: function(a) {
        a.success ? "login-successful" == a.socket && onLoginSuccessful(a.socket_body) : onLoginFailed(a.socket_body)
    }}), $(".login-submit").prop("disabled", !0).text("Logging in...")) : $(".login-fail-indicator").text("Please fill out both fields.")
}, addmultiple = function() {
    library.addMultipleByIdList($(this).attr("data-ids").split(","))
}, removemultiple = function() {
    library.removeMultiple($(this).attr("data-ids").split(","), "library", "/library")
}, plremovemultiple = function() {
    library.removeMultiple($(this).attr("data-ids").split(","), "playlist", $(this).attr("data-url"))
}, hidevolume = function() {
    $("#volume-control").hide()
}, volumecontrol = function() {
    if ($("#volume-control").is(":visible"))
        hidevolume();
    else {
        {
            ytplayer.getVolume()
        }
        $("#volume-slider-inner").css("height", ytplayer.getVolume() + "%"), $("#volume-control").show(), $(document).one("click", hidevolume)
    }
}, changevolume = function(a) {
    var b = function(a) {
        var b = a.pageY - 255, c = (73 - b) / 73 * 100;
        c > 100 && (c = 100), $("#volume-slider-inner").css("height", c + "%"), ytplayer.setVolume(c)
    };
    b(a), $(document).on("mousemove", b), $(document).one("mouseup", function(a) {
        $(document).off("mousemove"), b(a)
    })
}, playList = function() {
    var a = $(this).parents("[data-represents]"), b = $(a).find(".song")[0];
    convertDOMToQueue(b)
}, changeSubmitSub = function() {
    $(".submit-sub-selected").removeClass("submit-sub-selected"), $(this).addClass("submit-sub-selected")
}, changeSubmitType = function() {
    $(".submit-type-selected").removeClass("submit-type-selected"), $(this).addClass("submit-type-selected");
    var a = $(this).attr("data-type");
    "playlist" == a && submit.buildSubmitPlaylist(), "song" == a && submit.showSong(), "story" == a && submit.showStory()
}, submitcomment = function() {
    var a = $(this).parents(".post-new-comment").eq(0);
    $(a).find(".submit-comment").text("Sending...");
    var b = $(a).find(".new-comment-textarea"), c = {content: b.val(),slug: $(a).attr("data-slug"),token: chinchilla.token}, d = $(a).attr("data-reply-to");
    d && d.length > 0 && (c.reply_to = d), $.ajax({url: "/api/comments/create",data: c,type: "POST",success: function(c) {
        c.success ? (d && d.length > 0 ? (b.val(""), $(a).parents(".comment").eq(0).find(".replies").eq(0).prepend(c.html)) : $(".comment-section").prepend(c.html), $(a).hide(), $(a).find(".submit-comment").text("Send")) : ($(a).find(".comment-error-area").text(c.msg).show(), $(a).find(".submit-comment").text("Send"))
    }})
}, submitpost = function() {
    $(".submit-submit").text("Sending...");
    var a = {sub: $(".submit-sub-selected").text(),entity: $(".submit-type-selected").attr("data-type"),token: chinchilla.token};
    if ("song" == a.entity) {
        var b = $(".submit-song-box").attr("data-id");
        b && (a.id = b)
    }
    if ("playlist" == a.entity) {
        var c = $(".submit-playlist-selected").attr("data-url");
        c && (a.id = c)
    }
    "story" == a.entity && (a.title = $(".submit-post-title").val(), a.content = $(".submit-post-content").val()), $.ajax({url: "/api/community/submit",type: "POST",success: function(a) {
        a.success ? navigation.to("/one/" + a.post.sub + "/" + a.post.slug + "/" + a.post.url) : ($(".submit-submit").text("Send"), $(".one-submit-error").html(a.msg))
    },data: a,dataType: "json"})
}, changeLang = function() {
    var a = $(this).attr("data-lang");
    $.ajax({url: "/api/languages/set",data: {lang: a},dataType: "json",success: function() {
        window.location.reload()
    }})
}, selectAnother = function() {
    $(".song-picker-activator, .song-picker").show(), $(".selected-area").empty(), $(".song-picker-input").val("").focus()
}, upvotePost = function() {
    if (!chinchilla.loggedin)
        return void showLoginPopup("Login to vote on submissions and create your personal library. It's fun!");
    var a = $(this).hasClass("upvoted") ? 0 : 1;
    $.ajax({url: "/api/post/vote",data: {token: chinchilla.token,sub: $(this).attr("data-sub"),slug: $(this).attr("data-slug"),vote: a},dataType: "json"});
    var b = $(this).parents(".vote-module").eq(0);
    b.find(".downvote-post").removeClass("downvoted");
    var c = a - parseInt($(b).attr("data-vote"));
    $(b).attr("data-vote", a), $(this)[a ? "addClass" : "removeClass"]("upvoted");
    var d = $(b).find(".upvote-count");
    d.text(parseInt(d.text()) + c)
}, downvotePost = function() {
    if (!chinchilla.loggedin)
        return void showLoginPopup("Login to vote on submissions and create your personal library. It's fun!");
    var a = $(this).hasClass("downvoted") ? 0 : -1;
    $.ajax({url: "/api/post/vote",data: {token: chinchilla.token,sub: $(this).attr("data-sub"),slug: $(this).attr("data-slug"),vote: a},dataType: "json"});
    var b = $(this).parents(".vote-module").eq(0);
    b.find(".upvote-post").removeClass("upvoted");
    var c = a - parseInt($(b).attr("data-vote"));
    $(b).attr("data-vote", a), $(this)[-1 == a ? "addClass" : "removeClass"]("downvoted");
    var d = $(b).find(".upvote-count");
    d.text(parseInt(d.text()) + c)
}, upvoteComment = function() {
    if (!chinchilla.loggedin)
        return void showLoginPopup("Login to vote on submissions and create your personal library. It's fun!");
    var a = $(this).hasClass("upvoted") ? 0 : 1, b = $(this).parents(".comment").eq(0).attr("data-id");
    $.ajax({url: "/api/comments/vote",type: "POST",data: {token: chinchilla.token,comment: b,vote: a},dataType: "json"});
    var c = $(this).parents(".vote-module").eq(0);
    c.find(".downvote-comment").removeClass("downvoted");
    var d = a - parseInt($(c).attr("data-vote"));
    $(c).attr("data-vote", a), $(this)[a ? "addClass" : "removeClass"]("upvoted");
    var e = $(c).find(".upvote-count");
    e.text(parseInt(e.text()) + d)
}, downvoteComment = function() {
    if (!chinchilla.loggedin)
        return void showLoginPopup("Login to vote on submissions and create your personal library. It's fun!");
    var a = $(this).hasClass("downvoted") ? 0 : -1, b = $(this).parents(".comment").eq(0).attr("data-id");
    $.ajax({url: "/api/comments/vote",type: "POST",data: {token: chinchilla.token,comment: b,vote: a},dataType: "json"});
    var c = $(this).parents(".vote-module").eq(0);
    c.find(".upvote-comment").removeClass("upvoted");
    var d = a - parseInt($(c).attr("data-vote"));
    $(c).attr("data-vote", a), $(this)[-1 == a ? "addClass" : "removeClass"]("downvoted");
    var e = $(c).find(".upvote-count");
    e.text(parseInt(e.text()) + d)
}, selectSubmitPlaylist = function() {
    $(".submit-playlist-selected").removeClass("submit-playlist-selected"), $(this).addClass("submit-playlist-selected")
}, viewScrolled = function() {
    var a = $(this).scrollTop(), b = $(".extendedtable .table-wrapper")[0];
    b && (a > 185 ? b.classList.contains("fixed") || (b.classList.add("fixed"), $(".table-header").css("width", $(".extendedtable").width())) : b.classList.remove("fixed"))
}, showreplyfield = function() {
    $(this).parents(".comment").eq(0).find(".reply-field").eq(0).show().find(".post-new-comment").show()
}, deletecomment = function() {
    var a = $(this).parents(".comment").eq(0), b = $(this).attr("data-id"), c = confirm("Do you want to delete this comment?");
    c && $.ajax({url: "/api/comments/delete",type: "POST",dataType: "json",data: {token: chinchilla.token,comment: b},success: function() {
        a.find(".comment-body").eq(0).html('<p class="deleted_comment">[This comment was deleted.]</p>'), a.find(".comment-submitter").eq(0).empty()
    }})
}, deletepost = function() {
    var a = $(this).attr("data-id"), b = confirm("Do you want to remove this post?");
    b && $.ajax({url: "/api/community/delete",type: "POST",dataType: "json",data: {token: chinchilla.token,post: a},success: function(a) {
        a.success && navigation.to("/")
    }})
}, maximize = function() {
    $(this).text("[-]").removeClass("maximize").addClass("minify"), $(this).parents(".comment").eq(0).find("> .comment-body, > .comment, > .comment-footer, > .replies, > .vote-module").show()
}, minify = function() {
    $(this).text("[+]").removeClass("minify").addClass("maximize"), $(this).parents(".comment").eq(0).find("> .comment-body, > .comment, > .comment-footer, > .replies, > .vote-module").hide()
}, showLoginPopup = function(a) {
    var b = ['<div class="login-popup">', '<h6 class="transition-up">Login or register</h6>', '<article class="transition-up"><%= text %></article>', '<div class="orange-button transition-up" data-navigate="/register">Login</div>', '<div class="orange-button white-version transition-up">No, thanks</div>', "</div>"].join("\n");
    $(_.template(b, {text: a})).appendTo("#backdrop"), $("#backdrop").show()
}, hideBackdrop = function() {
    $("#backdrop").hide(), $(".login-popup").remove()
}, openInNewTab = function(a) {
    a.preventDefault(), window.open($(this).attr("href"), "_blank")
}, skipToSong = function() {
    console.log($(".queue-entry").index(this) + 1), player.skipNTracks($(".queue-entry").index(this) + 1)
}, showSongPicker = function() {
    var a = $(this), b = a.parents(".song-picker-activator"), c = b.find(".song-picker-container");
    if (!c.is(":empty"))
        return void c.show();
    var d = function(a) {
        c.html(a), $(a).find(".song-picker-object").eq(0).addClass("song-picker-selected")
    };
    songpicker.selectSong({input: a,div_callback: d,songPickedCallback: function(b) {
        if ("add-track" == a.attr("data-action")) {
            setTimeout(function() {
                a.focus()
            }, 0), $(a).focus();
            var c = $("#view").attr("data-route");
            collections.add(c, b.id)
        } else
            submit.selectSong(b)
    }})
}, hideSongPicker = function() {
    var a = $(this), b = a.parents(".song-picker-activator"), c = b.find(".song-picker-container");
    c.hide()
}, songPickerHover = function() {
    $(".song-picker-selected").removeClass("song-picker-selected"), $(this).addClass("song-picker-selected")
}, songPickerClick = function() {
    $(".song-picker-input").trigger($.Event("keydown", {keyCode: 13})).focus()
}, plmorebutton = function() {
    var a = $(".playlist-more-menu");
    a.addClass("more-menu-visible"), $(document).on("mouseup", function(b) {
        srcElement = b.srcElement || b.target, $(srcElement).hasClass("playlist-more-menu") || 0 != $(srcElement).parents(".playlist-more-menu").size() || a.removeClass("more-menu-visible")
    })
}, pladdbutton = function() {
    var a = $(".playlist-add-menu");
    a.addClass("add-menu-visible"), $(document).on("mouseup", function(b) {
        srcElement = b.srcElement || b.target, $('[data-action="add-track"]').focus(), $(srcElement).hasClass("playlist-add-menu") || 0 != $(srcElement).parents(".playlist-add-menu").size() || a.removeClass("add-menu-visible")
    })
}, plfilter = function() {
    var a = this.value.toLowerCase();
    $('[data-represents="' + $(this).data("url") + '"] .song').each(function(b, c) {
        var d = $(c).data();
        -1 != d.name.toLowerCase().indexOf(a) || -1 != d.artist.toLowerCase().indexOf(a) || -1 != d.album.toLowerCase().indexOf(a) ? $(c).show() : $(c).hide()
    })
}, showfilter = function() {
    $(".pl-v3-filter").toggle().find("input").focus()
}, removeplaylistsafe = function() {
    var a = confirm("Are you sure you want to delete this playist? This is not revertable");
    a && deleteplaylist($(this).attr("data-url"))
}, songstripback = function() {
    {
        var a = $(this).nextAll(".v2-song-strip");
        $(a).scrollLeft()
    }
    $(a).animate({scrollLeft: "-=" + $("#view").width()})
}, songstripforward = function() {
    {
        var a = $(this).next(".v2-song-strip");
        $(a).scrollLeft()
    }
    $(this).prev(".v2-song-strip-back").show(), $(a).animate({scrollLeft: "+=" + $("#view").width()})
}, togglePlaylistsv2 = function() {
    $(".v2-playlist-adder").toggle()
}, toggleScrobbling = function() {
    var a = this.checked;
    localStorage.scrobble = a
};
$(document).on("mousedown", "body", mousedown).on("mousedown", ".song", select).on("keyup", "body", keys).on("keydown", "body", keysdown).on("dblclick", ".song", playSong).on("mousedown", "#seek-bar", dragSeek).on("mousedown", "#volume-slider", changevolume).on("click", "#play", resume).on("click", "#pause", pause).on("click", "#skip", skip).on("click", "#rewind", rewind).on("mouseover", "[data-tooltip]", tooltip).on("keydown", "#search-field", autocomplete).on("keyup", ".add-tracks-input", addtrack).on("click", "#clear-input", clearinput).on("click", ".play-button", playSong).on("click", ".library-button", addtolib).on("click", ".library-remove-button", remfromlib).on("click", ".not-in-library .heart", addtolib).on("click", ".in-library .heart", remfromlib).on("click", "#logout", logout).on("contextmenu", ".song, .queue-song", rightclick).on("contextmenu", ".playlistmenuitem", playlistmenu).on("change", ".settings input", setchange).on("click", "[data-order]", ordersongs).on("click", ".add-all-album", addalbumtolib).on("click", ".findandplay", findandplay).on("click", ".findandqueue", findandqueue).on("click", ".notification .actions span", hidenotification).on("click", ".albumhidden-message", showalbum).on("click", ".add-new-playlist", newplaylist).on("click", ".rename-playlist-button", renameplaylist).on("click", ".pl-label[contenteditable]", suppressrenaming).on("click", ".delete-playlist-button", deleteplaylist).on("click", ".add-song-to-playlist-button", addsongtopl).on("click", ".remove-song-from-playlist-button", remsongfrompl).on("click", ".playlist-privacy", pldropdown).on("click", ".publish-playlist", mkplpublic).on("click", ".unpublish-playlist", mkplprivate).on("click", ".make-playlist-newest-at-top", mkplnwattop).on("click", ".make-playlist-newest-at-bottom", mkplnwatbottom).on("click", ".follow-playlist", followplaylist).on("click", ".unfollow-playlist", unfollowplaylist).on("click", ".close-notification", closenotification).on("click", ".play-all-songs", playallsongs).on("click", ".play-all-songs-in-order", playallsongsinorder).on("hover", "#search-results-wrapper li", hoversearchresult).on("click", ".show-filter-dropdown[data-trigger]", filterdropdown).on("keydown", preventScrolling).on("click", "[data-trigger]", trigger).on("click", "[data-untrigger]", untrigger).on("click", "#start-queue", startqueue).on("click", "#stop-queue", stopqueue).on("change", "#playlist-target", pltargetchanged).on("click", ".radio-skip", skip).on("click", ".start-radio-from-song", startradiosong).on("click", ".radio-station", radiostation).on("click", "#nowplaying-images", jumptorepresents).on("click", ".report-page-video", reportselect).on("click", ".report-submit", reportsubmit).on("click", ".search-result", searchresult).on("click", ".queue-prev", prevQueue).on("click", ".queue-next", nextQueue).on("dblclick", ".sidebar-has-tracks", doubleclickPlaylist).on("mousedown", "#search-field, #clear-input", searchfocused).on("click", ".wikipedia-description", togglewikicollapse).on("click", ".song-page-edit-metadata", editmetadata).on("click", ".song-page-submit-metadata", submitmetadata).on("input", "#register-username-input", checkusername).on("click", ".send-username", sendusername).on("submit", ".register-form", register).on("submit", ".login-form", login).on("click", ".add-multiple-to-library", addmultiple).on("click", ".remove-multiple-from-library", removemultiple).on("click", ".remove-multiple-from-playlist", plremovemultiple).on("click", "#nowplaying-speaker-icon", volumecontrol).on("click", ".play-list", playList).on("click", ".submit-ones li", changeSubmitSub).on("click", ".submit-types li", changeSubmitType).on("click", ".submit-submit", submitpost).on("click", ".change-language", changeLang).on("click", ".submit-song-select-another", selectAnother).on("click", ".upvote-post", upvotePost).on("click", ".downvote-post", downvotePost).on("click", ".upvote-comment", upvoteComment).on("click", ".downvote-comment", downvoteComment).on("click", ".submit-playlist-element", selectSubmitPlaylist).on("click", ".submit-comment", submitcomment).on("click", ".reply-to-comment", showreplyfield).on("click", ".delete-comment", deletecomment).on("click", ".delete-post", deletepost).on("click", ".minify", minify).on("click", ".maximize", maximize).on("click", "#backdrop", hideBackdrop).on("click", ".markdown a[href]", openInNewTab).on("dblclick", ".queue-entry", skipToSong).on("click", ".markdown-label", openInNewTab).on("focus", ".song-picker-activator input", showSongPicker).on("blur", ".song-picker-activator input", hideSongPicker).on("mouseover", ".song-picker-object", songPickerHover).on("mousedown", ".song-picker-object", songPickerClick).on("click", ".playlist-more-button", plmorebutton).on("click", ".playlist-add-button", pladdbutton).on("input", ".pl-v3-filter input", plfilter).on("click", ".playlist-search-button", showfilter).on("click", ".v3-rename-playlist", renameplaylistinline).on("click", ".v3-delete-playlist", removeplaylistsafe).on("click", ".v2-song-strip-back", songstripback).on("click", ".v2-song-strip-forward", songstripforward).on("click", ".v2-song-page-playlists", togglePlaylistsv2).on("change", ".toggle-scrobbling", toggleScrobbling), $(window).on("beforeunload", warnexit).on("keydown", function(a) {
    return $(document.activeElement).is("input") || $(document.activeElement).is("[contenteditable]") || $(document.activeElement).is("textarea") ? void 0 : !(32 == a.keyCode)
});
var youtubeinit = function() {
    var a = document.createElement("script");
    a.src = "http://www.youtube.com/iframe_api";
    var b = document.getElementsByTagName("script")[0];
    b.parentNode.insertBefore(a, b)
};
$(document).ready(function() {
    $.subscribe("new-tracks-entered-dom", function() {
        var a = $(".song.not-recognized");
        recognition.queue.clear(), _.each(a, function(a) {
            recognition.queue.push(a)
        });
        var b = player.nowPlaying.get();
        if (b) {
            var c = $('.song[data-id="' + b.id + '"]');
            c.addClass("now-playing"), ytplayer.getPlayerState && 1 == ytplayer.getPlayerState() && (c.addClass("hearable"), oneTune.hearable(!0))
        }
    }), $.subscribe("speaker-icon-entered-dom", function() {
        displaySpeaker()
    }), $.subscribe("view-gets-loaded", function() {
        $("#view").addClass("view-loading")
    }), $.subscribe("view-got-loaded", function() {
        $("#view").removeClass("view-loading")
    }), $.subscribe("radio-enabled", function() {
        $("body").addClass("radio-mode"), chinchilla.radio_mode = !0
    }), $.subscribe("radio-disabled", function() {
        $("body").removeClass("radio-mode"), chinchilla.radio_mode = !1
    }), $.subscribe("queue-changed", function() {
        queues.showSidebar(), player.saveQueQue()
    }), sync.syncYoutubeTracks(), queues.showSidebar(), youtubeinit(), $("#view").on("scroll", viewScrolled)
}), function(a) {
    var b = a({});
    a.subscribe = function() {
        b.on.apply(b, arguments)
    }, a.unsubscribe = function() {
        b.off.apply(b, arguments)
    }, a.publish = function() {
        b.trigger.apply(b, arguments)
    }
}(jQuery);
var SongsCollection, PlaylistCollection, storeReady = function() {
    SongsCollection = songsdb
}, plStoreReady = function() {
    PlaylistCollection = pldb
}, songsdb = new IDBStore({storeName: "songs"}, storeReady);
DB = {}, DB.getTracks = function(a) {
    SongsCollection ? songsdb.query(function(b) {
        var c = _.map(b, function(b) {
            return _.contains(a.ids, b.id + "") ? b : null
        }), d = _.compact(c), e = _.map(d, function(a) {
            return a.inlib = _.contains(oneTune.library(), a.id + ""), a
        });
        a.callback(e)
    }) : setTimeout(function() {
        DB.getTracks(a)
    }, 100)
}, DB.putUpdates = function(a, b) {
    if (SongsCollection) {
        var c = a, d = 0, e = function(a, b) {
            return console.log(a), _.each(b.fields_changed, function(b, c) {
                a[c] = b
            }), a
        }, f = function(a, b) {
            return _.map(a, function(a) {
                return a.id == b.track_id ? e(a, b) : a
            })
        }, g = function(a, b) {
            return a ? (a.current.id == b.track_id && (a.current = e(a.current, b), b.fields_changed.ytid && player.nowPlaying.replace(a.current), player.queues.current.current.id == b.track_id && ytplayer.loadVideoById(a.current.ytid)), a.history = f(a.history, b), a.queue = f(a.queue, b), a) : null
        }, h = function(a, b) {
            return a.current = g(a.current, b), a.next = _.map(a.next, function(a) {
                return g(a, b)
            }), a.prev = _.map(a.prev, function(a) {
                return g(a, b)
            }), $.publish("queue-changed"), a
        };
        songsdb.query(function(a) {
            _.each(a, function(a) {
                _.each(c, function(b) {
                    a.id == b.track_id && (console.log(a, b), d++, _.each(b.fields_changed, function(b, c) {
                        a[c] = b
                    }), DB.addTrack(a))
                })
            }), b(d)
        }), _.each(c, function(a) {
            player.queues = h(player.queues, a)
        })
    } else
        setTimeout(function() {
            DB.putUpdates(obj)
        }, 100)
}, DB.addTrack = function(a) {
    SongsCollection ? songsdb.put(a) : setTimeout(function() {
        DB.addTrack(a)
    }, 100)
}, DB.addYTIDToTrack = function(a, b) {
    SongsCollection ? songsdb.query(function(c) {
        var d = _.map(c, function(b) {
            return b.id == a.id ? b : null
        }), e = _.compact(d);
        if (e.length > 0) {
            var f = e[0];
            f.ytid = b, DB.addTrack(f)
        }
    }) : setTimeout(function() {
        DB.addYTIDToTrack(a)
    }, 100)
}, DB.getAllIds = function(a) {
    return SongsCollection ? void songsdb.query(function(b) {
        var c = _.pluck(b, "id");
        a(c)
    }) : void setTimeout(function() {
        DB.getAllIds(a)
    }, 100)
}, DB.getAllLibrarySongsSorted = function(a, b) {
    var c = a, d = ({user: chinchilla.loggedin}, function(a) {
        var b = a, d = _.difference(c, _.pluck(b, "id"));
        0 != d.length ? $.ajax({url: "/api/tracks/get",data: {tracks: d},dataType: "json",success: function(a) {
            var c = _.union(a.tracks, b);
            e(c), _.each(a.tracks, function(a) {
                DB.addTrack(a)
            })
        }}) : e(b)
    }), e = function(a) {
        b(helpers.sortTracks(c, a).reverse())
    };
    DB.getTracks({ids: c,callback: d})
}, remote = {updateTrack: function() {
    chinchilla.paired && console.log("Paired")
}}, queues = {showSidebar: function() {
    $("#sidebar-queue").html(templates.buildSidebarQueue({}))
}}, radio = {showRadioPage: function() {
    $("#view").html(_.template($("#radio-template").html())), radio.loadIntoDOM({radio_id: localStorage.current_radio})
},loadIntoDOM: function(a) {
    localStorage.current_radio = a.radio_id, $(".album-slider").removeClass("load-tracks");
    var b = JSON.parse(localStorage.radio)[a.radio_id];
    $(".radio-album-covers").empty(), this.addBoxes(b.history), this.addBox(b.current), a.instant_start && ($('.radio-box[data-id="' + b.current.id + '"]').find(".visual-play-button").click(), localStorage.current_radio = a.radio_id), $(".radio-type").text(this.typeLabels[b.type]), $(".radio-based").text('based on "' + b.from.title + '"'), 0 == b.queue.length && $(".album-slider").addClass("load-tracks"), $(".radio-stations").empty(), _.each(JSON.parse(localStorage.radio), this.addStation)
},addBox: function(a) {
    var b = _.template($("#radio-song-template").html(), {data: a});
    $(".radio-album-covers").prepend(b)
},addBoxes: function(a) {
    _.each(a, this.addBox)
},addStation: function(a) {
    $(".radio-stations").append(_.template($("#radio-station-template").html(), a))
},typeLabels: {"song-radio": "Song Radio"}}, report = {showList: function(a) {
    recognition.findVideo(a, function(b) {
        _.each(b, function(b) {
            var c = b.advanced.id, d = $('<div class="report-page-video" data-reportytid="' + c + '">');
            $("<img>").attr("src", b.basic.snippet.thumbnails["default"].url).appendTo(d);
            var e = b.basic.snippet.title;
            e.length > 80 && (e = e.substr(0, 80) + "..."), $("<h3>").text(e).appendTo(d);
            var f = $("<p>").text(b.basic.snippet.channelTitle).appendTo(d);
            c == a.ytid && $("<span>").text("current video").appendTo(f), $("<span>").text(Math.floor(b.points / 900 * 1e4) / 100 + "%").appendTo(f), d.appendTo(".report-video-list")
        })
    }, null, null, null, {all_videos: !0})
}}, sync = {syncYoutubeTracks: function() {
    chinchilla.loggedin && DB.getAllIds(function(a) {
        var b = _.groupBy(a, function(a, b) {
            return Math.floor(b / 150)
        });
        _.each(b, function(a) {
            $.ajax({url: "/api/sync",data: {tracks: a.join(","),token: chinchilla.token,lastSync: localStorage.lastSync},dataType: "json",success: function(a) {
                a.success && console.log("No sync needed."), localStorage.lastSync = Date.now(), 0 != a.length ? DB.putUpdates(a, function(b) {
                    console.log(b + " tracks synced. " + (a.length - b) + " failed.")
                }) : console.log("SYN complete. No tracks were replaced.")
            }})
        })
    })
}}, tracklist = {build: function(a) {
    var b = $("<div>").addClass("one-track-wrapper album-tracks").attr("data-represents", a.represents);
    "box" == a.type && b.addClass("one-track-box");
    var c = $("<div>").addClass("one-track-wrapper-header").appendTo(b), d = $("<div>").addClass("one-track-title").appendTo(b);
    $("<div>").text(a.title).appendTo(d);
    var e = $("<div>").addClass("one-track-subtitle").appendTo(b);
    if (a.represents && $("<span>").text("song" == a.entity ? "See all tracks" : "See all").attr("data-navigate", a.represents).appendTo(e), "song_post" == a.entity && ($("<span>").text(" - ").appendTo(e), $("<span>").text("Play").addClass("play-list").appendTo(e)), !a.tracks || 0 == a.tracks.length)
        return b.append('<p class="one-no-tracks">No tracks available</p>'), b;
    var f, g = $("<img>").addClass("one-track-wrapper-cover").attr("data-px", 100);
    if ("first" == a.cover && (f = helpers.getHQAlbumImage(a.tracks[0], 100)), "placeholder" == a.cover && (f = "/frontend/images/story_placeholder.png"), "first_post" == a.cover && (f = helpers.getHQAlbumImage(a.tracks[0].info, 100)), "first_playlist" == a.cover && (f = a.tracks[0].thumbnails[0]), g.attr("src", f), g.appendTo(c), "song" == a.entity) {
        var h = $("<div>").addClass("play-list play-list-visual").attr("data-id", a.represents).appendTo(b);
        $("<div>").addClass("play-list-play-icon").appendTo(h), $("<div>").addClass("play-list-decoration").appendTo(h)
    }
    if (a.submit) {
        $("<div>").addClass("orange-button one-header-button").text("Submit").attr("data-navigate", a.submit === !0 ? "/one/submit" : "/one/" + a.submit + "/submit").appendTo(c)
    }
    var i = $("<table>").addClass("one-track-table"), j = function(a, b, c) {
        !b.displayed || b.displayed > c ? (a.addClass("one-showable"), c > b.minified - 1 && a.hide()) : a.hide()
    };
    return "song_post" == a.entity && _.each(a.tracks, function(b, c) {
        var d = $("<div>").addClass("reddit-box song").addClass("reddit-box-submission-with-cover");
        d.addClass(b.info.ytid ? "recognized" : "not-recognized"), _.each(b.info, function(a, b) {
            d.attr("data-" + b, a)
        });
        var e = $('<div class="vote-module">').attr("data-vote", b.vote), f = $('<div class="upvote-post">').attr("data-slug", b.slug).attr("data-sub", b.sub).appendTo(e);
        $('<div class="upvote-count">').text(b.vote_count).appendTo(e);
        var g = $('<div class="downvote-post">').attr("data-slug", b.slug).attr("data-sub", b.sub).appendTo(e);
        if ($("<img>").attr("src", "/api/i/pixel").addClass("svg-upvote-black").appendTo(f), $("<img>").attr("src", "/api/i/pixel").addClass("svg-downvote-black").appendTo(g), chinchilla.loggedin) {
            var h = _.contains(oneTune.library(), b.info.id);
            d.addClass(h ? "in-library" : "not-in-library"), b.upvoted && f.addClass("upvoted"), b.downvoted && g.addClass("downvoted")
        }
        e.appendTo(d), j(d, a, c), d.appendTo(i);
        var k = $("<div>").addClass("reddit-info-box"), l = $("<div>").addClass("visual-play-button recognized findandplay").attr("data-id", b.info.id).appendTo(k);
        $("<div>").addClass("play-icon").appendTo(l);
        $("<img>").addClass("one-story-cover").attr("src", b.info.image).appendTo(d);
        $("<span>").addClass("reddit-song-name").html(helpers.parsetext(b.info.name)).attr("data-navigate", "/one/" + b.sub + "/" + b.slug + "/" + b.url).appendTo(k), $("<br>").appendTo(k);
        $("<span>").addClass("reddit-song-artist").attr("data-navigate", "/artist/" + b.info.artistid).text(b.info.artist).appendTo(k);
        $("<br>").appendTo(k), $("<span>").addClass("reddit-song-user").attr("data-navigate", "/one/" + b.sub + "/" + b.slug + "/" + b.url).text(b.comments + " " + (1 == b.comments ? "comment" : "comments")).appendTo(k), $("<span>").addClass("reddit-song-user").text(" - " + b.timestamp).appendTo(k), $("<span>").addClass("reddit-song-user").text(" to ").appendTo(k), $("<span>").addClass("reddit-song-user").attr("data-navigate", "/one/" + b.sub).text(b.sub).appendTo(k), k.appendTo(d)
    }), "story" == a.entity && _.each(a.tracks, function(b, c) {
        var d = $("<div>").addClass("reddit-box").addClass("reddit-box-story"), e = $('<div class="vote-module">').attr("data-vote", b.vote), f = $('<div class="upvote-post">').attr("data-slug", b.slug).attr("data-sub", b.sub).appendTo(e);
        $('<div class="upvote-count">').text(b.vote_count).appendTo(e);
        var g = $('<div class="downvote-post">').attr("data-slug", b.slug).attr("data-sub", b.sub).appendTo(e);
        $("<img>").attr("src", "/api/i/pixel").addClass("svg-upvote-black").appendTo(f), $("<img>").attr("src", "/api/i/pixel").addClass("svg-downvote-black").appendTo(g), chinchilla.loggedin && (b.upvoted && f.addClass("upvoted"), b.downvoted && g.addClass("downvoted")), e.appendTo(d), j(d, a, c), d.appendTo(i);
        var h = $("<div>").addClass("reddit-info-box");
        $("<span>").addClass("reddit-song-name").html(b.title).attr("data-navigate", "/one/" + b.sub + "/" + b.slug + "/" + b.url).appendTo(h), $("<br>").appendTo(h), $("<span>").addClass("reddit-song-user").text(b.user).appendTo(h), $("<br>").appendTo(h), $("<span>").addClass("reddit-song-user").attr("data-navigate", "/one/" + b.sub + "/" + b.slug + "/" + b.url).text(b.comments + " " + (1 == b.comments ? "comment" : "comments")).appendTo(h), $("<span>").addClass("reddit-song-user").text(" - " + b.timestamp).appendTo(h), $("<span>").addClass("reddit-song-user").text(" to ").appendTo(h), $("<span>").addClass("reddit-song-user").attr("data-navigate", "/one/" + b.sub).text(b.sub).appendTo(h), h.appendTo(d)
    }), "playlist" == a.entity && _.each(a.tracks, function(b, c) {
        var d = $("<div>").addClass("reddit-box").addClass("reddit-box-playlist"), e = $('<div class="vote-module">').attr("data-vote", b.vote), f = $('<div class="upvote-post">').attr("data-slug", b.slug).attr("data-sub", b.sub).appendTo(e);
        $('<div class="upvote-count">').text(b.vote_count).appendTo(e);
        var g = $('<div class="downvote-post">').attr("data-slug", b.slug).attr("data-sub", b.sub).appendTo(e);
        $("<img>").attr("src", "/api/i/pixel").addClass("svg-upvote-black").appendTo(f), $("<img>").attr("src", "/api/i/pixel").addClass("svg-downvote-black").appendTo(g), chinchilla.loggedin && (b.upvoted && f.addClass("upvoted"), b.downvoted && g.addClass("downvoted")), e.appendTo(d), j(d, a, c), d.appendTo(i);
        var h = $("<div>").addClass("twobytwocovers");
        _.each(b.thumbnails, function(a) {
            $("<img>").attr("src", a).appendTo(h)
        }), h.appendTo(d);
        var k = $("<div>").addClass("reddit-info-box");
        $("<span>").addClass("reddit-song-name").html(b.title).attr("data-navigate", b.playlist).appendTo(k), $("<br>").appendTo(k), $("<span>").addClass("reddit-song-user").text(b.user).appendTo(k), $("<br>").appendTo(k), $("<span>").addClass("reddit-song-user").text(b.comments + " " + (1 == b.comments ? "comment" : "comments")).attr("data-navigate", "/one/" + b.sub + "/" + b.slug + "/" + b.url).appendTo(k), $("<span>").addClass("reddit-song-user").text(" - " + b.timestamp).appendTo(k), $("<span>").addClass("reddit-song-user").text(" to ").appendTo(k), $("<span>").addClass("reddit-song-user").attr("data-navigate", "/one/" + b.sub).text(b.sub).appendTo(k), k.appendTo(d)
    }), "public_playlist" == a.entity && _.each(a.tracks, function(b, c) {
        var d = $("<div>").addClass("reddit-box").addClass("reddit-box-public-playlist reddit-box-playlist");
        j(d, a, c), d.appendTo(i);
        var e = $("<div>").addClass("twobytwocovers");
        _.each(b.thumbnails, function(a) {
            $("<img>").attr("src", a).appendTo(e)
        }), e.appendTo(d);
        var f = $("<div>").addClass("reddit-info-box reddit-info-box-playlist");
        $("<span>").addClass("reddit-song-name").html(b.name).attr("data-navigate", b.url).appendTo(f), $("<br>").appendTo(f), $("<span>").addClass("reddit-song-user").html(b.tracks.length + " tracks").appendTo(f), f.appendTo(d)
    }), "song" == a.entity && _.each(a.tracks, function(b, c) {
        var d = $("<div>").addClass("song reddit-box");
        if (j(d, a, c), chinchilla.loggedin) {
            var e = _.contains(oneTune.library(), b.id);
            d.addClass(e ? "in-library" : "not-in-library")
        }
        d.addClass(b.ytid ? "recognized" : "not-recognized"), _.each(b, function(a, b) {
            d.attr("data-" + b, a)
        });
        var f = ($("<img>").attr("src", b.image).appendTo(d), $("<div>").addClass("inline-actions"));
        chinchilla.loggedin && $("<div>").addClass("heart").appendTo(f), f.appendTo(d);
        var g = $("<div>").addClass("reddit-info-box"), h = $("<div>").addClass("visual-play-button recognized findandplay").attr("data-id", b.id).appendTo(g);
        $("<div>").addClass("play-icon").appendTo(h), g.appendTo(g), $("<span>").addClass("reddit-song-name").html(helpers.parsetext(b.name)).attr("data-navigate", "/song/" + b.id).appendTo(g), $("<br>").appendTo(g);
        $("<span>").addClass("reddit-song-artist").attr("data-navigate", "/artist/" + b.artistid).text(b.artist).appendTo(g);
        g.appendTo(d), d.appendTo(i)
    }), i.appendTo(b), a.minified <= a.tracks.length && $("<div>").addClass("one-show-more").text("Show more...").one("click", function() {
        $(i).find(".reddit-box.one-showable").show(), console.log(a), a.represents && $(this).one("click", function() {
            navigation.to(a.represents)
        }).text("Show all")
    }).appendTo(b), b
}}, one = {buildHomePage: function(a) {
    $('#view[data-route="/one/' + a.one + '"]').empty();
    {
        var b = $("<table>");
        $("<tr>").addClass("subtune-layout-table").appendTo(b)
    }
    a.header && $('#view[data-route="/one/' + a.one + '"]').append(a.header);
    var c = tracklist.build({tracks: a.stories,displayed: 8,represents: "/one/" + a.one + "/stories",title: "Discussions",cover: "placeholder",type: "box",entity: "story",submit: a.one,minified: 3}), d = tracklist.build({tracks: a.songs,displayed: 16,represents: "/one/" + a.one + "/songs",title: "Songs",cover: "first_post",type: "box",entity: "song_post",submit: a.one,minified: 8}), e = tracklist.build({tracks: a.playlists,displayed: 16,represents: "/one/" + a.one + "/playlists",title: "Playlists",cover: "first_playlist",type: "box",entity: "playlist",submit: a.one,minified: 8}), f = tracklist.build({tracks: a.itunes_charts,displayed: 16,represents: "/one/" + a.one + "/charts",title: "iTunes charts",cover: "first",type: "box",entity: "song",minified: 8}), g = tracklist.build({tracks: a.reddit,displayed: 16,represents: "/r/" + a.sub.reddit,title: "Top reddit tracks",cover: "first",type: "box",entity: "song",minified: 8}), h = $("<div>").addClass("one-two-col"), i = $("<div>").addClass("one-col one-col-left").appendTo(h), j = $("<div>").addClass("one-col one-col-right").appendTo(h);
    if (a.sub.description) {
        var k = $("<div>").addClass("one-hello-box one-track-wrapper one-track-box");
        $("<div>").addClass("one-hello-content").text(a.sub.description).appendTo(k), k.appendTo(i)
    }
    i.append(c), j.append(d), i.append(e), a.itunes && j.append(f), a.reddit.length > 0 && i.append(g);
    var l = $("<div>").addClass("one-page").append(h);
    $('#view[data-route="/one/' + a.one + '"]').append(l), $.publish("speaker-icon-entered-dom"), views.loadingindicator.hide()
}}, songpicker = {selectSong: function(a) {
    var b, c = $("<div>").addClass("song-picker"), d = "", e = function(a) {
        var b = $("<div>").addClass("song-picker-object");
        return b.data(a), $("<img>").addClass("song-picker-image").attr("src", a.image).appendTo(b), $("<div>").addClass("song-picker-title").text(a.name).appendTo(b), $("<div>").addClass("song-picker-artist").text(a.artist).appendTo(b), b
    }, f = function() {
        var a = d, b = $("<div>").addClass("song-picker-itunes").appendTo(c);
        $.ajax({url: "http://itunes.apple.com/search",data: {term: d,entity: "song",limit: 3},dataType: "jsonp",success: function(c) {
            d == a && (f.remove(), _.each(c.results, function(a) {
                b.append(e(helpers.remap(a)))
            }), h())
        }}), $("<div>").addClass("song-picker-section-header song-picker-itunes-header").text("Results for " + d).appendTo(b);
        var f = $("<img>").attr("src", "/api/svg/fading-loader").addClass("song-picker-loader").appendTo(b)
    }, g = function() {
        var a = d, b = $("<div>").addClass("song-picker-youtube").appendTo(c);
        $.ajax({url: "https://www.googleapis.com/youtube/v3/search",data: {maxResults: 5,q: d,key: "AIzaSyCCRAemuZXM6GwYQWXOQI1e4kMnB57LtX0",part: "snippet"},success: function(c) {
            d == a && (f.remove(), _.each(c.items, function(a) {
                var c = e({image: a.snippet.thumbnails["default"].url,name: a.snippet.title,artist: a.snippet.channelTitle,id: a.id.videoId});
                b.append(c)
            }))
        }}), $("<div>").addClass("song-picker-section-header song-picker-itunes-header").text("YouTube videos for " + d).appendTo(b);
        var f = $("<img>").attr("src", "/api/svg/fading-loader").addClass("song-picker-loader").appendTo(b)
    }, h = function() {
        $(".song-picker-selected").removeClass("song-picker-selected"), $(".song-picker-object:visible").eq(0).addClass("song-picker-selected")
    }, i = function() {
        a.div_callback(c), $(a.input).on("keydown", function(b) {
            var c = $(".song-picker-selected"), d = c.index(".song-picker-object:visible"), e = $(".song-picker-object:visible").eq(d - 1), f = $(".song-picker-object:visible").eq(d + 1);
            40 == b.keyCode ? f.length > 0 && ($(c).removeClass("song-picker-selected"), $(f).addClass("song-picker-selected")) : 38 == b.keyCode ? e.length > 0 && ($(c).removeClass("song-picker-selected"), $(e).addClass("song-picker-selected")) : 13 == b.keyCode && (a.songPickedCallback($(".song-picker-selected").data()), $(a.input).val("").trigger("input"))
        }).on("input", function() {
            $(".song-picker-container").show(), d = $(a.input).val(), $(".song-picker-itunes").remove(), $(".song-picker-youtube").remove(), "" == d ? $(b).show() : ($(b).hide(), f(), g())
        }).on("keyup", function(a) {
            27 == a.keyCode && $(".song-picker-container").hide()
        })
    };
    if (oneTune.library().length) {
        if ($("#view").attr("data-route"))
            return void i();
        DB.getTracks({ids: _.first(oneTune.library.reverse(), 3),callback: function(a) {
            b = $("<div>").addClass("song-picker-library").appendTo(c), $("<div>").addClass("song-picker-section-header").text("From your library").appendTo(b), _.each(a, function(a) {
                b.append(e(a))
            }), i()
        }})
    } else
        i()
}}, userpage = {buildHomePage: function(a) {
    $("#view").empty();
    {
        var b = $("<table>");
        $("<tr>").addClass("subtune-layout-table").appendTo(b)
    }
    $("#view").append("<div class='userpage-header'><h1>" + a.username + "</h1><h3>" + a.publicPlaylists.length + " Public Playlists | " + (a.playlists.length + a.songs.length + a.stories.length) + " Submissions</h3></div>");
    var c = tracklist.build({tracks: a.stories,displayed: 8,title: "Submitted Discussions",cover: "placeholder",type: "box",entity: "story",minified: 3}), d = tracklist.build({tracks: a.playlists,displayed: 8,title: "Submitted Playlists",cover: "placeholder",type: "box",entity: "playlist",minified: 3}), e = tracklist.build({tracks: a.publicPlaylists,displayed: 8,title: "Public Playlists",cover: "placeholder",type: "box",entity: "public_playlist",minified: 3}), f = tracklist.build({tracks: a.songs,displayed: 16,represents: "/user",title: "Submitted Songs",cover: "placeholder",type: "box",entity: "song_post",minified: 8}), g = $("<div>").addClass("one-two-col"), h = $("<div>").addClass("one-col one-col-left").appendTo(g), i = $("<div>").addClass("one-col one-col-right").appendTo(g);
    h.append(e), i.append(f), h.append(c), i.append(d);
    var j = $("<div>").addClass("one-page").append(g);
    $('#view[data-route="/u/' + a.username + '"]').append(j), views.loadingindicator.hide()
}}, submit = {getLibrarySuggestions: function() {
    if (oneTune.library().length > 0) {
        var a = _.last(oneTune.library(), 3).reverse(), b = function() {
        };
        DB.getTracks({ids: a,callback: b})
    }
},selectSong: function(a) {
    submit.buildSubmit(a), $(".song-picker-activator").hide()
},buildSubmit: function(a) {
    var b = $("<div>").attr({"data-id": a.id}).addClass("submit-song-box");
    $("<img>").addClass("submit-song-box-image").attr("src", a.image).appendTo(b), $("<div>").addClass("submit-song-box-name").text(a.name).appendTo(b), $("<div>").addClass("submit-song-box-artist").text(a.artist).appendTo(b), $("<div>").addClass("submit-song-select-another").text("Select another").appendTo(b), $(".selected-area").html(b), $("<p>").addClass("submit-step", "3. Select a song").prependTo(".selected-area")
},showSong: function() {
    $(".submit-playlist-area").hide(), $(".submit-story-area").hide(), $(".submit-song-area").show()
},showStory: function() {
    $(".submit-song-area").hide(), $(".submit-playlist-area").hide(), $(".submit-story-area").show()
},buildSubmitPlaylist: function() {
    var a = $(".compose-select-playlist");
    if (a.empty(), 0 == oneTune.playlists().length)
        a.append("<p class='submit-no-playlists'><span style='font-weight:bold'>You have no playlists yet! To submit one, you can:</span><br/><br/>1) Make your own playlist by clicking 'New playlist' on the left sidebar<br/>2) Follow a playlist by going to someone's public playlist</p>");
    else {
        var b = $("<div>").addClass("submit-playlist-selection");
        _.each(oneTune.playlists(), function(a) {
            DB.getTracks({ids: a.tracks,callback: function(c) {
                var d = $("<div>").addClass("twobytwocovers"), c = _.uniq(c, !1, function(a) {
                    return a.image
                });
                _.chain(c).first(4).each(function(a) {
                    $("<img>").attr("src", a.image).appendTo(d)
                });
                var e = $("<div>").addClass("submit-playlist-element").attr("data-url", a.url);
                d.appendTo(e), $("<h3>").text(a.name).appendTo(e), $("<p>").text(a.tracks.length + " tracks").appendTo(e), e.appendTo(b)
            }})
        }), a.html(b)
    }
    $(".submit-song-area").hide(), $(".submit-story-area").hide(), $(".submit-playlist-area").show()
}}, homepage = {build: function(a) {
    $("#view").empty();
    {
        var b = $("<table>");
        $("<tr>").addClass("subtune-layout-table").appendTo(b)
    }
    if ($('#view[data-route="/home"]').append(a.header), chinchilla.loggedin)
        var c = tracklist.build({tracks: a.library,displayed: 16,represents: "/library",title: "Your library",cover: "first",type: "box",entity: "song",minified: 8});
    var d = tracklist.build({tracks: a.charts,displayed: 8,represents: "/charts",title: "Top charts",cover: "first",type: "box",entity: "song",minified: 3}), e = tracklist.build({tracks: a.retro.charts,displayed: 8,represents: "/time-machine/" + a.retro.year,title: "Time machine: " + a.retro.year,cover: "first",type: "box",entity: "song",minified: 5}), f = tracklist.build({tracks: _.pluck(a.reddit, "song"),displayed: 8,represents: "/genres",title: "Hot on Reddit",cover: "first",type: "box",entity: "song",minified: 3}), g = tracklist.build({tracks: a.posts.song,displayed: 16,title: "Top voted songs",represents: "/songs",cover: "first_post",type: "box",entity: "song_post",submit: !0,minified: 8}), h = tracklist.build({tracks: a.posts.story,displayed: 16,title: "Discussions",cover: "placeholder",represents: "/stories",type: "box",entity: "story",submit: !0,minified: 3}), i = tracklist.build({tracks: a.posts.playlist,displayed: 8,title: "Playlists",cover: "first_playlist",represents: "/playlists",type: "box",entity: "playlist",submit: a.one,minified: 3,submit: !0}), j = $("<div>").addClass("one-two-col"), k = $("<div>").addClass("one-col one-col-left").appendTo(j), l = $("<diV>").addClass("one-col one-col-right").appendTo(j);
    c && k.append(c), k.append(i), l.append(g), k.append(h), l.append(d), k.append(e), l.append(f);
    var m = $("<div>").addClass("one-page").append(j);
    $('#view[data-route="/home"]').append(m), $.publish("speaker-icon-entered-dom"), views.loadingindicator.hide()
}}, function() {
    this.ImageAnalyzer = function(a, b) {
        var c, d, e, f, g, h, i, j, k, l, m;
        return c = l = m = d = null, g = function(a, b) {
            var g;
            return g = new Image, g.src = a, g.onload = function() {
                var a, h;
                return h = document.createElement("canvas"), h.width = g.width, h.height = g.height, a = h.getContext("2d"), a.drawImage(g, 0, 0), c = e(h, a), $(".canvas-placeholder").html(h), f(h, a, function() {
                    return b(c, l, m, d)
                })
            }
        }, g(a, b), e = function(a, b) {
            var c, d, e, f, g, i, j, k, l, m, n, o, p, q, r, s;
            for (j = b.getImageData(0, 0, 1, a.height), e = {}, l = p = 0, s = a.height; s >= 0 ? s > p : p > s; l = s >= 0 ? ++p : --p)
                n = j.data[4 * l], g = j.data[4 * l + 1], c = j.data[4 * l + 2], i = n + "," + g + "," + c, e[i] || (e[i] = 0), e[i]++;
            o = [];
            for (d in e)
                f = e[d], f > 2 && o.push([d, f]);
            if (o.sort(function(a, b) {
                    return b[1] - a[1]
                }), m = o[0], h(m[0]))
                for (q = 0, r = o.length; r > q; q++)
                    if (k = o[q], k[1] / m[1] > .3 && !h(k[0])) {
                        m = k;
                        break
                    }
            return m[0]
        }, f = function(a, b, e) {
            var f, g, h, n, o, p, q, r, s, t, u, v, w, x, y, z, A, B, C, D;
            for (n = b.getImageData(0, 0, a.width, a.height), s = !j(c), h = {}, x = y = 0, C = a.height; C >= 0 ? C > y : y > C; x = C >= 0 ? ++y : --y)
                for (o = z = 0, D = a.width; D >= 0 ? D > z : z > D; o = D >= 0 ? ++z : --z)
                    w = n.data[4 * x * a.width + 4 * o], t = n.data[4 * x * a.width + 4 * o + 1], f = n.data[4 * x * a.width + 4 * o + 2], u = w + "," + t + "," + f, h[u] || (h[u] = 0), h[u]++;
            v = [];
            for (g in h)
                p = h[g], q = j(g), q === s && v.push([g, p]);
            for (v.sort(function(a, b) {
                return b[1] - a[1]
            }), A = 0, B = v.length; B > A; A++)
                if (g = v[A], l)
                    if (m) {
                        if (!d) {
                            if (!k(m, g[0]) || !k(l, g[0]) || !i(g[0], c))
                                continue;
                            d = g[0];
                            break
                        }
                    } else {
                        if (!k(l, g[0]) || !i(g[0], c))
                            continue;
                        m = g[0]
                    }
                else
                    i(g[0], c) && (l = g[0]);
            return r = s ? "0,0,0" : "255,255,255", l || (l = r), m || (m = r), d || (d = r), e()
        }, h = function(a) {
            var b, c, d, e, f, g;
            return e = a.split(","), d = e[0], c = e[1], b = e[2], g = 232.05, f = 22.95, d > g && c > g && b > g ? !0 : f > d && f > c && f > b ? !0 : !1
        }, j = function(a) {
            var b, c, d, e, f;
            return a ? (f = a.split(","), e = f[0] / 255, c = f[1] / 255, b = f[2] / 255, d = .2126 * e + .7152 * c + .0722 * b, .5 > d) : !1
        }, i = function(a, b) {
            var c, d, e, f, g, h, i, j, k, l, m;
            return l = a.split(","), j = l[0] / 255, f = l[1] / 255, c = l[2] / 255, h = .2126 * j + .7152 * f + .0722 * c, m = b.split(","), k = m[0] / 255, g = m[1] / 255, d = m[2] / 255, i = .2126 * k + .7152 * g + .0722 * d, e = h > i ? (h + .05) / (i + .05) : (i + .05) / (h + .05), e > 1.6
        }, k = function(a, b) {
            var c, d, e, f, g, h, i, j, k;
            return i = a.split(","), g = i[0] / 255, e = i[1] / 255, c = i[2] / 255, j = b.split(","), h = j[0] / 255, f = j[1] / 255, d = j[2] / 255, k = .25, Math.abs(g - h) > k || Math.abs(e - f) > k || Math.abs(c - d) > k ? Math.abs(g - e) < .03 && Math.abs(g - c) < .03 && Math.abs(h - f) < .03 && Math.abs(h - d) < .03 ? !1 : !0 : !1
        }
    }
}.call(this), colors = {getForUrl: function(a, b) {
    ImageAnalyzer(a, function(a, c, d, e) {
        var f = _.reduce(d.split(","), function(a, b) {
            return a + parseInt(b)
        }, 0), g = f > 383;
        b(a, c, d, e, g)
    })
},getMostCommon: function(a) {
    var b = _.max(_.groupBy($("#view").find(".song"), function(a) {
        return $(a).attr("data-artist")
    }), function(a) {
        return a.length
    });
    if (b && 0 != b.length) {
        var c = $(b[0]).attr("data-image"), d = $(b[0]).attr("data-artist");
        colors.getForUrl(colors.createProxyUrl(helpers.getHQAlbumImage({image: c}, 400)), function(b, e, f, g, h) {
            colors.save(b, e, f, g, h, c, d, a), colors.setColors(b, e, f, g, h)
        }), $(".feature-placeholder").text(d)
    }
},save: function(a, b, c, d, e, f, g, h) {
    var i = {bgColor: a,primaryColor: b,secondaryColor: c,detailColor: d,dark: e,url: f,artist: g,playlist: h};
    $.ajax({url: "/api/playlists/style",data: i,type: "POST",dataType: "json"}), oneTune.playlists(_.map(oneTune.playlists(), function(a) {
        return a.url == h && (a.style = i), a
    }))
},createProxyUrl: function(a) {
    return "/api/cover?url=" + a
},setColors: function(a, b, c, d, e) {
    $(".playlist-header-v3").css("background", "rgb(" + a + ")"), $(".playlist-header-v3 h1").css("color", "rgb(" + b + ")"), $(".playlist-header-v3 h2").css("color", "rgb(" + c + ")"), $(".playlist-header-v3 .feature-placeholder").css("color", "rgb(" + c + ")"), $(".playlist-header-v3 .pl-v3-details p").css("color", "rgb(" + d + ")"), $(".playlist-header-v3 .v3-icon-bg").css("background", "rgb(" + c + ")"), $(".playlist-header-v3 .v3-icon-big.v3-color-matching")[e ? "removeClass" : "addClass"]("white")
}}, ko.bindingHandlers.song = {update: function(a, b) {
    ko.utils.unwrapObservable(b()) || {};
    _.each(b(), function(b, c) {
        $(a).attr("data-" + c, b)
    })
}}, ko.components.register("v2-song-box", {viewModel: function(a) {
    this.song = a.song, this.isInLibrary = function(a) {
        return _.contains(oneTune.library(), a) ? "in-library" : "not-in-library"
    }.bind(this), this.isNowPlaying = function(a) {
        return oneTune.nowPlaying() && oneTune.nowPlaying().id == a
    }.bind(this), this.isHearable = function(a) {
        return this.isNowPlaying(a) && oneTune.hearable()
    }.bind(this), this.handleClick = function(a, b) {
        this.isNowPlaying(a.song.id) ? this.isHearable(a.song.id) ? player.pause() : player.play() : playbutton($(b.target).parents(".song")[0])
    }, this.song.formattedTitle = helpers.parsetextstrict(this.song.name), this.formatImage = function(a) {
        return helpers.getHQAlbumImage({image: a}, 200)
    }
},template: $("#template-v2-song-box").html()}), ko.applyBindings(), oneTune = new OneTune;
